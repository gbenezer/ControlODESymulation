<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Gil Benezer">
<meta name="dcterms.date" content="2026-01-16">

<title>Anatomy of a Symbolic System – ControlDESymulation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-29a10792ab86ea717da89af8b9dc16a0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="assets/css/styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ControlDESymulation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/getting_started/installation.html"> 
<span class="menu-text">Installation Guide</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-architecture" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Architecture</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-architecture">    
        <li>
    <a class="dropdown-item" href="../../architecture/index.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../architecture/cdesym_Design_Philosophy.html">
 <span class="dropdown-text">ControlDESymulation: Design Philosophy and Architecture</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../architecture/UI_Framework_Architecture.html">
 <span class="dropdown-text">UI Framework Architecture</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../architecture/Type_System_Architecture.html">
 <span class="dropdown-text">Type System Architecture</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../architecture/Integration_Framework_Architecture.html">
 <span class="dropdown-text">Integration Framework Architecture</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../architecture/Control_Framework_Architecture.html">
 <span class="dropdown-text">Control Framework Architecture</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../architecture/Visualization_Framework_Architecture.html">
 <span class="dropdown-text">Visualization Framework Architecture</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../architecture/Delegation_Layer_Architecture.html">
 <span class="dropdown-text">Delegation Layer Architecture</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../../tutorials/index.html">
 <span class="dropdown-text">Index</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../tutorials/core_concepts_continuous/batch_reactor_system_definition.html">
 <span class="dropdown-text">Anatomy of a Symbolic System</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../tutorials/core_concepts_continuous/batch_reactor_simulation.html">
 <span class="dropdown-text">Simulating Stochastic Systems</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../api/index.html"> 
<span class="menu-text">API Reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gilbenezer/ControlDESymulation"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../tutorials/core_concepts_continuous/batch_reactor_system_definition.html">Workflow Tutorial Series with Chemical Reactors</a></li><li class="breadcrumb-item"><a href="../../tutorials/core_concepts_continuous/batch_reactor_system_definition.html">Anatomy of a Symbolic System</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Small Demonstration of Basic Functionality</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/getting_started/basic_usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Usage</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Workflow Tutorial Series with Chemical Reactors</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/core_concepts_continuous/batch_reactor_system_definition.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Anatomy of a Symbolic System</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/core_concepts_continuous/batch_reactor_simulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulating Stochastic Systems</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#system-overview" id="toc-system-overview" class="nav-link active" data-scroll-target="#system-overview">System Overview</a></li>
  <li><a href="#noise-structure" id="toc-noise-structure" class="nav-link" data-scroll-target="#noise-structure">Noise Structure</a></li>
  <li><a href="#what-this-tutorial-covers" id="toc-what-this-tutorial-covers" class="nav-link" data-scroll-target="#what-this-tutorial-covers">What This Tutorial Covers</a></li>
  <li><a href="#system-definition" id="toc-system-definition" class="nav-link" data-scroll-target="#system-definition">System Definition</a></li>
  <li><a href="#required-vs-optional-system-definition-elements" id="toc-required-vs-optional-system-definition-elements" class="nav-link" data-scroll-target="#required-vs-optional-system-definition-elements">Required vs Optional System Definition Elements</a>
  <ul>
  <li><a href="#understanding-system-order-in-detail" id="toc-understanding-system-order-in-detail" class="nav-link" data-scroll-target="#understanding-system-order-in-detail">Understanding System Order in Detail</a></li>
  </ul></li>
  <li><a href="#equilibrium-setup-example" id="toc-equilibrium-setup-example" class="nav-link" data-scroll-target="#equilibrium-setup-example">Equilibrium Setup Example</a></li>
  <li><a href="#simulation-and-visualization" id="toc-simulation-and-visualization" class="nav-link" data-scroll-target="#simulation-and-visualization">Simulation and Visualization</a>
  <ul>
  <li><a href="#inspecting-the-system" id="toc-inspecting-the-system" class="nav-link" data-scroll-target="#inspecting-the-system">Inspecting the System</a></li>
  <li><a href="#equilibrium-points" id="toc-equilibrium-points" class="nav-link" data-scroll-target="#equilibrium-points">Equilibrium Points</a></li>
  </ul></li>
  <li><a href="#summary-building-your-system" id="toc-summary-building-your-system" class="nav-link" data-scroll-target="#summary-building-your-system">Summary: Building Your System</a></li>
  <li><a href="#what-youve-learned" id="toc-what-youve-learned" class="nav-link" data-scroll-target="#what-youve-learned">What You’ve Learned</a>
  <ul>
  <li><a href="#system-definition-1" id="toc-system-definition-1" class="nav-link" data-scroll-target="#system-definition-1">System Definition</a></li>
  <li><a href="#system-introspection" id="toc-system-introspection" class="nav-link" data-scroll-target="#system-introspection">System Introspection</a></li>
  <li><a href="#critical-distinctions" id="toc-critical-distinctions" class="nav-link" data-scroll-target="#critical-distinctions">Critical Distinctions</a></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/gilbenezer/ControlDESymulation/edit/main/tutorials/core_concepts_continuous/batch_reactor_system_definition.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/gilbenezer/ControlDESymulation/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../tutorials/core_concepts_continuous/batch_reactor_system_definition.html">Workflow Tutorial Series with Chemical Reactors</a></li><li class="breadcrumb-item"><a href="../../tutorials/core_concepts_continuous/batch_reactor_system_definition.html">Anatomy of a Symbolic System</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Anatomy of a Symbolic System</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Stochastic Batch Reactors</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Gil Benezer </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 16, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This tutorial introduces the anatomy of a symbolic control system using a <strong>stochastic batch reactor</strong> as a worked example. A batch reactor is a closed chemical system where reactants <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> undergo sequential reactions governed by Arrhenius kinetics, with temperature controlled via external heating <span class="math inline">\(Q\)</span>.</p>
<section id="system-overview" class="level2">
<h2 class="anchored" data-anchor-id="system-overview">System Overview</h2>
<p>The system demonstrates key <code>cdesym</code> concepts:</p>
<ul>
<li><strong>State variables</strong>: Concentrations <span class="math inline">\((C_A, C_B)\)</span> and temperature <span class="math inline">\((T)\)</span></li>
<li><strong>Control input</strong>: Heat input <span class="math inline">\((Q)\)</span></li>
<li><strong>Drift dynamics</strong>: Deterministic reaction rates and heat transfer</li>
<li><strong>Diffusion dynamics</strong>: Additive noise on each state, representing measurement or process uncertainty</li>
</ul>
<p>The reaction sequence <span class="math inline">\(A \to B \to C\)</span> follows first-order Arrhenius kinetics:</p>
<p><span class="math display">\[
\begin{aligned}
r_1 &amp;= k_1 \cdot C_A \cdot \exp(\frac{-E_1}{T}) \\
r_2 &amp;= k_2 \cdot C_B \cdot \exp(\frac{-E_2}{T})
\end{aligned}
\]</span></p>
<p>The deterministic dynamics are:</p>
<p><span class="math display">\[
\begin{aligned}
\frac{dC_A}{dt} &amp;= -r_1 \\
\frac{dC_B}{dt} &amp;= r_1 - r_2 \\
\frac{dT}{dt} &amp;= Q - \alpha(T - T_{\text{amb}})
\end{aligned}
\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Itô vs Stratonovich SDEs
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The stochastic formulation in this example uses an <strong>Itô SDE</strong> of the form:</p>
<p><span class="math display">\[dX_t = f(X_t, u_t)\,dt + g(X_t)\,dW_t\]</span></p>
<p>where <span class="math inline">\(W_t\)</span> is a Wiener process (Brownian motion). The key distinction from <strong>Stratonovich SDEs</strong> lies in how the stochastic integral is defined:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 17%">
<col style="width: 48%">
</colgroup>
<thead>
<tr class="header">
<th>Property</th>
<th>Itô</th>
<th>Stratonovich</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Evaluation point</strong></td>
<td>Left endpoint of interval</td>
<td>Midpoint of interval</td>
</tr>
<tr class="even">
<td><strong>Martingale property</strong></td>
<td>Yes (integral is a martingale)</td>
<td>No</td>
</tr>
<tr class="odd">
<td><strong>Chain rule</strong></td>
<td>Requires <strong>Itô’s lemma</strong> with correction term</td>
<td>Standard chain rule applies</td>
</tr>
<tr class="even">
<td><strong>Typical use</strong></td>
<td>Finance, control theory, probability</td>
<td>Physics, systems with colored noise limits</td>
</tr>
</tbody>
</table>
<p><strong>Itô’s lemma</strong> for a function <span class="math inline">\(Y_t = h(X_t)\)</span> includes an extra term:</p>
<p><span class="math display">\[dY_t = h'(X_t)\,dX_t + \frac{1}{2}h''(X_t)\,g(X_t)^2\,dt\]</span></p>
<p>The second term (absent in ordinary calculus) arises because Brownian paths have infinite quadratic variation.</p>
<p><strong>When the distinction matters</strong>: For <strong>state-dependent (multiplicative) noise</strong> like <span class="math inline">\(g(X_t) = \sigma X_t\)</span>, the two interpretations give different results. For <strong>additive noise</strong> where <span class="math inline">\(g\)</span> is constant, they coincide. This tutorial uses additive noise, so the choice is moot here—but understanding the difference is essential when modeling state-dependent noise.</p>
</div>
</div>
</div>
</section>
<section id="noise-structure" class="level2">
<h2 class="anchored" data-anchor-id="noise-structure">Noise Structure</h2>
<p>The stochastic batch reactor extends the deterministic model with additive process noise:</p>
<p><span class="math display">\[
\begin{aligned}
dC_A &amp;= (-r_1)\,dt + \sigma_A\,dW_A \\
dC_B &amp;= (r_1 - r_2)\,dt + \sigma_B\,dW_B \\
dT &amp;= (Q - \alpha(T - T_{\text{amb}}))\,dt + \sigma_T\,dW_T
\end{aligned}
\]</span></p>
<p>Three independent Wiener processes model distinct physical noise sources: feed variability (<span class="math inline">\(\sigma_A\)</span>, <span class="math inline">\(\sigma_B\)</span>) and heat transfer fluctuations (<span class="math inline">\(\sigma_T\)</span>). Trajectories fluctuate around the deterministic equilibrium with standard deviation growing as <span class="math inline">\(\sqrt{t}\)</span>.</p>
</section>
<section id="what-this-tutorial-covers" class="level2">
<h2 class="anchored" data-anchor-id="what-this-tutorial-covers">What This Tutorial Covers</h2>
<p>We define two equilibria:</p>
<ol type="1">
<li><strong>Complete conversion</strong> (stable): All reactants consumed, temperature at ambient</li>
<li><strong>Initial setpoint</strong> (unstable): Starting conditions for batch operation</li>
</ol>
<p>The tutorial walks through defining <code>_f_sym</code> (drift), <code>diffusion_expr</code> (noise structure), how to define optional <code>_h_sym</code> (output map) and output variables if needed, then covers equilibrium setup and trajectory visualization.</p>
</section>
<section id="system-definition" class="level2">
<h2 class="anchored" data-anchor-id="system-definition">System Definition</h2>
<p>The full system definition is as follows:</p>
<div id="4d56535c" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sympy <span class="im">as</span> sp</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cdesym <span class="im">import</span> ContinuousStochasticSystem</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ContinuousStochasticBatchReactor(ContinuousStochasticSystem):</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> define_system(</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        k1_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        k2_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        E1_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1000.0</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        E2_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1500.0</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        alpha_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        T_amb_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">300.0</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        sigma_A: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        sigma_B: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        sigma_T: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        C_A0: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        T0: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store initial conditions and parameter values for later use</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (See "What to Store as Attributes" callout below for detailed guidelines)</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.C_A0 <span class="op">=</span> C_A0</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T0 <span class="op">=</span> T0</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha_val <span class="op">=</span> alpha_val</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T_amb_val <span class="op">=</span> T_amb_val</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># State and control variables (local - not stored as attributes)</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        C_A, C_B, T <span class="op">=</span> sp.symbols(<span class="st">"C_A C_B T"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        Q <span class="op">=</span> sp.symbols(<span class="st">"Q"</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Deterministic Parameters (kinetics and heat transfer)</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># These are local variables - used as keys in self.parameters dict</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        k1, k2, E1, E2, alpha, T_amb <span class="op">=</span> sp.symbols(</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"k1 k2 E1 E2 alpha T_amb"</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            real<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>            positive<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stochastic Parameters (noise intensities)</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        sigma_A_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_A"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        sigma_B_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_B"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        sigma_T_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_T"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parameters dictionary: Symbol → Value mapping</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Keys are the symbol objects created above</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">=</span> {</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>            k1: k1_val,</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>            k2: k2_val,</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>            E1: E1_val,</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>            E2: E2_val,</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>            alpha: alpha_val,</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>            T_amb: T_amb_val,</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>            sigma_A_sym: sigma_A,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>            sigma_B_sym: sigma_B,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>            sigma_T_sym: sigma_T,</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state_vars <span class="op">=</span> [C_A, C_B, T]</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.control_vars <span class="op">=</span> [Q]</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_vars <span class="op">=</span> []</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.order <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reaction rates (Arrhenius kinetics)</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>        r1 <span class="op">=</span> k1 <span class="op">*</span> C_A <span class="op">*</span> sp.exp(<span class="op">-</span>E1 <span class="op">/</span> T)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> k2 <span class="op">*</span> C_B <span class="op">*</span> sp.exp(<span class="op">-</span>E2 <span class="op">/</span> T)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># DRIFT (Deterministic part - same as deterministic reactor)</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>        dC_A_dt <span class="op">=</span> <span class="op">-</span>r1</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        dC_B_dt <span class="op">=</span> r1 <span class="op">-</span> r2</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        dT_dt <span class="op">=</span> Q <span class="op">-</span> alpha <span class="op">*</span> (T <span class="op">-</span> T_amb)</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([dC_A_dt, dC_B_dt, dT_dt])</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># DIFFUSION (Stochastic part - additive noise)</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Diagonal matrix: three independent Wiener processes</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix(</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                [sigma_A_sym, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>                [<span class="dv">0</span>, sigma_B_sym, <span class="dv">0</span>],</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>                [<span class="dv">0</span>, <span class="dv">0</span>, sigma_T_sym],</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Itô SDE interpretation</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sde_type <span class="op">=</span> <span class="st">"ito"</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Output: Full state measurement (with potential noise in practice)</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># technically optional</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._h_sym <span class="op">=</span> sp.Matrix([C_A, C_B, T])</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use stored parameter values directly</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Don't try to look up via sp.symbols() - that creates NEW symbol objects!)</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>        T_amb <span class="op">=</span> <span class="va">self</span>.T_amb_val</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Complete conversion equilibrium (deterministic part)</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_equilibrium(</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>            <span class="st">"complete"</span>,</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>            x_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>, T_amb]),</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>            u_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>]),</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>            verify<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>            stability<span class="op">=</span><span class="st">"stable"</span>,</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>            notes<span class="op">=</span><span class="st">"Equilibrium of deterministic part (drift). Stochastic trajectories "</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fluctuate around this point with variance growing over time."</span>,</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initial condition (if provided)</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.C_A0 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="va">self</span>.T0 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="va">self</span>.alpha_val</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>            Q_init <span class="op">=</span> alpha <span class="op">*</span> (<span class="va">self</span>.T0 <span class="op">-</span> T_amb)</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.add_equilibrium(</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>                <span class="st">"initial"</span>,</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>                x_eq<span class="op">=</span>np.array([<span class="va">self</span>.C_A0, <span class="fl">0.0</span>, <span class="va">self</span>.T0]),</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>                u_eq<span class="op">=</span>np.array([Q_init]),</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>                verify<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>                stability<span class="op">=</span><span class="st">"unstable"</span>,</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>                notes<span class="op">=</span><span class="st">"Initial state setpoint (deterministic part). Stochastic trajectories "</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>                <span class="st">"will fluctuate with std ~ [σ_A·√t, σ_B·√t, σ_T·√t]."</span>,</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.set_default_equilibrium(<span class="st">"initial"</span>)</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.set_default_equilibrium(<span class="st">"complete"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The first step in system construction is to subclass the proper symbolic system and create the define_system method signature.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ContinuousStochasticBatchReactor(ContinuousStochasticSystem):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> define_system(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        k1_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        k2_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        E1_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1000.0</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        E2_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1500.0</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        alpha_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        T_amb_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">300.0</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        sigma_A: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        sigma_B: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        sigma_T: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        C_A0: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        T0: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    ):</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>More often than not, the only arguments to this function will be the <code>self</code> argument and parameter values. It is not necessary to add type hints or default values, but it is recommended for debug purposes.</p>
<p>The next step in system definition is to define the (deterministic) symbolic variables to be used and place them in the proper fields. The main limitation currently is that it is not possible to explicitly define a symbolic variable for time. If it is heavily requested, we can implement it as a future feature.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># State and control variables</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>C_A, C_B, T <span class="op">=</span> sp.symbols(<span class="st">"C_A C_B T"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> sp.symbols(<span class="st">"Q"</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Deterministic Parameters (kinetics and heat transfer)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>k1, k2, E1, E2, alpha, T_amb <span class="op">=</span> sp.symbols(</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k1 k2 E1 E2 alpha T_amb"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    real<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    positive<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Stochastic Parameters (noise intensities)</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>sigma_A_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_A"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>sigma_B_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_B"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>sigma_T_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_T"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    k1: k1_val,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    k2: k2_val,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    E1: E1_val,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    E2: E2_val,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    alpha: alpha_val,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    T_amb: T_amb_val,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    sigma_A_sym: sigma_A,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    sigma_B_sym: sigma_B,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    sigma_T_sym: sigma_T,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [C_A, C_B, T]</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> [Q]</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.output_vars <span class="op">=</span> []</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The necessary symbolic variables include:</p>
<ul>
<li>State variables</li>
<li>Control variables</li>
<li>Parameter variables</li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>What to Store as Attributes vs Local Variables
</div>
</div>
<div class="callout-body-container callout-body">
<p>A common source of confusion: <strong>when should you store something as <code>self.something</code> vs keep it as a local variable?</strong></p>
<section id="sympy-symbols-usually-local-sometimes-stored" class="level3">
<h3 class="anchored" data-anchor-id="sympy-symbols-usually-local-sometimes-stored">SymPy Symbols: Usually Local, Sometimes Stored</h3>
<p><strong>State and control symbols → Keep LOCAL (don’t store as attributes):</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CORRECT: Local variables only</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>C_A, C_B, T <span class="op">=</span> sp.symbols(<span class="st">"C_A C_B T"</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> sp.symbols(<span class="st">"Q"</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Don't store these as attributes</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># self.C_A_sym = sp.symbols("C_A")  # Unnecessary!</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Why keep local?</strong> These symbols are only used to build <code>self._f_sym</code> and <code>self._h_sym</code>. Once those are built, the framework tracks symbols via <code>self.state_vars</code> and <code>self.control_vars</code> lists. Storing individual symbols is redundant.</p>
<p><strong>Parameter symbols → Keep LOCAL (unless using Solution 2 for equilibria):</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution 1 (tutorial approach): Local symbols</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>T_amb <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {T_amb: T_amb_val}  <span class="co"># Symbol used as key only</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution 2 (production code): Store symbol references</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.T_amb_sym <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {<span class="va">self</span>.T_amb_sym: T_amb_val}  <span class="co"># Can look up later</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="parameter-values-store-when-needed-later" class="level3">
<h3 class="anchored" data-anchor-id="parameter-values-store-when-needed-later">Parameter Values: Store When Needed Later</h3>
<p><strong>Store parameter values if used in <code>setup_equilibria()</code> or custom methods:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, T_amb_val<span class="op">=</span><span class="fl">300.0</span>, alpha_val<span class="op">=</span><span class="fl">0.1</span>, ...):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store values needed in setup_equilibria</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T_amb_val <span class="op">=</span> T_amb_val</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.alpha_val <span class="op">=</span> alpha_val</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create symbols and populate parameters dict</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {T_amb: T_amb_val, ...}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Don’t store if only used in symbolic expressions:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, k1_val<span class="op">=</span><span class="fl">0.5</span>, k2_val<span class="op">=</span><span class="fl">0.3</span>, ...):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These are only used in _f_sym, not in setup_equilibria</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># No need to store as attributes</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    k1 <span class="op">=</span> sp.symbols(<span class="st">'k1'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    k2 <span class="op">=</span> sp.symbols(<span class="st">'k2'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {k1: k1_val, k2: k2_val}</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([k1 <span class="op">*</span> C_A <span class="op">*</span> sp.exp(<span class="op">-</span>E1<span class="op">/</span>T)])  <span class="co"># Used here only</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="custom-fields-always-store" class="level3">
<h3 class="anchored" data-anchor-id="custom-fields-always-store">Custom Fields: Always Store</h3>
<p><strong>Store data needed for conditional logic or custom methods:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, C_A0<span class="op">=</span><span class="va">None</span>, T0<span class="op">=</span><span class="va">None</span>, ...):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store for use in setup_equilibria</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.C_A0 <span class="op">=</span> C_A0</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T0 <span class="op">=</span> T0</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store custom application data</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.reaction_pathway <span class="op">=</span> <span class="st">"A-&gt;B-&gt;C"</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.reactor_volume <span class="op">=</span> <span class="fl">10.0</span>  <span class="co"># liters</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="decision-tree" class="level3">
<h3 class="anchored" data-anchor-id="decision-tree">Decision Tree</h3>
<p><strong>Should I store <code>foo</code> as <code>self.foo</code>?</strong></p>
<ol type="1">
<li><strong>Is it a SymPy symbol?</strong>
<ul>
<li>State/control symbol? → <strong>No</strong> (use <code>self.state_vars</code> / <code>self.control_vars</code> lists)</li>
<li>Parameter symbol? → <strong>No</strong> (unless using Solution 2 for parameter lookup)</li>
</ul></li>
<li><strong>Is it a parameter value?</strong>
<ul>
<li>Used in <code>setup_equilibria()</code>? → <strong>Yes</strong> (<code>self.param_val</code>)</li>
<li>Only used in <code>_f_sym</code>? → <strong>No</strong> (just put in <code>self.parameters</code> dict)</li>
</ul></li>
<li><strong>Is it a custom field?</strong>
<ul>
<li>Used in logic or custom methods? → <strong>Yes</strong> (<code>self.C_A0</code>, <code>self.reactor_volume</code>)</li>
<li>Temporary calculation? → <strong>No</strong> (keep as local variable)</li>
</ul></li>
</ol>
<p><strong>Rule of thumb:</strong> If you’ll need it in <code>setup_equilibria()</code> or a custom method, store it as <code>self.something</code>. Otherwise, keep it local.</p>
</section>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Output Variables and the Output Map
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are two related but distinct concepts for system outputs:</p>
<ul>
<li><p><strong><code>self.output_vars</code></strong>: A list of symbolic variables representing <em>computed outputs</em>—quantities derived from state variables but not states themselves. For example, if your states are position and velocity, an output variable might be kinetic energy. Do <strong>not</strong> add state variables to this list.</p></li>
<li><p><strong><code>self._h_sym</code></strong>: The <em>output map</em> <span class="math inline">\(y = h(x)\)</span>, a symbolic column vector defining what the system actually outputs. This can include:</p>
<ul>
<li>State variables (for full or partial state observation)</li>
<li>Output variables (computed quantities)</li>
<li>Any symbolic expression of states</li>
</ul></li>
</ul>
<p><strong>Defaults</strong>: <code>self.output_vars = []</code> (no computed outputs) and <code>self._h_sym = state vector</code> (full state observability).</p>
<p><strong>Example</strong>: For a system with states <span class="math inline">\([x, v]\)</span> and a computed output <span class="math inline">\(E = \frac{1}{2}mv^2\)</span>:</p>
<ul>
<li><code>self.output_vars = [E]</code></li>
<li><code>self._h_sym = sp.Matrix([x, E])</code> outputs position and energy (but not velocity)</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Autonomous Systems
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>An <strong>autonomous system</strong> has no external control inputs—its dynamics depend only on the current state (and possibly time). Examples include free oscillators, population dynamics, and unforced chemical reactions.</p>
<section id="required-specification" class="level3">
<h3 class="anchored" data-anchor-id="required-specification">Required Specification</h3>
<p>To define an autonomous system, you <strong>must</strong> set <code>self.control_vars = []</code> (an empty list). Do not use <code>None</code> or omit the field—this will cause errors during system initialization.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CORRECT: Autonomous system</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> []</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Will cause errors</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># self.control_vars = ...  (omitting the field)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="dynamics-for-autonomous-systems" class="level3">
<h3 class="anchored" data-anchor-id="dynamics-for-autonomous-systems">Dynamics for Autonomous Systems</h3>
<p>For autonomous systems, <code>self._f_sym</code> should depend only on state variables and parameters, <strong>not control variables</strong>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Damped harmonic oscillator (autonomous)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>x, v <span class="op">=</span> sp.symbols(<span class="st">'x v'</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>k, b, m <span class="op">=</span> sp.symbols(<span class="st">'k b m'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [x, v]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># No control</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {k: <span class="fl">10.0</span>, b: <span class="fl">0.5</span>, m: <span class="fl">1.0</span>}</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Dynamics: dx/dt = v, dv/dt = -(k/m)*x - (b/m)*v</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    v,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span>(k<span class="op">/</span>m)<span class="op">*</span>x <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>v</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="calling-conventions" class="level3">
<h3 class="anchored" data-anchor-id="calling-conventions">Calling Conventions</h3>
<p>When evaluating or integrating autonomous systems:</p>
<ul>
<li>The <code>u</code> parameter in <code>system(x, u)</code> should be <code>None</code> or omitted</li>
<li>Integration accepts <code>u=None</code> or no control specification</li>
<li>The framework automatically handles zero control internally</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluating dynamics</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>dxdt <span class="op">=</span> system(x)              <span class="co"># Recommended</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>dxdt <span class="op">=</span> system(x, u<span class="op">=</span><span class="va">None</span>)      <span class="co"># Also valid</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>dxdt <span class="op">=</span> system(x, np.array([])) <span class="co"># Works but unnecessary</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Integration</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(x0<span class="op">=</span>x_init, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># No need to specify u - it's ignored for autonomous systems</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="converting-between-controlled-and-autonomous" class="level3">
<h3 class="anchored" data-anchor-id="converting-between-controlled-and-autonomous">Converting Between Controlled and Autonomous</h3>
<p>You can model the same physical system in different ways:</p>
<p><strong>Controlled oscillator</strong> (with external force):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [x, v]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> [u]  <span class="co"># External force</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([v, <span class="op">-</span>(k<span class="op">/</span>m)<span class="op">*</span>x <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>v <span class="op">+</span> u<span class="op">/</span>m])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Free oscillator</strong> (autonomous, special case u=0):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [x, v]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># No control</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([v, <span class="op">-</span>(k<span class="op">/</span>m)<span class="op">*</span>x <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>v])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Both are valid modeling choices. Use controlled form when you plan to apply inputs at some point; use autonomous form for analyzing free dynamics or when control is not part of the problem. Systems with control inputs expect at least a function that output constant zero input.</p>
</section>
<section id="time-varying-vs-autonomous" class="level3">
<h3 class="anchored" data-anchor-id="time-varying-vs-autonomous">Time-Varying vs Autonomous</h3>
<p><strong>Important distinction</strong>:</p>
<ul>
<li><strong>Autonomous</strong> = no control inputs (<code>self.control_vars = []</code>)</li>
<li><strong>Time-invariant</strong> = dynamics don’t explicitly depend on time</li>
<li><strong>Time-varying</strong> = dynamics explicitly depend on time</li>
</ul>
<p>A system can be autonomous but time-varying (e.g., <span class="math inline">\(\dot{x} = -\sin(t) \cdot x\)</span>) or controlled but time-invariant (e.g., <span class="math inline">\(\dot{x} = -x + u\)</span>). Most systems in control theory are both controlled and time-invariant.</p>
</section>
<section id="practical-examples" class="level3">
<h3 class="anchored" data-anchor-id="practical-examples">Practical Examples</h3>
<p><strong>Autonomous systems:</strong></p>
<ul>
<li>Lotka-Volterra predator-prey: <span class="math inline">\(\dot{x} = \alpha x - \beta xy\)</span>, <span class="math inline">\(\dot{y} = \delta xy - \gamma y\)</span></li>
<li>Van der Pol oscillator: <span class="math inline">\(\ddot{x} + \mu(x^2-1)\dot{x} + x = 0\)</span></li>
<li>Free batch reactor (no heating): <span class="math inline">\(\dot{C}_A = -k_1 C_A e^{-E_1/T}\)</span>, <span class="math inline">\(\dot{T} = -\alpha(T - T_{amb})\)</span></li>
</ul>
<p><strong>Controlled systems:</strong></p>
<ul>
<li>Inverted pendulum with torque: <span class="math inline">\(\ddot{\theta} = (g/L)\sin\theta + u/(mL^2)\)</span></li>
<li>Batch reactor with heating (this tutorial): <span class="math inline">\(\dot{T} = Q - \alpha(T - T_{amb})\)</span></li>
<li>Linear regulator: <span class="math inline">\(\dot{x} = Ax + Bu\)</span></li>
</ul>
</section>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Parameter Dictionary Keys Must Be Symbolic Variables
</div>
</div>
<div class="callout-body-container callout-body">
<p>A common mistake is to set the dictionary keys for self.parameters as strings, but for proper symbolic substitution and code generation, the keys must be SymPy Symbolic variables.</p>
</div>
</div>
<p>The final required step in system definition is to relate symbolic variables for the definition of the system (and possibly observation) dynamics.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reaction rates (Arrhenius kinetics)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>r1 <span class="op">=</span> k1 <span class="op">*</span> C_A <span class="op">*</span> sp.exp(<span class="op">-</span>E1 <span class="op">/</span> T)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> k2 <span class="op">*</span> C_B <span class="op">*</span> sp.exp(<span class="op">-</span>E2 <span class="op">/</span> T)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># DRIFT (Deterministic part - same as deterministic reactor)</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>dC_A_dt <span class="op">=</span> <span class="op">-</span>r1</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>dC_B_dt <span class="op">=</span> r1 <span class="op">-</span> r2</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>dT_dt <span class="op">=</span> Q <span class="op">-</span> alpha <span class="op">*</span> (T <span class="op">-</span> T_amb)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([dC_A_dt, dC_B_dt, dT_dt])</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"># DIFFUSION (Stochastic part - additive noise)</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagonal matrix: three independent Wiener processes</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix(</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        [sigma_A_sym, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, sigma_B_sym, <span class="dv">0</span>],</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, sigma_T_sym],</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Diffusion Matrix Structure
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The diffusion matrix <span class="math inline">\(G\)</span> has dimensions <span class="math inline">\((n_{\text{states}} \times n_{\text{Wiener}})\)</span>, where each column corresponds to an independent Wiener process and each row to a state variable. The stochastic term in the SDE is <span class="math inline">\(G\,dW_t\)</span> where <span class="math inline">\(dW_t\)</span> is a vector of independent Wiener increments.</p>
<p><strong>Why a matrix, not a vector?</strong> A vector would only allow one noise source affecting all states with fixed relative magnitudes. The matrix form enables:</p>
<ul>
<li><p><strong>Diagonal matrices</strong> (as above): Each state has its own independent noise source. The <span class="math inline">\(i\)</span>-th Wiener process affects only the <span class="math inline">\(i\)</span>-th state.</p></li>
<li><p><strong>Off-diagonal elements</strong>: Represent <em>correlated noise</em>—when a single physical noise source affects multiple states. For example, if temperature fluctuations also induced concentration measurement errors:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    [sigma_A_sym, <span class="dv">0</span>, sigma_AT],  <span class="co"># C_A affected by W_A and W_T</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">0</span>, sigma_B_sym, <span class="dv">0</span>],</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">0</span>, <span class="dv">0</span>, sigma_T_sym],</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong>Non-square matrices</strong>: You can have fewer Wiener processes than states (correlated noise) or more (redundant noise sources for modeling flexibility).</p></li>
</ul>
<p><strong>Dimensions expected</strong>: For <span class="math inline">\(n\)</span> state variables and <span class="math inline">\(m\)</span> independent Wiener processes, <code>diffusion_expr</code> should be an <span class="math inline">\(n \times m\)</span> SymPy Matrix.</p>
</div>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output: Full state measurement (with potential noise in practice)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># technically optional</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._h_sym <span class="op">=</span> sp.Matrix([C_A, C_B, T])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Pure Diffusion Systems
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>A <strong>pure diffusion system</strong> (also called a pure noise process) has no deterministic drift—dynamics are driven entirely by stochastic forcing. Examples include Brownian motion, geometric random walks, and models of measurement noise.</p>
<section id="mathematical-form" class="level3">
<h3 class="anchored" data-anchor-id="mathematical-form">Mathematical Form</h3>
<p>For pure diffusion systems, the SDE has zero drift:</p>
<p><span class="math display">\[dX_t = 0 \cdot dt + G(X_t)\,dW_t = G(X_t)\,dW_t\]</span></p>
<p>This means the state evolution is governed entirely by the diffusion term. The deterministic dynamics <span class="math inline">\(f(x,u) = 0\)</span> vanish.</p>
</section>
<section id="required-specification-1" class="level3">
<h3 class="anchored" data-anchor-id="required-specification-1">Required Specification</h3>
<p>To define a pure diffusion system, you <strong>must</strong> set <code>self._f_sym</code> to a zero vector with the same dimension as the number of state variables. Use SymPy’s <code>zeros()</code> function or explicitly construct the zero matrix:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CORRECT: Pure diffusion system (3 states)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.zeros(<span class="dv">3</span>, <span class="dv">1</span>)  <span class="co"># Recommended approach</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ALSO CORRECT: Explicit zero matrix</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ALSO CORRECT: Using symbols and expressions that equal zero</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([x <span class="op">-</span> x, y <span class="op">-</span> y, z <span class="op">-</span> z])  <span class="co"># Works but unnecessary</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Omitting _f_sym entirely (required field)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># self._f_sym = None  # Will cause errors</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="example-3d-brownian-motion" class="level3">
<h3 class="anchored" data-anchor-id="example-3d-brownian-motion">Example: 3D Brownian Motion</h3>
<p>A particle undergoing pure diffusion in 3D space:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BrownianMotion3D(ContinuousStochasticSystem):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> define_system(<span class="va">self</span>, sigma_x<span class="op">=</span><span class="fl">1.0</span>, sigma_y<span class="op">=</span><span class="fl">1.0</span>, sigma_z<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position coordinates</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        x, y, z <span class="op">=</span> sp.symbols(<span class="st">'x y z'</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Diffusion coefficients</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        sx, sy, sz <span class="op">=</span> sp.symbols(<span class="st">'sigma_x sigma_y sigma_z'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state_vars <span class="op">=</span> [x, y, z]</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># Autonomous (no control)</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">=</span> {sx: sigma_x, sy: sigma_y, sz: sigma_z}</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ZERO DRIFT: No deterministic motion</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._f_sym <span class="op">=</span> sp.zeros(<span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># DIFFUSION: Independent noise in each direction</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>            [sx, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>, sy, <span class="dv">0</span>],</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>, <span class="dv">0</span>, sz]</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sde_type <span class="op">=</span> <span class="st">"ito"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="when-to-use-pure-diffusion" class="level3">
<h3 class="anchored" data-anchor-id="when-to-use-pure-diffusion">When to Use Pure Diffusion</h3>
<p><strong>Use pure diffusion when modeling:</strong></p>
<ul>
<li><strong>Brownian motion</strong>: Pure random walks in continuous time</li>
<li><strong>Measurement noise</strong>: Sensors with zero mean noise and no drift</li>
<li><strong>Diffusion-only processes</strong>: Heat diffusion at steady-state, particle diffusion</li>
<li><strong>Null models</strong>: Testing whether observed dynamics are purely random</li>
<li><strong>Noise characterization</strong>: Estimating noise covariance without modeling dynamics</li>
</ul>
<p><strong>Don’t use pure diffusion when:</strong></p>
<ul>
<li>System has deterministic dynamics (even if noisy)</li>
<li>Modeling physical systems with forces/flows (use drift + diffusion)</li>
<li>Equilibrium points matter (pure diffusion has no equilibria except possibly at boundaries)</li>
</ul>
</section>
<section id="physical-interpretation" class="level3">
<h3 class="anchored" data-anchor-id="physical-interpretation">Physical Interpretation</h3>
<p>For additive noise (constant <span class="math inline">\(G\)</span>): <span class="math display">\[dX_t = G\,dW_t\]</span></p>
<p>The solution is simply <span class="math inline">\(X_t = X_0 + G\,W_t\)</span>, where <span class="math inline">\(W_t\)</span> is Brownian motion. The state performs a random walk around its initial condition with variance growing linearly: <span class="math inline">\(\text{Var}(X_t) = GG^T \cdot t\)</span>.</p>
<p>For multiplicative noise (state-dependent <span class="math inline">\(G(X)\)</span>): <span class="math display">\[dX_t = G(X_t)\,dW_t\]</span></p>
<p>The dynamics are more complex, and the SDE interpretation (Itô vs Stratonovich) becomes critical.</p>
</section>
<section id="integration-considerations" class="level3">
<h3 class="anchored" data-anchor-id="integration-considerations">Integration Considerations</h3>
<p>Pure diffusion systems require:</p>
<ul>
<li><strong>Stochastic integrators</strong>: Methods like Euler-Maruyama, Milstein, or higher-order SDE schemes</li>
<li><strong>Fine time steps</strong>: To resolve the noise structure accurately</li>
<li><strong>Multiple realizations</strong>: Statistical properties emerge from ensemble averaging</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Simulating 3D Brownian motion</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>brownian <span class="op">=</span> BrownianMotion3D(sigma_x<span class="op">=</span><span class="fl">1.0</span>, sigma_y<span class="op">=</span><span class="fl">1.0</span>, sigma_z<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial position at origin</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>x0 <span class="op">=</span> np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>])</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Integrate using Euler-Maruyama</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> brownian.integrate(</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"euler_maruyama"</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    dt<span class="op">=</span><span class="fl">0.01</span>,  <span class="co"># Fine time step for noise resolution</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>   <span class="co"># Reproducible noise</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For statistics, run multiple trajectories</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>trajectories <span class="op">=</span> [</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    brownian.integrate(x0<span class="op">=</span>x0, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>), dt<span class="op">=</span><span class="fl">0.01</span>, seed<span class="op">=</span>i)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="drift-diffusion-vs-pure-diffusion" class="level3">
<h3 class="anchored" data-anchor-id="drift-diffusion-vs-pure-diffusion">Drift + Diffusion vs Pure Diffusion</h3>
<p>Most physical systems have <strong>both</strong> drift and diffusion:</p>
<p><strong>Drift + Diffusion</strong> (this tutorial’s reactor):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deterministic part (drift)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([dC_A_dt, dC_B_dt, dT_dt])</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Stochastic part (diffusion)  </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([[σ_A, <span class="dv">0</span>, <span class="dv">0</span>], ...])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Pure Diffusion</strong> (rare in practice):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># No drift</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.zeros(<span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Only diffusion</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([[σ_A, <span class="dv">0</span>, <span class="dv">0</span>], ...])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The batch reactor in this tutorial has <strong>drift + diffusion</strong> because chemical reactions (drift) occur alongside process noise (diffusion).</p>
</section>
<section id="practical-applications" class="level3">
<h3 class="anchored" data-anchor-id="practical-applications">Practical Applications</h3>
<p><strong>Pure Brownian Motion:</strong></p>
<ul>
<li>Modeling colloidal particle motion in fluids</li>
<li>Financial models with zero expected return</li>
<li>Null hypothesis testing in time series</li>
</ul>
<p><strong>State-Dependent Diffusion:</strong></p>
<ul>
<li>Volatility modeling in finance (stochastic volatility models)</li>
<li>Birth-death processes at steady-state</li>
<li>Fluctuation-dissipation in statistical mechanics</li>
</ul>
<p><strong>General Recommendation</strong>: If you’re unsure whether your system should be pure diffusion, it probably shouldn’t be. Most physical systems have deterministic dynamics (drift) plus noise (diffusion).</p>
</section>
</div>
</div>
</div>
</section>
<section id="required-vs-optional-system-definition-elements" class="level2">
<h2 class="anchored" data-anchor-id="required-vs-optional-system-definition-elements">Required vs Optional System Definition Elements</h2>
<p>Understanding what’s required versus optional helps you define systems efficiently while maintaining clarity. Here’s the complete breakdown:</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Required Elements
</div>
</div>
<div class="callout-body-container callout-body">
<p>Every <code>define_system()</code> method <strong>must</strong> define:</p>
<ol type="1">
<li><p><strong><code>self.state_vars</code></strong>: List of state variable symbols</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [C_A, C_B, T]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong><code>self.control_vars</code></strong>: List of control variable symbols (empty list <code>[]</code> for autonomous systems—see the detailed Autonomous Systems callout)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> [Q]  <span class="co"># or [] for autonomous</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong><code>self.parameters</code></strong>: Dictionary mapping symbolic parameters to numerical values</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {k1: <span class="fl">0.5</span>, k2: <span class="fl">0.3</span>, ...}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong><code>self._f_sym</code></strong>: Symbolic expression for system dynamics (drift for SDEs). For pure diffusion systems with zero drift, see the detailed Pure Diffusion Systems callout.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([dC_A_dt, dC_B_dt, dT_dt])</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># For pure diffusion: self._f_sym = sp.zeros(n_states, 1)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><strong><code>self.diffusion_expr</code></strong> (stochastic systems only): Diffusion matrix for SDE noise structure</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([[sigma_A, <span class="dv">0</span>, <span class="dv">0</span>], ...])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Optional Elements with Sensible Defaults
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>These fields have <strong>automatic defaults</strong> if not specified:</p>
<section id="self.output_vars-default" class="level3">
<h3 class="anchored" data-anchor-id="self.output_vars-default"><code>self.output_vars</code> (default: <code>[]</code>)</h3>
<p>List of computed output symbols (not states). Leave empty if you only observe states.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.output_vars <span class="op">=</span> []  <span class="co"># Default - no computed outputs</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="self._h_sym-default-full-state-vector" class="level3">
<h3 class="anchored" data-anchor-id="self._h_sym-default-full-state-vector"><code>self._h_sym</code> (default: full state vector)</h3>
<p>Output map <span class="math inline">\(y = h(x)\)</span>. If not specified, defaults to observing all states.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Explicitly set (same as default for our reactor):</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._h_sym <span class="op">=</span> sp.Matrix([C_A, C_B, T])</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># If omitted, framework uses: self._h_sym = sp.Matrix(self.state_vars)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="self.order-default-1" class="level3">
<h3 class="anchored" data-anchor-id="self.order-default-1"><code>self.order</code> (default: <code>1</code>)</h3>
<p>System order defines how you represent system dynamics. Nearly all systems use <code>order=1</code> (first-order state-space form). See the detailed explanation below for when higher-order forms are useful.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.order <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Default - first-order state-space form</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="self.sde_type-default-ito" class="level3">
<h3 class="anchored" data-anchor-id="self.sde_type-default-ito"><code>self.sde_type</code> (default: <code>"ito"</code>)</h3>
<p>For stochastic systems, specifies SDE interpretation.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.sde_type <span class="op">=</span> <span class="st">"ito"</span>  <span class="co"># Default</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative: self.sde_type = "stratonovich"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Optional Methods
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="setup_equilibria" class="level3">
<h3 class="anchored" data-anchor-id="setup_equilibria"><code>setup_equilibria()</code></h3>
<p>If defined, automatically called after system initialization to add equilibria. Useful when equilibria depend on system parameters.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, T_amb_val<span class="op">=</span><span class="fl">300.0</span>, ...):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store parameter value for use in setup_equilibria</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T_amb_val <span class="op">=</span> T_amb_val</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {T_amb: T_amb_val, ...}</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... rest of define_system ...</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add parameter-dependent equilibria using stored values</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> <span class="va">self</span>.T_amb_val</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_equilibrium(<span class="st">"complete"</span>, x_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>, T_amb]), ...)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>If not defined, only the origin equilibrium is added by default.</p>
</section>
<section id="custom-methods-and-fields" class="level3">
<h3 class="anchored" data-anchor-id="custom-methods-and-fields">Custom Methods and Fields</h3>
<p>You can add any additional methods or fields that don’t conflict with base class names:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, C_A0<span class="op">=</span><span class="fl">1.0</span>, T0<span class="op">=</span><span class="fl">350.0</span>, volume<span class="op">=</span><span class="fl">10.0</span>, ...):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... standard setup ...</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store values needed in custom methods</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.C_A0 <span class="op">=</span> C_A0  <span class="co"># Initial condition</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T0 <span class="op">=</span> T0      <span class="co"># Initial temperature</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.reactor_volume <span class="op">=</span> volume  <span class="co"># Custom application data</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.reaction_pathway <span class="op">=</span> <span class="st">"A-&gt;B-&gt;C"</span>  <span class="co"># Documentation</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_conversion_rate(<span class="va">self</span>, C_A_current):</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate conversion from initial concentration."""</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="va">self</span>.C_A0 <span class="op">-</span> C_A_current) <span class="op">/</span> <span class="va">self</span>.C_A0</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_reactor_capacity(<span class="va">self</span>):</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate moles of A that can be processed."""</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.C_A0 <span class="op">*</span> <span class="va">self</span>.reactor_volume</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>What NOT to store:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't store state/control symbols as attributes if there are no plans to change parameters post-initialization</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># otherwise, can be used to retrieve and re-define paramters in parameter dictionary</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># self.C_A_sym = sp.symbols('C_A')  # Redundant!</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't store temporary calculations</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># self.r1 = k1 * C_A * sp.exp(-E1/T)  # Use local variable</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't store parameter values not used elsewhere</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># If k1 is only in _f_sym, just put it in self.parameters</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</div>
</div>
</div>
<p>For our batch reactor, we <strong>explicitly set</strong> most optional fields for documentation purposes, but only <code>self.order</code> and <code>self.sde_type</code> are redundant (they match defaults).</p>
<section id="understanding-system-order-in-detail" class="level3">
<h3 class="anchored" data-anchor-id="understanding-system-order-in-detail">Understanding System Order in Detail</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>System Order: First-Order vs Higher-Order Forms
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <code>self.order</code> field specifies how you represent the system dynamics. There are two mathematically equivalent ways to define systems:</p>
<section id="first-order-state-space-form-order1-default" class="level3">
<h3 class="anchored" data-anchor-id="first-order-state-space-form-order1-default">First-Order State-Space Form (order=1, <strong>default</strong>)</h3>
<p>The system is written in first-order form where <code>self._f_sym</code> returns <strong>all</strong> time derivatives.</p>
<p><strong>Example: Second-order pendulum</strong> with states <span class="math inline">\(x = [\theta, \dot{\theta}]\)</span></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [theta, theta_dot]  <span class="co"># Both position and velocity</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    theta_dot,                          <span class="co"># d(theta)/dt</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span>(g<span class="op">/</span>L)<span class="op">*</span>sp.sin(theta) <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>theta_dot <span class="op">+</span> u<span class="op">/</span>m  <span class="co"># d(theta_dot)/dt</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.order <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Returns ALL derivatives [d(theta)/dt, d(theta_dot)/dt]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This is the <strong>standard state-space form</strong> used in control theory. For an <span class="math inline">\(n\)</span>-th order physical system with generalized coordinate <span class="math inline">\(q\)</span>, the state is:</p>
<p><span class="math display">\[x = [q, \dot{q}, \ddot{q}, \ldots, q^{(n-1)}]\]</span></p>
<p>and <code>self._f_sym</code> returns the full derivative vector:</p>
<p><span class="math display">\[\frac{dx}{dt} = [\dot{q}, \ddot{q}, \ldots, q^{(n)}]\]</span></p>
</section>
<section id="higher-order-form-ordern" class="level3">
<h3 class="anchored" data-anchor-id="higher-order-form-ordern">Higher-Order Form (order=n)</h3>
<p>The system is written in higher-order form where <code>self._f_sym</code> returns <strong>only the highest</strong> derivative.</p>
<p><strong>Example: Same pendulum</strong> with <code>order=2</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [theta, theta_dot]  <span class="co"># Still both variables</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span>(g<span class="op">/</span>L)<span class="op">*</span>sp.sin(theta) <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>theta_dot <span class="op">+</span> u<span class="op">/</span>m  <span class="co"># ONLY d²(theta)/dt²</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.order <span class="op">=</span> <span class="dv">2</span>  <span class="co"># Returns ONLY highest derivative d²(theta)/dt²</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The state vector is the same <span class="math inline">\(x = [\theta, \dot{\theta}]\)</span>, but <code>self._f_sym</code> only returns <span class="math inline">\(\ddot{\theta}\)</span>. The framework <strong>automatically constructs</strong> the full first-order representation during linearization by adding the kinematic relationships:</p>
<p><span class="math display">\[\frac{d\theta}{dt} = \dot{\theta}, \quad \frac{d\dot{\theta}}{dt} = \ddot{\theta}\]</span></p>
</section>
<section id="when-to-use-each-form" class="level3">
<h3 class="anchored" data-anchor-id="when-to-use-each-form">When to Use Each Form</h3>
<ul>
<li><p><strong>First-order (order=1)</strong>:</p>
<ul>
<li><strong>Use this for most systems</strong> - it’s explicit and standard</li>
<li>Required when dynamics aren’t naturally hierarchical</li>
<li>Example: Our batch reactor has independent first derivatives for <span class="math inline">\(C_A\)</span>, <span class="math inline">\(C_B\)</span>, and <span class="math inline">\(T\)</span></li>
</ul></li>
<li><p><strong>Higher-order (order=n)</strong>:</p>
<ul>
<li>Natural for mechanical systems (position → velocity → acceleration)</li>
<li>More compact when you have <span class="math inline">\(\ddot{q} = f(q, \dot{q}, u)\)</span> form</li>
<li>Example: Robotics, where you directly compute joint accelerations</li>
</ul></li>
</ul>
</section>
<section id="requirements" class="level3">
<h3 class="anchored" data-anchor-id="requirements">Requirements</h3>
<ul>
<li>For <code>order=n &gt; 1</code>: The number of states must be divisible by <code>n</code> (i.e., <code>nx % n == 0</code>)</li>
<li>State variables should be ordered as <span class="math inline">\([q_1, \ldots, q_m, \dot{q}_1, \ldots, \dot{q}_m, \ldots]\)</span> for proper automatic construction</li>
<li>The framework handles all conversions transparently during linearization</li>
</ul>
</section>
<section id="this-tutorial" class="level3">
<h3 class="anchored" data-anchor-id="this-tutorial">This Tutorial</h3>
<p>Our batch reactor uses <strong>order=1</strong> (default) because the three state variables <span class="math inline">\((C_A, C_B, T)\)</span> have independent first-order dynamics—there’s no natural hierarchy to exploit.</p>
</section>
</div>
</div>
</div>
</section>
</section>
<section id="equilibrium-setup-example" class="level2">
<h2 class="anchored" data-anchor-id="equilibrium-setup-example">Equilibrium Setup Example</h2>
<p>Our reactor’s <code>setup_equilibria()</code> method demonstrates how to define parameter-dependent equilibria:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use stored parameter values directly</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (Don't try to look up via sp.symbols() - that creates NEW symbol objects!)</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> <span class="va">self</span>.T_amb_val</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Complete conversion equilibrium (deterministic part)</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_equilibrium(</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"complete"</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        x_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>, T_amb]),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        u_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>]),</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        verify<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        stability<span class="op">=</span><span class="st">"stable"</span>,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        notes<span class="op">=</span><span class="st">"Equilibrium of deterministic part (drift). Stochastic trajectories "</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fluctuate around this point with variance growing over time."</span>,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initial condition (if provided)</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.C_A0 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="va">self</span>.T0 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="va">self</span>.alpha_val</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>        Q_init <span class="op">=</span> alpha <span class="op">*</span> (<span class="va">self</span>.T0 <span class="op">-</span> T_amb)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_equilibrium(</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"initial"</span>,</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>            x_eq<span class="op">=</span>np.array([<span class="va">self</span>.C_A0, <span class="fl">0.0</span>, <span class="va">self</span>.T0]),</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>            u_eq<span class="op">=</span>np.array([Q_init]),</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>            verify<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>            stability<span class="op">=</span><span class="st">"unstable"</span>,</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>            notes<span class="op">=</span><span class="st">"Initial state setpoint (deterministic part). Stochastic trajectories "</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"will fluctuate with std ~ [σ_A·√t, σ_B·√t, σ_T·√t]."</span>,</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.set_default_equilibrium(<span class="st">"initial"</span>)</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.set_default_equilibrium(<span class="st">"complete"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Accessing Parameters in <code>setup_equilibria()</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Common mistake:</strong> Trying to access parameters via <code>self.parameters[sp.symbols("param_name")]</code></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Creates a NEW symbol, won't match dictionary key</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>T_amb <span class="op">=</span> <span class="va">self</span>.parameters[sp.symbols(<span class="st">"T_amb"</span>)]  <span class="co"># KeyError!</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Why this fails:</strong> Each call to <code>sp.symbols()</code> creates a new Python object with unique identity. The dictionary keys in <code>self.parameters</code> are the <em>original</em> symbol objects from <code>define_system()</code>, not new ones.</p>
<p><strong>Solution 1: Store parameter values as attributes</strong> (Recommended for beginners):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, T_amb_val<span class="op">=</span><span class="fl">300.0</span>, ...):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store the numerical value</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T_amb_val <span class="op">=</span> T_amb_val</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create symbol and use in parameters dict</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {T_amb: T_amb_val, ...}</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the stored value directly</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> <span class="va">self</span>.T_amb_val  <span class="co"># Works!</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Solution 2: Store symbol references</strong> (Recommended for production):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, T_amb_val<span class="op">=</span><span class="fl">300.0</span>, ...):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create symbol and store reference</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T_amb_sym <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {<span class="va">self</span>.T_amb_sym: T_amb_val, ...}</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the stored symbol to look up value</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> <span class="va">self</span>.parameters[<span class="va">self</span>.T_amb_sym]  <span class="co"># Works!</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Our tutorial uses Solution 1 for simplicity and clarity.</p>
</div>
</div>
</section>
<section id="simulation-and-visualization" class="level2">
<h2 class="anchored" data-anchor-id="simulation-and-visualization">Simulation and Visualization</h2>
<p>Now that we’ve defined our stochastic batch reactor, let’s see it in action. This section demonstrates the complete workflow: inspecting the system, running simulations, and visualizing results.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Integration Methods: <code>integrate()</code> vs <code>simulate()</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>ControlDESymulation provides two methods for time evolution:</p>
<section id="integrate---low-level-interface" class="level3">
<h3 class="anchored" data-anchor-id="integrate---low-level-interface"><code>integrate()</code> - Low-Level Interface</h3>
<p><strong>For stochastic systems, always use this method.</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    u<span class="op">=</span>controller,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'euler_maruyama'</span>,  <span class="co"># Stochastic integrator</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    dt<span class="op">=</span><span class="fl">0.01</span>,                  <span class="co"># Required for fixed-step methods</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>,                  <span class="co"># Reproducibility</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    n_paths<span class="op">=</span><span class="dv">100</span>               <span class="co"># Monte Carlo ensemble</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Stochastic-specific features:</strong></p>
<ul>
<li><code>seed</code>: Random number generator seed for reproducible noise</li>
<li><code>n_paths</code>: Built-in Monte Carlo simulation (returns shape <code>(n_paths, T, nx)</code>)</li>
<li>Stochastic methods: <code>'euler_maruyama'</code>, <code>'milstein'</code>, <code>'heun'</code>, etc.</li>
<li><code>dt</code>: Time step (required for most SDE methods)</li>
<li><code>t_eval</code>: Optional array of specific output times</li>
</ul>
<p><strong>Fixed-Step vs Adaptive Methods:</strong></p>
<p>Most SDE integrators are <strong>fixed-step</strong> (Euler-Maruyama, Milstein, Heun, etc.):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'euler_maruyama'</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    dt<span class="op">=</span><span class="fl">0.01</span>  <span class="co"># Required - sets uniform time grid</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># result['t'] has uniform spacing: [0.00, 0.01, 0.02, ..., 10.00]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Some advanced methods are <strong>adaptive</strong> (use <code>rtol</code>/<code>atol</code> instead of <code>dt</code>):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'adaptive_sde'</span>,  <span class="co"># Hypothetical adaptive method</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    rtol<span class="op">=</span><span class="fl">1e-6</span>, atol<span class="op">=</span><span class="fl">1e-8</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># result['t'] may have non-uniform spacing</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Visualization tip:</strong> For uniform time grids (most cases), plotting is straightforward. For adaptive grids, use <code>t_eval</code> to force specific output times:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'adaptive_sde'</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    t_eval<span class="op">=</span>np.linspace(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">1000</span>),  <span class="co"># Force uniform grid</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    rtol<span class="op">=</span><span class="fl">1e-6</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Returns:</strong> <code>SDEIntegrationResult</code> with fields:</p>
<ul>
<li><code>t</code>: Time points <code>(T,)</code> - uniform for fixed-step, may vary for adaptive</li>
<li><code>x</code>: States <code>(T, nx)</code> or <code>(n_paths, T, nx)</code> for Monte Carlo</li>
<li><code>success</code>, <code>nfev</code>, <code>diffusion_evals</code>: Solver diagnostics</li>
</ul>
</section>
<section id="simulate---high-level-interface" class="level3">
<h3 class="anchored" data-anchor-id="simulate---high-level-interface"><code>simulate()</code> - High-Level Interface</h3>
<p><strong>For deterministic systems only</strong> (not recommended for SDEs).</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.simulate(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    controller<span class="op">=</span><span class="kw">lambda</span> x, t: <span class="op">-</span>K <span class="op">@</span> x,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    dt<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Key differences:</strong></p>
<ul>
<li>Always returns regular time grid (uniform spacing <code>dt</code>)</li>
<li>Cleaner API for feedback controllers</li>
<li>No <code>seed</code> or <code>n_paths</code> support</li>
<li>Uses deterministic integrators (RK45, RK4, Euler)</li>
<li>Returns <code>SimulationResult</code> in time-major format <code>(T, nx)</code></li>
</ul>
<p><strong>When to use each:</strong></p>
<ul>
<li><strong>Stochastic systems (SDEs)</strong> → <code>integrate()</code> with stochastic methods</li>
<li><strong>Deterministic systems (ODEs)</strong> → Either method; <code>simulate()</code> is simpler</li>
<li><strong>Monte Carlo simulations</strong> → <code>integrate()</code> with <code>n_paths &gt; 1</code></li>
</ul>
<p>For our stochastic batch reactor, we’ll use <code>integrate()</code> exclusively.</p>
</section>
</div>
</div>
<section id="inspecting-the-system" class="level3">
<h3 class="anchored" data-anchor-id="inspecting-the-system">Inspecting the System</h3>
<p>Before running simulations, let’s examine what we’ve created:</p>
<div id="789bcb81" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display symbolic equations</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>reactor <span class="op">=</span> ContinuousStochasticBatchReactor(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    C_A0<span class="op">=</span><span class="fl">1.0</span>,    <span class="co"># Initial concentration</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    T0<span class="op">=</span><span class="fl">350.0</span>,    <span class="co"># Initial temperature</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    sigma_T<span class="op">=</span><span class="fl">2.0</span>  <span class="co"># Temperature noise intensity</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the mathematical structure</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>reactor.print_equations(simplify<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>======================================================================
ContinuousStochasticBatchReactor (Continuous-Time)
======================================================================
State Variables: [C_A, C_B, T]
Control Variables: [Q]
System Order: 1
Dimensions: nx=3, nu=1, ny=3

Dynamics: dx/dt = f(x, u)
  dC_A/dt = -0.5*C_A*exp(-1000.0/T)
  dC_B/dt = 0.5*C_A*exp(-1000.0/T) - 0.3*C_B*exp(-1500.0/T)
  dT/dt = Q - 0.1*T + 30.0

Output: y = h(x)
  y[0] = C_A
  y[1] = C_B
  y[2] = T
======================================================================</code></pre>
</div>
</div>
<p>This shows:</p>
<ul>
<li>State and control variables</li>
<li>System dimensions (nx=3 states, nu=1 control)</li>
<li>Symbolic drift dynamics with parameters substituted</li>
<li>Output map (if defined)</li>
</ul>
<p>We can also inspect system properties programmatically:</p>
<div id="9854d210" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of states: </span><span class="sc">{</span>reactor<span class="sc">.</span>nx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of controls: </span><span class="sc">{</span>reactor<span class="sc">.</span>nu<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"State variables: </span><span class="sc">{</span>reactor<span class="sc">.</span>state_vars<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Parameters: </span><span class="sc">{</span><span class="bu">list</span>(reactor.parameters.keys())<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Number of states: 3
Number of controls: 1
State variables: [C_A, C_B, T]
Parameters: [k1, k2, E1, E2, alpha, T_amb, sigma_A, sigma_B, sigma_T]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Choosing an Integration Method
</div>
</div>
<div class="callout-body-container callout-body">
<p>For this tutorial, we use <strong>Euler-Maruyama</strong> (<code>method='euler_maruyama'</code>), the simplest fixed-step SDE method. It’s a good starting point because:</p>
<ul>
<li><strong>Fixed time step</strong>: Requires <code>dt</code> parameter, produces uniform time grid</li>
<li><strong>Easy visualization</strong>: Uniform spacing makes plotting straightforward</li>
<li><strong>Stable for additive noise</strong>: Our reactor has additive noise (constant diffusion)</li>
<li><strong>Fast</strong>: Minimal computation per step</li>
</ul>
<p>Other common methods:</p>
<ul>
<li><strong><code>milstein</code></strong>: Higher accuracy for multiplicative noise, still fixed-step</li>
<li><strong><code>heun</code></strong>: Good balance of accuracy and stability, fixed-step</li>
<li><strong>Advanced methods</strong>: May use adaptive stepping (see note below)</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Handling Adaptive SDE Methods
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Some advanced SDE solvers use adaptive time stepping for efficiency. If you use an adaptive method and need uniform output times (e.g., for certain visualizations or statistical analysis), use the <code>t_eval</code> parameter:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adaptive method with non-uniform internal steps</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'adaptive_sde_method'</span>,  <span class="co"># Hypothetical adaptive method</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    rtol<span class="op">=</span><span class="fl">1e-6</span>, atol<span class="op">=</span><span class="fl">1e-8</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    t_eval<span class="op">=</span>np.linspace(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">1000</span>)  <span class="co"># Force uniform output grid</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The solver will use adaptive steps internally for efficiency but interpolate to provide output at the exact times specified in <code>t_eval</code>. This gives you:</p>
<ul>
<li>Efficiency of adaptive stepping during integration</li>
<li>Uniform time grid for downstream analysis and visualization</li>
<li>Control over output density</li>
</ul>
<p><strong>For this tutorial:</strong> We use fixed-step Euler-Maruyama, so <code>dt</code> controls both internal steps and output times. No <code>t_eval</code> needed.</p>
</div>
</div>
</div>
<p>For production code with multiplicative noise, consider higher-order methods. For learning and visualization, Euler-Maruyama with <code>dt=0.01</code> to <code>dt=0.1</code> works well.</p>
</div>
</div>
</section>
<section id="equilibrium-points" class="level3">
<h3 class="anchored" data-anchor-id="equilibrium-points">Equilibrium Points</h3>
<p>Our <code>setup_equilibria()</code> method created two equilibrium points. Let’s see them:</p>
<div id="93b1fd66" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List all equilibria</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>equilibrium_names <span class="op">=</span> reactor.list_equilibria()</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Available equilibria: </span><span class="sc">{</span>equilibrium_names<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the "complete conversion" equilibrium</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>x_eq, u_eq <span class="op">=</span> reactor.get_equilibrium(<span class="st">'complete'</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Complete conversion equilibrium:"</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  C_A = </span><span class="sc">{</span>x_eq[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> mol/L"</span>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  C_B = </span><span class="sc">{</span>x_eq[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss"> mol/L"</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  T = </span><span class="sc">{</span>x_eq[<span class="dv">2</span>]<span class="sc">:.1f}</span><span class="ss"> K"</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Q = </span><span class="sc">{</span>u_eq[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> W"</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify it's actually an equilibrium (drift should be zero)</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>drift <span class="op">=</span> reactor(x_eq, u_eq, t<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Drift at equilibrium: </span><span class="sc">{</span>drift<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Max drift magnitude: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">abs</span>(drift)<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2e}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Available equilibria: ['origin', 'complete', 'initial']

Complete conversion equilibrium:
  C_A = 0.000 mol/L
  C_B = 0.000 mol/L
  T = 300.0 K
  Q = 0.000 W

Drift at equilibrium: [-0.  0.  0.]
Max drift magnitude: 0.00e+00</code></pre>
</div>
</div>
<p><strong>Key insight:</strong> For stochastic systems, equilibria are fixed points of the <strong>drift</strong> only. The diffusion causes trajectories to fluctuate around these points with variance growing as <span class="math inline">\(\sqrt{t}\)</span>.</p>
</section>
</section>
<section id="summary-building-your-system" class="level2">
<h2 class="anchored" data-anchor-id="summary-building-your-system">Summary: Building Your System</h2>
<p>To define a symbolic system in ControlDESymulation:</p>
<p><strong>Minimum viable system:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Define symbolic variables</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> sp.symbols(<span class="st">'x'</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> sp.symbols(<span class="st">'u'</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Set required fields</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.state_vars <span class="op">=</span> [x]</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_vars <span class="op">=</span> [u]  <span class="co"># or [] for autonomous</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {}     <span class="co"># or {param: value}</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([...])  <span class="co"># Your dynamics</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. For stochastic systems, add:</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.diffusion_expr = sp.Matrix([...])</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Autonomous system (no control inputs):</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, damping<span class="op">=</span><span class="fl">0.1</span>, stiffness<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Define symbolic variables (no control symbols needed)</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    x, v <span class="op">=</span> sp.symbols(<span class="st">'x v'</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    b, k <span class="op">=</span> sp.symbols(<span class="st">'b k'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Set required fields</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.state_vars <span class="op">=</span> [x, v]</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># Empty list for autonomous</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {b: damping, k: stiffness}</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Dynamics depending only on states</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        v,                  <span class="co"># dx/dt = v</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>k<span class="op">*</span>x <span class="op">-</span> b<span class="op">*</span>v         <span class="co"># dv/dt = -kx - bv (damped oscillator)</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    ])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Pure diffusion system (stochastic, zero drift):</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, sigma_x<span class="op">=</span><span class="fl">1.0</span>, sigma_y<span class="op">=</span><span class="fl">1.0</span>, sigma_z<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Define symbolic variables</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    x, y, z <span class="op">=</span> sp.symbols(<span class="st">'x y z'</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    sx, sy, sz <span class="op">=</span> sp.symbols(<span class="st">'sigma_x sigma_y sigma_z'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Set required fields</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.state_vars <span class="op">=</span> [x, y, z]</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># Typically autonomous</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {sx: sigma_x, sy: sigma_y, sz: sigma_z}</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. ZERO DRIFT: Pure diffusion has no deterministic dynamics</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.zeros(<span class="dv">3</span>, <span class="dv">1</span>)  <span class="co"># Must be zero vector</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. DIFFUSION: Stochastic dynamics only</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>        [sx, <span class="dv">0</span>, <span class="dv">0</span>],     <span class="co"># Independent noise in x</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, sy, <span class="dv">0</span>],     <span class="co"># Independent noise in y</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, sz]      <span class="co"># Independent noise in z</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.sde_type <span class="op">=</span> <span class="st">"ito"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Well-documented system (recommended):</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, param1<span class="op">=</span><span class="fl">1.0</span>, param2<span class="op">=</span><span class="fl">2.0</span>):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Define all symbolic variables (kept as LOCAL variables)</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    x, y <span class="op">=</span> sp.symbols(<span class="st">'x y'</span>)        <span class="co"># State symbols - local only</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> sp.symbols(<span class="st">'u'</span>)             <span class="co"># Control symbol - local only</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    p1, p2 <span class="op">=</span> sp.symbols(<span class="st">'p1 p2'</span>, positive<span class="op">=</span><span class="va">True</span>)  <span class="co"># Parameter symbols - local only</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Set required fields</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.state_vars <span class="op">=</span> [x, y]        <span class="co"># Reference to local symbols</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_vars <span class="op">=</span> [u]         <span class="co"># Reference to local symbols</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {p1: param1, p2: param2}  <span class="co"># Symbol→value mapping</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([...])</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Explicitly set optional fields for clarity</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.output_vars <span class="op">=</span> []           <span class="co"># No computed outputs</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._h_sym <span class="op">=</span> sp.Matrix([x, y]) <span class="co"># Observe full state</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.order <span class="op">=</span> <span class="dv">1</span>                  <span class="co"># First-order form</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. For stochastic systems:</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.diffusion_expr = sp.Matrix([...])</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.sde_type = "ito"  # or "stratonovich"</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Store parameter VALUES as attributes (if needed in setup_equilibria)</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DON'T store symbols unless parameters need to change post-initialization</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># symbols are already in self.state_vars, self.parameters</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.param1_val = param1  # Store VALUE for later use</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.param2_val = param2  # Store VALUE for later use</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: Add parameter-dependent equilibria</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Access stored values: x_eq_value = self.param1_val</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_equilibrium(<span class="st">"my_equilibrium"</span>, x_eq<span class="op">=</span>..., u_eq<span class="op">=</span>...)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Which template should you use?</strong></p>
<ul>
<li><strong>Minimum viable</strong>: Quick prototyping, testing, simple demos</li>
<li><strong>Autonomous system</strong>: No control inputs (free oscillators, population models, unforced reactions)</li>
<li><strong>Pure diffusion</strong>: Stochastic processes with zero drift (Brownian motion, pure noise)</li>
<li><strong>Well-documented</strong>: Production code, complex systems, collaborative projects (recommended)</li>
</ul>
<p>The reactor example in this tutorial follows the well-documented approach with both drift and diffusion.</p>
</section>
<section id="what-youve-learned" class="level2">
<h2 class="anchored" data-anchor-id="what-youve-learned">What You’ve Learned</h2>
<p>This tutorial covered the <strong>anatomy of a symbolic system</strong> through a stochastic batch reactor example:</p>
<section id="system-definition-1" class="level3">
<h3 class="anchored" data-anchor-id="system-definition-1">System Definition</h3>
<ul>
<li><p>How to subclass <code>ContinuousStochasticSystem</code></p></li>
<li><p>Required fields: <code>state_vars</code>, <code>control_vars</code>, <code>parameters</code>, <code>_f_sym</code>, <code>diffusion_expr</code></p></li>
<li><p>Optional fields: <code>output_vars</code>, <code>_h_sym</code>, <code>order</code>, <code>sde_type</code></p></li>
<li><p>Special cases: Autonomous systems and pure diffusion systems</p></li>
<li><p>Parameter-dependent equilibria via <code>setup_equilibria()</code></p></li>
<li><p><strong>What to store as attributes vs local variables</strong>:</p>
<ul>
<li>Symbols (state, control, parameters) → Keep local</li>
<li>Parameter values (used in <code>setup_equilibria</code>) → Store as <code>self.param_val</code></li>
<li>Initial conditions and custom data → Store as attributes</li>
</ul></li>
</ul>
</section>
<section id="system-introspection" class="level3">
<h3 class="anchored" data-anchor-id="system-introspection">System Introspection</h3>
<ul>
<li><code>print_equations()</code>: Display symbolic dynamics</li>
<li><code>list_equilibria()</code>: See all equilibrium points</li>
<li><code>get_equilibrium()</code>: Access equilibrium states and controls</li>
<li>Programmatic access: <code>nx</code>, <code>nu</code>, <code>state_vars</code>, <code>parameters</code></li>
</ul>
</section>
<section id="critical-distinctions" class="level3">
<h3 class="anchored" data-anchor-id="critical-distinctions">Critical Distinctions</h3>
<ul>
<li><strong>Drift vs Diffusion</strong>: Deterministic dynamics vs stochastic forcing</li>
<li><strong>Itô vs Stratonovich</strong>: Different stochastic calculus interpretations</li>
<li><strong>Equilibria in SDEs</strong>: Fixed points of drift only (stochastic fluctuations persist)</li>
<li><strong>integrate() vs simulate()</strong>: Use <code>integrate()</code> for stochastic systems</li>
<li><strong>Fixed-step vs adaptive</strong>: Most SDE methods use fixed <code>dt</code> (uniform time grid), some advanced methods adapt step size (use <code>t_eval</code> for uniform output)</li>
<li><strong>Parameter access</strong>: Store parameter values as attributes (<code>self.param_val</code>) for use in <code>setup_equilibria()</code>, don’t try to look up via <code>self.parameters[sp.symbols("param")]</code> (creates new symbol, causes KeyError). Store symbol references as attributes only if parameter values need to change post-initialization.</li>
</ul>
</section>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next Steps</h2>
<p><strong><a href="../../tutorials/core_concepts_continuous/batch_reactor_simulation.html">Tutorial 2: Simulation and Visualization</a></strong></p>
<ul>
<li>Single trajectory simulation with <code>integrate()</code></li>
<li>Monte Carlo ensembles with <code>n_paths</code></li>
<li>Time series visualization with <code>reactor.plotter</code></li>
<li>Phase portraits and state-space analysis</li>
<li>Ensemble statistics and confidence bands</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/gilbenezer\.github\.io\/ControlDESymulation");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Anatomy of a Symbolic System"</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Stochastic Batch Reactors"</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Gil Benezer"</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 5</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: true</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: true</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>This tutorial introduces the anatomy of a symbolic control system using a **stochastic batch reactor** as a worked example. A batch reactor is a closed chemical system where reactants $A$ and $B$ undergo sequential reactions governed by Arrhenius kinetics, with temperature controlled via external heating $Q$.</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="fu">## System Overview</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>The system demonstrates key <span class="in">`cdesym`</span> concepts:</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**State variables**: Concentrations $(C_A, C_B)$ and temperature $(T)$</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Control input**: Heat input $(Q)$</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Drift dynamics**: Deterministic reaction rates and heat transfer</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Diffusion dynamics**: Additive noise on each state, representing measurement or process uncertainty</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>The reaction sequence $A \to B \to C$ follows first-order Arrhenius kinetics:</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>r_1 &amp;= k_1 \cdot C_A \cdot \exp(\frac{-E_1}{T}) <span class="sc">\\</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>r_2 &amp;= k_2 \cdot C_B \cdot \exp(\frac{-E_2}{T})</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>The deterministic dynamics are:</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>\frac{dC_A}{dt} &amp;= -r_1 <span class="sc">\\</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>\frac{dC_B}{dt} &amp;= r_1 - r_2 <span class="sc">\\</span></span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>\frac{dT}{dt} &amp;= Q - \alpha(T - T_{\text{amb}})</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a><span class="fu">## Itô vs Stratonovich SDEs</span></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>The stochastic formulation in this example uses an **Itô SDE** of the form:</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>$$dX_t = f(X_t, u_t)\,dt + g(X_t)\,dW_t$$</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>where $W_t$ is a Wiener process (Brownian motion). The key distinction from **Stratonovich SDEs** lies in how the stochastic integral is defined:</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Property <span class="pp">|</span> Itô <span class="pp">|</span> Stratonovich <span class="pp">|</span></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a><span class="pp">|----------|-----|--------------|</span></span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Evaluation point** <span class="pp">|</span> Left endpoint of interval <span class="pp">|</span> Midpoint of interval <span class="pp">|</span></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Martingale property** <span class="pp">|</span> Yes (integral is a martingale) <span class="pp">|</span> No <span class="pp">|</span></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Chain rule** | Requires **Itô's lemma** with correction term <span class="pp">|</span> Standard chain rule applies <span class="pp">|</span></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Typical use** <span class="pp">|</span> Finance, control theory, probability <span class="pp">|</span> Physics, systems with colored noise limits <span class="pp">|</span></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>**Itô's lemma** for a function $Y_t = h(X_t)$ includes an extra term:</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>$$dY_t = h'(X_t)\,dX_t + \frac{1}{2}h''(X_t)\,g(X_t)^2\,dt$$</span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>The second term (absent in ordinary calculus) arises because Brownian paths have infinite quadratic variation.</span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>**When the distinction matters**: For **state-dependent (multiplicative) noise** like $g(X_t) = \sigma X_t$, the two interpretations give different results. For **additive noise** where $g$ is constant, they coincide. This tutorial uses additive noise, so the choice is moot here—but understanding the difference is essential when modeling state-dependent noise.</span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a><span class="fu">## Noise Structure</span></span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>The stochastic batch reactor extends the deterministic model with additive process noise:</span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>dC_A &amp;= (-r_1)\,dt + \sigma_A\,dW_A <span class="sc">\\</span></span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>dC_B &amp;= (r_1 - r_2)\,dt + \sigma_B\,dW_B <span class="sc">\\</span></span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>dT &amp;= (Q - \alpha(T - T_{\text{amb}}))\,dt + \sigma_T\,dW_T</span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>Three independent Wiener processes model distinct physical noise sources: feed variability ($\sigma_A$, $\sigma_B$) and heat transfer fluctuations ($\sigma_T$). Trajectories fluctuate around the deterministic equilibrium with standard deviation growing as $\sqrt{t}$.</span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a><span class="fu">## What This Tutorial Covers</span></span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>We define two equilibria:</span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Complete conversion** (stable): All reactants consumed, temperature at ambient</span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Initial setpoint** (unstable): Starting conditions for batch operation</span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>The tutorial walks through defining <span class="in">`_f_sym`</span> (drift), <span class="in">`diffusion_expr`</span> (noise structure), how to define optional <span class="in">`_h_sym`</span> (output map) and output variables if needed, then covers equilibrium setup and trajectory visualization.</span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## System Definition</span></span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>The full system definition is as follows:</span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sympy <span class="im">as</span> sp</span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cdesym <span class="im">import</span> ContinuousStochasticSystem</span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ContinuousStochasticBatchReactor(ContinuousStochasticSystem):</span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> define_system(</span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>        k1_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a>        k2_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a>        E1_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1000.0</span>,</span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a>        E2_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1500.0</span>,</span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a>        alpha_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a>        T_amb_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">300.0</span>,</span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a>        sigma_A: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a>        sigma_B: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>        sigma_T: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a>        C_A0: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a>        T0: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store initial conditions and parameter values for later use</span></span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (See "What to Store as Attributes" callout below for detailed guidelines)</span></span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.C_A0 <span class="op">=</span> C_A0</span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T0 <span class="op">=</span> T0</span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha_val <span class="op">=</span> alpha_val</span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.T_amb_val <span class="op">=</span> T_amb_val</span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a>        <span class="co"># State and control variables (local - not stored as attributes)</span></span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a>        C_A, C_B, T <span class="op">=</span> sp.symbols(<span class="st">"C_A C_B T"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a>        Q <span class="op">=</span> sp.symbols(<span class="st">"Q"</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Deterministic Parameters (kinetics and heat transfer)</span></span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># These are local variables - used as keys in self.parameters dict</span></span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a>        k1, k2, E1, E2, alpha, T_amb <span class="op">=</span> sp.symbols(</span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a>            <span class="st">"k1 k2 E1 E2 alpha T_amb"</span>,</span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a>            real<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a>            positive<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-143"><a href="#cb56-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-144"><a href="#cb56-144" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stochastic Parameters (noise intensities)</span></span>
<span id="cb56-145"><a href="#cb56-145" aria-hidden="true" tabindex="-1"></a>        sigma_A_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_A"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-146"><a href="#cb56-146" aria-hidden="true" tabindex="-1"></a>        sigma_B_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_B"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-147"><a href="#cb56-147" aria-hidden="true" tabindex="-1"></a>        sigma_T_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_T"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-148"><a href="#cb56-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-149"><a href="#cb56-149" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parameters dictionary: Symbol → Value mapping</span></span>
<span id="cb56-150"><a href="#cb56-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Keys are the symbol objects created above</span></span>
<span id="cb56-151"><a href="#cb56-151" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">=</span> {</span>
<span id="cb56-152"><a href="#cb56-152" aria-hidden="true" tabindex="-1"></a>            k1: k1_val,</span>
<span id="cb56-153"><a href="#cb56-153" aria-hidden="true" tabindex="-1"></a>            k2: k2_val,</span>
<span id="cb56-154"><a href="#cb56-154" aria-hidden="true" tabindex="-1"></a>            E1: E1_val,</span>
<span id="cb56-155"><a href="#cb56-155" aria-hidden="true" tabindex="-1"></a>            E2: E2_val,</span>
<span id="cb56-156"><a href="#cb56-156" aria-hidden="true" tabindex="-1"></a>            alpha: alpha_val,</span>
<span id="cb56-157"><a href="#cb56-157" aria-hidden="true" tabindex="-1"></a>            T_amb: T_amb_val,</span>
<span id="cb56-158"><a href="#cb56-158" aria-hidden="true" tabindex="-1"></a>            sigma_A_sym: sigma_A,</span>
<span id="cb56-159"><a href="#cb56-159" aria-hidden="true" tabindex="-1"></a>            sigma_B_sym: sigma_B,</span>
<span id="cb56-160"><a href="#cb56-160" aria-hidden="true" tabindex="-1"></a>            sigma_T_sym: sigma_T,</span>
<span id="cb56-161"><a href="#cb56-161" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb56-162"><a href="#cb56-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-163"><a href="#cb56-163" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state_vars <span class="op">=</span> [C_A, C_B, T]</span>
<span id="cb56-164"><a href="#cb56-164" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.control_vars <span class="op">=</span> [Q]</span>
<span id="cb56-165"><a href="#cb56-165" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_vars <span class="op">=</span> []</span>
<span id="cb56-166"><a href="#cb56-166" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.order <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb56-167"><a href="#cb56-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-168"><a href="#cb56-168" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reaction rates (Arrhenius kinetics)</span></span>
<span id="cb56-169"><a href="#cb56-169" aria-hidden="true" tabindex="-1"></a>        r1 <span class="op">=</span> k1 <span class="op">*</span> C_A <span class="op">*</span> sp.exp(<span class="op">-</span>E1 <span class="op">/</span> T)</span>
<span id="cb56-170"><a href="#cb56-170" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> k2 <span class="op">*</span> C_B <span class="op">*</span> sp.exp(<span class="op">-</span>E2 <span class="op">/</span> T)</span>
<span id="cb56-171"><a href="#cb56-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-172"><a href="#cb56-172" aria-hidden="true" tabindex="-1"></a>        <span class="co"># DRIFT (Deterministic part - same as deterministic reactor)</span></span>
<span id="cb56-173"><a href="#cb56-173" aria-hidden="true" tabindex="-1"></a>        dC_A_dt <span class="op">=</span> <span class="op">-</span>r1</span>
<span id="cb56-174"><a href="#cb56-174" aria-hidden="true" tabindex="-1"></a>        dC_B_dt <span class="op">=</span> r1 <span class="op">-</span> r2</span>
<span id="cb56-175"><a href="#cb56-175" aria-hidden="true" tabindex="-1"></a>        dT_dt <span class="op">=</span> Q <span class="op">-</span> alpha <span class="op">*</span> (T <span class="op">-</span> T_amb)</span>
<span id="cb56-176"><a href="#cb56-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-177"><a href="#cb56-177" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([dC_A_dt, dC_B_dt, dT_dt])</span>
<span id="cb56-178"><a href="#cb56-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-179"><a href="#cb56-179" aria-hidden="true" tabindex="-1"></a>        <span class="co"># DIFFUSION (Stochastic part - additive noise)</span></span>
<span id="cb56-180"><a href="#cb56-180" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Diagonal matrix: three independent Wiener processes</span></span>
<span id="cb56-181"><a href="#cb56-181" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix(</span>
<span id="cb56-182"><a href="#cb56-182" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb56-183"><a href="#cb56-183" aria-hidden="true" tabindex="-1"></a>                [sigma_A_sym, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb56-184"><a href="#cb56-184" aria-hidden="true" tabindex="-1"></a>                [<span class="dv">0</span>, sigma_B_sym, <span class="dv">0</span>],</span>
<span id="cb56-185"><a href="#cb56-185" aria-hidden="true" tabindex="-1"></a>                [<span class="dv">0</span>, <span class="dv">0</span>, sigma_T_sym],</span>
<span id="cb56-186"><a href="#cb56-186" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb56-187"><a href="#cb56-187" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-188"><a href="#cb56-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-189"><a href="#cb56-189" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Itô SDE interpretation</span></span>
<span id="cb56-190"><a href="#cb56-190" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sde_type <span class="op">=</span> <span class="st">"ito"</span></span>
<span id="cb56-191"><a href="#cb56-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-192"><a href="#cb56-192" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Output: Full state measurement (with potential noise in practice)</span></span>
<span id="cb56-193"><a href="#cb56-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># technically optional</span></span>
<span id="cb56-194"><a href="#cb56-194" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._h_sym <span class="op">=</span> sp.Matrix([C_A, C_B, T])</span>
<span id="cb56-195"><a href="#cb56-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-196"><a href="#cb56-196" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb56-197"><a href="#cb56-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use stored parameter values directly</span></span>
<span id="cb56-198"><a href="#cb56-198" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Don't try to look up via sp.symbols() - that creates NEW symbol objects!)</span></span>
<span id="cb56-199"><a href="#cb56-199" aria-hidden="true" tabindex="-1"></a>        T_amb <span class="op">=</span> <span class="va">self</span>.T_amb_val</span>
<span id="cb56-200"><a href="#cb56-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-201"><a href="#cb56-201" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Complete conversion equilibrium (deterministic part)</span></span>
<span id="cb56-202"><a href="#cb56-202" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_equilibrium(</span>
<span id="cb56-203"><a href="#cb56-203" aria-hidden="true" tabindex="-1"></a>            <span class="st">"complete"</span>,</span>
<span id="cb56-204"><a href="#cb56-204" aria-hidden="true" tabindex="-1"></a>            x_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>, T_amb]),</span>
<span id="cb56-205"><a href="#cb56-205" aria-hidden="true" tabindex="-1"></a>            u_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>]),</span>
<span id="cb56-206"><a href="#cb56-206" aria-hidden="true" tabindex="-1"></a>            verify<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb56-207"><a href="#cb56-207" aria-hidden="true" tabindex="-1"></a>            stability<span class="op">=</span><span class="st">"stable"</span>,</span>
<span id="cb56-208"><a href="#cb56-208" aria-hidden="true" tabindex="-1"></a>            notes<span class="op">=</span><span class="st">"Equilibrium of deterministic part (drift). Stochastic trajectories "</span></span>
<span id="cb56-209"><a href="#cb56-209" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fluctuate around this point with variance growing over time."</span>,</span>
<span id="cb56-210"><a href="#cb56-210" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-211"><a href="#cb56-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-212"><a href="#cb56-212" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initial condition (if provided)</span></span>
<span id="cb56-213"><a href="#cb56-213" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.C_A0 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="va">self</span>.T0 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb56-214"><a href="#cb56-214" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="va">self</span>.alpha_val</span>
<span id="cb56-215"><a href="#cb56-215" aria-hidden="true" tabindex="-1"></a>            Q_init <span class="op">=</span> alpha <span class="op">*</span> (<span class="va">self</span>.T0 <span class="op">-</span> T_amb)</span>
<span id="cb56-216"><a href="#cb56-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-217"><a href="#cb56-217" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.add_equilibrium(</span>
<span id="cb56-218"><a href="#cb56-218" aria-hidden="true" tabindex="-1"></a>                <span class="st">"initial"</span>,</span>
<span id="cb56-219"><a href="#cb56-219" aria-hidden="true" tabindex="-1"></a>                x_eq<span class="op">=</span>np.array([<span class="va">self</span>.C_A0, <span class="fl">0.0</span>, <span class="va">self</span>.T0]),</span>
<span id="cb56-220"><a href="#cb56-220" aria-hidden="true" tabindex="-1"></a>                u_eq<span class="op">=</span>np.array([Q_init]),</span>
<span id="cb56-221"><a href="#cb56-221" aria-hidden="true" tabindex="-1"></a>                verify<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb56-222"><a href="#cb56-222" aria-hidden="true" tabindex="-1"></a>                stability<span class="op">=</span><span class="st">"unstable"</span>,</span>
<span id="cb56-223"><a href="#cb56-223" aria-hidden="true" tabindex="-1"></a>                notes<span class="op">=</span><span class="st">"Initial state setpoint (deterministic part). Stochastic trajectories "</span></span>
<span id="cb56-224"><a href="#cb56-224" aria-hidden="true" tabindex="-1"></a>                <span class="st">"will fluctuate with std ~ [σ_A·√t, σ_B·√t, σ_T·√t]."</span>,</span>
<span id="cb56-225"><a href="#cb56-225" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb56-226"><a href="#cb56-226" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.set_default_equilibrium(<span class="st">"initial"</span>)</span>
<span id="cb56-227"><a href="#cb56-227" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb56-228"><a href="#cb56-228" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.set_default_equilibrium(<span class="st">"complete"</span>)</span>
<span id="cb56-229"><a href="#cb56-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-230"><a href="#cb56-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-231"><a href="#cb56-231" aria-hidden="true" tabindex="-1"></a>The first step in system construction is to subclass the proper symbolic system and create the define_system method signature.</span>
<span id="cb56-232"><a href="#cb56-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-233"><a href="#cb56-233" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-234"><a href="#cb56-234" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ContinuousStochasticBatchReactor(ContinuousStochasticSystem):</span>
<span id="cb56-235"><a href="#cb56-235" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> define_system(</span>
<span id="cb56-236"><a href="#cb56-236" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb56-237"><a href="#cb56-237" aria-hidden="true" tabindex="-1"></a>        k1_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb56-238"><a href="#cb56-238" aria-hidden="true" tabindex="-1"></a>        k2_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span id="cb56-239"><a href="#cb56-239" aria-hidden="true" tabindex="-1"></a>        E1_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1000.0</span>,</span>
<span id="cb56-240"><a href="#cb56-240" aria-hidden="true" tabindex="-1"></a>        E2_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1500.0</span>,</span>
<span id="cb56-241"><a href="#cb56-241" aria-hidden="true" tabindex="-1"></a>        alpha_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span id="cb56-242"><a href="#cb56-242" aria-hidden="true" tabindex="-1"></a>        T_amb_val: <span class="bu">float</span> <span class="op">=</span> <span class="fl">300.0</span>,</span>
<span id="cb56-243"><a href="#cb56-243" aria-hidden="true" tabindex="-1"></a>        sigma_A: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb56-244"><a href="#cb56-244" aria-hidden="true" tabindex="-1"></a>        sigma_B: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb56-245"><a href="#cb56-245" aria-hidden="true" tabindex="-1"></a>        sigma_T: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb56-246"><a href="#cb56-246" aria-hidden="true" tabindex="-1"></a>        C_A0: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb56-247"><a href="#cb56-247" aria-hidden="true" tabindex="-1"></a>        T0: Optional[<span class="bu">float</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb56-248"><a href="#cb56-248" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb56-249"><a href="#cb56-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-250"><a href="#cb56-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-251"><a href="#cb56-251" aria-hidden="true" tabindex="-1"></a>More often than not, the only arguments to this function will be the <span class="in">`self`</span> argument and parameter values. It is not necessary to add type hints or default values, but it is recommended for debug purposes.</span>
<span id="cb56-252"><a href="#cb56-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-253"><a href="#cb56-253" aria-hidden="true" tabindex="-1"></a>The next step in system definition is to define the (deterministic) symbolic variables to be used and place them in the proper fields.</span>
<span id="cb56-254"><a href="#cb56-254" aria-hidden="true" tabindex="-1"></a>The main limitation currently is that it is not possible to explicitly define a symbolic variable for time. If it is heavily requested, we can implement it as a future feature.</span>
<span id="cb56-255"><a href="#cb56-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-256"><a href="#cb56-256" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-257"><a href="#cb56-257" aria-hidden="true" tabindex="-1"></a><span class="co"># State and control variables</span></span>
<span id="cb56-258"><a href="#cb56-258" aria-hidden="true" tabindex="-1"></a>C_A, C_B, T <span class="op">=</span> sp.symbols(<span class="st">"C_A C_B T"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-259"><a href="#cb56-259" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> sp.symbols(<span class="st">"Q"</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-260"><a href="#cb56-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-261"><a href="#cb56-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Deterministic Parameters (kinetics and heat transfer)</span></span>
<span id="cb56-262"><a href="#cb56-262" aria-hidden="true" tabindex="-1"></a>k1, k2, E1, E2, alpha, T_amb <span class="op">=</span> sp.symbols(</span>
<span id="cb56-263"><a href="#cb56-263" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k1 k2 E1 E2 alpha T_amb"</span>,</span>
<span id="cb56-264"><a href="#cb56-264" aria-hidden="true" tabindex="-1"></a>    real<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb56-265"><a href="#cb56-265" aria-hidden="true" tabindex="-1"></a>    positive<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb56-266"><a href="#cb56-266" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-267"><a href="#cb56-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-268"><a href="#cb56-268" aria-hidden="true" tabindex="-1"></a><span class="co"># Stochastic Parameters (noise intensities)</span></span>
<span id="cb56-269"><a href="#cb56-269" aria-hidden="true" tabindex="-1"></a>sigma_A_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_A"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-270"><a href="#cb56-270" aria-hidden="true" tabindex="-1"></a>sigma_B_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_B"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-271"><a href="#cb56-271" aria-hidden="true" tabindex="-1"></a>sigma_T_sym <span class="op">=</span> sp.symbols(<span class="st">"sigma_T"</span>, real<span class="op">=</span><span class="va">True</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-272"><a href="#cb56-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-273"><a href="#cb56-273" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {</span>
<span id="cb56-274"><a href="#cb56-274" aria-hidden="true" tabindex="-1"></a>    k1: k1_val,</span>
<span id="cb56-275"><a href="#cb56-275" aria-hidden="true" tabindex="-1"></a>    k2: k2_val,</span>
<span id="cb56-276"><a href="#cb56-276" aria-hidden="true" tabindex="-1"></a>    E1: E1_val,</span>
<span id="cb56-277"><a href="#cb56-277" aria-hidden="true" tabindex="-1"></a>    E2: E2_val,</span>
<span id="cb56-278"><a href="#cb56-278" aria-hidden="true" tabindex="-1"></a>    alpha: alpha_val,</span>
<span id="cb56-279"><a href="#cb56-279" aria-hidden="true" tabindex="-1"></a>    T_amb: T_amb_val,</span>
<span id="cb56-280"><a href="#cb56-280" aria-hidden="true" tabindex="-1"></a>    sigma_A_sym: sigma_A,</span>
<span id="cb56-281"><a href="#cb56-281" aria-hidden="true" tabindex="-1"></a>    sigma_B_sym: sigma_B,</span>
<span id="cb56-282"><a href="#cb56-282" aria-hidden="true" tabindex="-1"></a>    sigma_T_sym: sigma_T,</span>
<span id="cb56-283"><a href="#cb56-283" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-284"><a href="#cb56-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-285"><a href="#cb56-285" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [C_A, C_B, T]</span>
<span id="cb56-286"><a href="#cb56-286" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> [Q]</span>
<span id="cb56-287"><a href="#cb56-287" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.output_vars <span class="op">=</span> []</span>
<span id="cb56-288"><a href="#cb56-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-289"><a href="#cb56-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-290"><a href="#cb56-290" aria-hidden="true" tabindex="-1"></a>The necessary symbolic variables include:</span>
<span id="cb56-291"><a href="#cb56-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-292"><a href="#cb56-292" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>State variables</span>
<span id="cb56-293"><a href="#cb56-293" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Control variables</span>
<span id="cb56-294"><a href="#cb56-294" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Parameter variables</span>
<span id="cb56-295"><a href="#cb56-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-296"><a href="#cb56-296" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb56-297"><a href="#cb56-297" aria-hidden="true" tabindex="-1"></a><span class="fu">## What to Store as Attributes vs Local Variables</span></span>
<span id="cb56-298"><a href="#cb56-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-299"><a href="#cb56-299" aria-hidden="true" tabindex="-1"></a>A common source of confusion: **when should you store something as `self.something` vs keep it as a local variable?**</span>
<span id="cb56-300"><a href="#cb56-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-301"><a href="#cb56-301" aria-hidden="true" tabindex="-1"></a><span class="fu">### SymPy Symbols: Usually Local, Sometimes Stored</span></span>
<span id="cb56-302"><a href="#cb56-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-303"><a href="#cb56-303" aria-hidden="true" tabindex="-1"></a>**State and control symbols → Keep LOCAL (don't store as attributes):**</span>
<span id="cb56-304"><a href="#cb56-304" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-305"><a href="#cb56-305" aria-hidden="true" tabindex="-1"></a><span class="co"># CORRECT: Local variables only</span></span>
<span id="cb56-306"><a href="#cb56-306" aria-hidden="true" tabindex="-1"></a>C_A, C_B, T <span class="op">=</span> sp.symbols(<span class="st">"C_A C_B T"</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-307"><a href="#cb56-307" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> sp.symbols(<span class="st">"Q"</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-308"><a href="#cb56-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-309"><a href="#cb56-309" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Don't store these as attributes</span></span>
<span id="cb56-310"><a href="#cb56-310" aria-hidden="true" tabindex="-1"></a><span class="co"># self.C_A_sym = sp.symbols("C_A")  # Unnecessary!</span></span>
<span id="cb56-311"><a href="#cb56-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-312"><a href="#cb56-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-313"><a href="#cb56-313" aria-hidden="true" tabindex="-1"></a>**Why keep local?** These symbols are only used to build <span class="in">`self._f_sym`</span> and <span class="in">`self._h_sym`</span>. Once those are built, the framework tracks symbols via <span class="in">`self.state_vars`</span> and <span class="in">`self.control_vars`</span> lists. Storing individual symbols is redundant.</span>
<span id="cb56-314"><a href="#cb56-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-315"><a href="#cb56-315" aria-hidden="true" tabindex="-1"></a>**Parameter symbols → Keep LOCAL (unless using Solution 2 for equilibria):**</span>
<span id="cb56-316"><a href="#cb56-316" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-317"><a href="#cb56-317" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution 1 (tutorial approach): Local symbols</span></span>
<span id="cb56-318"><a href="#cb56-318" aria-hidden="true" tabindex="-1"></a>T_amb <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-319"><a href="#cb56-319" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {T_amb: T_amb_val}  <span class="co"># Symbol used as key only</span></span>
<span id="cb56-320"><a href="#cb56-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-321"><a href="#cb56-321" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution 2 (production code): Store symbol references</span></span>
<span id="cb56-322"><a href="#cb56-322" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.T_amb_sym <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-323"><a href="#cb56-323" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {<span class="va">self</span>.T_amb_sym: T_amb_val}  <span class="co"># Can look up later</span></span>
<span id="cb56-324"><a href="#cb56-324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-325"><a href="#cb56-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-326"><a href="#cb56-326" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parameter Values: Store When Needed Later</span></span>
<span id="cb56-327"><a href="#cb56-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-328"><a href="#cb56-328" aria-hidden="true" tabindex="-1"></a>**Store parameter values if used in `setup_equilibria()` or custom methods:**</span>
<span id="cb56-329"><a href="#cb56-329" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-330"><a href="#cb56-330" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, T_amb_val<span class="op">=</span><span class="fl">300.0</span>, alpha_val<span class="op">=</span><span class="fl">0.1</span>, ...):</span>
<span id="cb56-331"><a href="#cb56-331" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store values needed in setup_equilibria</span></span>
<span id="cb56-332"><a href="#cb56-332" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T_amb_val <span class="op">=</span> T_amb_val</span>
<span id="cb56-333"><a href="#cb56-333" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.alpha_val <span class="op">=</span> alpha_val</span>
<span id="cb56-334"><a href="#cb56-334" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-335"><a href="#cb56-335" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create symbols and populate parameters dict</span></span>
<span id="cb56-336"><a href="#cb56-336" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-337"><a href="#cb56-337" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {T_amb: T_amb_val, ...}</span>
<span id="cb56-338"><a href="#cb56-338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-339"><a href="#cb56-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-340"><a href="#cb56-340" aria-hidden="true" tabindex="-1"></a>**Don't store if only used in symbolic expressions:**</span>
<span id="cb56-341"><a href="#cb56-341" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-342"><a href="#cb56-342" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, k1_val<span class="op">=</span><span class="fl">0.5</span>, k2_val<span class="op">=</span><span class="fl">0.3</span>, ...):</span>
<span id="cb56-343"><a href="#cb56-343" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These are only used in _f_sym, not in setup_equilibria</span></span>
<span id="cb56-344"><a href="#cb56-344" aria-hidden="true" tabindex="-1"></a>    <span class="co"># No need to store as attributes</span></span>
<span id="cb56-345"><a href="#cb56-345" aria-hidden="true" tabindex="-1"></a>    k1 <span class="op">=</span> sp.symbols(<span class="st">'k1'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-346"><a href="#cb56-346" aria-hidden="true" tabindex="-1"></a>    k2 <span class="op">=</span> sp.symbols(<span class="st">'k2'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-347"><a href="#cb56-347" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-348"><a href="#cb56-348" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {k1: k1_val, k2: k2_val}</span>
<span id="cb56-349"><a href="#cb56-349" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([k1 <span class="op">*</span> C_A <span class="op">*</span> sp.exp(<span class="op">-</span>E1<span class="op">/</span>T)])  <span class="co"># Used here only</span></span>
<span id="cb56-350"><a href="#cb56-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-351"><a href="#cb56-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-352"><a href="#cb56-352" aria-hidden="true" tabindex="-1"></a><span class="fu">### Custom Fields: Always Store</span></span>
<span id="cb56-353"><a href="#cb56-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-354"><a href="#cb56-354" aria-hidden="true" tabindex="-1"></a>**Store data needed for conditional logic or custom methods:**</span>
<span id="cb56-355"><a href="#cb56-355" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-356"><a href="#cb56-356" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, C_A0<span class="op">=</span><span class="va">None</span>, T0<span class="op">=</span><span class="va">None</span>, ...):</span>
<span id="cb56-357"><a href="#cb56-357" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store for use in setup_equilibria</span></span>
<span id="cb56-358"><a href="#cb56-358" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.C_A0 <span class="op">=</span> C_A0</span>
<span id="cb56-359"><a href="#cb56-359" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T0 <span class="op">=</span> T0</span>
<span id="cb56-360"><a href="#cb56-360" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-361"><a href="#cb56-361" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store custom application data</span></span>
<span id="cb56-362"><a href="#cb56-362" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.reaction_pathway <span class="op">=</span> <span class="st">"A-&gt;B-&gt;C"</span></span>
<span id="cb56-363"><a href="#cb56-363" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.reactor_volume <span class="op">=</span> <span class="fl">10.0</span>  <span class="co"># liters</span></span>
<span id="cb56-364"><a href="#cb56-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-365"><a href="#cb56-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-366"><a href="#cb56-366" aria-hidden="true" tabindex="-1"></a><span class="fu">### Decision Tree</span></span>
<span id="cb56-367"><a href="#cb56-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-368"><a href="#cb56-368" aria-hidden="true" tabindex="-1"></a>**Should I store `foo` as `self.foo`?**</span>
<span id="cb56-369"><a href="#cb56-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-370"><a href="#cb56-370" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Is it a SymPy symbol?**</span>
<span id="cb56-371"><a href="#cb56-371" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>State/control symbol? → **No** (use <span class="in">`self.state_vars`</span> / <span class="in">`self.control_vars`</span> lists)</span>
<span id="cb56-372"><a href="#cb56-372" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Parameter symbol? → **No** (unless using Solution 2 for parameter lookup)</span>
<span id="cb56-373"><a href="#cb56-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-374"><a href="#cb56-374" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Is it a parameter value?**</span>
<span id="cb56-375"><a href="#cb56-375" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Used in <span class="in">`setup_equilibria()`</span>? → **Yes** (<span class="in">`self.param_val`</span>)</span>
<span id="cb56-376"><a href="#cb56-376" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Only used in <span class="in">`_f_sym`</span>? → **No** (just put in <span class="in">`self.parameters`</span> dict)</span>
<span id="cb56-377"><a href="#cb56-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-378"><a href="#cb56-378" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Is it a custom field?**</span>
<span id="cb56-379"><a href="#cb56-379" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Used in logic or custom methods? → **Yes** (<span class="in">`self.C_A0`</span>, <span class="in">`self.reactor_volume`</span>)</span>
<span id="cb56-380"><a href="#cb56-380" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Temporary calculation? → **No** (keep as local variable)</span>
<span id="cb56-381"><a href="#cb56-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-382"><a href="#cb56-382" aria-hidden="true" tabindex="-1"></a>**Rule of thumb:** If you'll need it in <span class="in">`setup_equilibria()`</span> or a custom method, store it as <span class="in">`self.something`</span>. Otherwise, keep it local.</span>
<span id="cb56-383"><a href="#cb56-383" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-384"><a href="#cb56-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-385"><a href="#cb56-385" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb56-386"><a href="#cb56-386" aria-hidden="true" tabindex="-1"></a><span class="fu">## Output Variables and the Output Map</span></span>
<span id="cb56-387"><a href="#cb56-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-388"><a href="#cb56-388" aria-hidden="true" tabindex="-1"></a>There are two related but distinct concepts for system outputs:</span>
<span id="cb56-389"><a href="#cb56-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-390"><a href="#cb56-390" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**`self.output_vars`**: A list of symbolic variables representing *computed outputs*—quantities derived from state variables but not states themselves. For example, if your states are position and velocity, an output variable might be kinetic energy. Do **not** add state variables to this list.</span>
<span id="cb56-391"><a href="#cb56-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-392"><a href="#cb56-392" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**`self._h_sym`**: The *output map* $y = h(x)$, a symbolic column vector defining what the system actually outputs. This can include:</span>
<span id="cb56-393"><a href="#cb56-393" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>State variables (for full or partial state observation)</span>
<span id="cb56-394"><a href="#cb56-394" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Output variables (computed quantities)</span>
<span id="cb56-395"><a href="#cb56-395" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Any symbolic expression of states</span>
<span id="cb56-396"><a href="#cb56-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-397"><a href="#cb56-397" aria-hidden="true" tabindex="-1"></a>**Defaults**: <span class="in">`self.output_vars = []`</span> (no computed outputs) and <span class="in">`self._h_sym = state vector`</span> (full state observability).</span>
<span id="cb56-398"><a href="#cb56-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-399"><a href="#cb56-399" aria-hidden="true" tabindex="-1"></a>**Example**: For a system with states $<span class="co">[</span><span class="ot">x, v</span><span class="co">]</span>$ and a computed output $E = \frac{1}{2}mv^2$:</span>
<span id="cb56-400"><a href="#cb56-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-401"><a href="#cb56-401" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`self.output_vars = [E]`</span></span>
<span id="cb56-402"><a href="#cb56-402" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`self._h_sym = sp.Matrix([x, E])`</span> outputs position and energy (but not velocity)</span>
<span id="cb56-403"><a href="#cb56-403" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-404"><a href="#cb56-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-405"><a href="#cb56-405" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb56-406"><a href="#cb56-406" aria-hidden="true" tabindex="-1"></a><span class="fu">## Autonomous Systems</span></span>
<span id="cb56-407"><a href="#cb56-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-408"><a href="#cb56-408" aria-hidden="true" tabindex="-1"></a>An **autonomous system** has no external control inputs—its dynamics depend only on the current state (and possibly time). Examples include free oscillators, population dynamics, and unforced chemical reactions.</span>
<span id="cb56-409"><a href="#cb56-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-410"><a href="#cb56-410" aria-hidden="true" tabindex="-1"></a><span class="fu">### Required Specification</span></span>
<span id="cb56-411"><a href="#cb56-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-412"><a href="#cb56-412" aria-hidden="true" tabindex="-1"></a>To define an autonomous system, you **must** set <span class="in">`self.control_vars = []`</span> (an empty list). Do not use <span class="in">`None`</span> or omit the field—this will cause errors during system initialization.</span>
<span id="cb56-413"><a href="#cb56-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-414"><a href="#cb56-414" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-415"><a href="#cb56-415" aria-hidden="true" tabindex="-1"></a><span class="co"># CORRECT: Autonomous system</span></span>
<span id="cb56-416"><a href="#cb56-416" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> []</span>
<span id="cb56-417"><a href="#cb56-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-418"><a href="#cb56-418" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Will cause errors</span></span>
<span id="cb56-419"><a href="#cb56-419" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> <span class="va">None</span></span>
<span id="cb56-420"><a href="#cb56-420" aria-hidden="true" tabindex="-1"></a><span class="co"># self.control_vars = ...  (omitting the field)</span></span>
<span id="cb56-421"><a href="#cb56-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-422"><a href="#cb56-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-423"><a href="#cb56-423" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dynamics for Autonomous Systems</span></span>
<span id="cb56-424"><a href="#cb56-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-425"><a href="#cb56-425" aria-hidden="true" tabindex="-1"></a>For autonomous systems, <span class="in">`self._f_sym`</span> should depend only on state variables and parameters, **not control variables**:</span>
<span id="cb56-426"><a href="#cb56-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-427"><a href="#cb56-427" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-428"><a href="#cb56-428" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Damped harmonic oscillator (autonomous)</span></span>
<span id="cb56-429"><a href="#cb56-429" aria-hidden="true" tabindex="-1"></a>x, v <span class="op">=</span> sp.symbols(<span class="st">'x v'</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-430"><a href="#cb56-430" aria-hidden="true" tabindex="-1"></a>k, b, m <span class="op">=</span> sp.symbols(<span class="st">'k b m'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-431"><a href="#cb56-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-432"><a href="#cb56-432" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [x, v]</span>
<span id="cb56-433"><a href="#cb56-433" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># No control</span></span>
<span id="cb56-434"><a href="#cb56-434" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.parameters <span class="op">=</span> {k: <span class="fl">10.0</span>, b: <span class="fl">0.5</span>, m: <span class="fl">1.0</span>}</span>
<span id="cb56-435"><a href="#cb56-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-436"><a href="#cb56-436" aria-hidden="true" tabindex="-1"></a><span class="co"># Dynamics: dx/dt = v, dv/dt = -(k/m)*x - (b/m)*v</span></span>
<span id="cb56-437"><a href="#cb56-437" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([</span>
<span id="cb56-438"><a href="#cb56-438" aria-hidden="true" tabindex="-1"></a>    v,</span>
<span id="cb56-439"><a href="#cb56-439" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span>(k<span class="op">/</span>m)<span class="op">*</span>x <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>v</span>
<span id="cb56-440"><a href="#cb56-440" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb56-441"><a href="#cb56-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-442"><a href="#cb56-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-443"><a href="#cb56-443" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calling Conventions</span></span>
<span id="cb56-444"><a href="#cb56-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-445"><a href="#cb56-445" aria-hidden="true" tabindex="-1"></a>When evaluating or integrating autonomous systems:</span>
<span id="cb56-446"><a href="#cb56-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-447"><a href="#cb56-447" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The <span class="in">`u`</span> parameter in <span class="in">`system(x, u)`</span> should be <span class="in">`None`</span> or omitted</span>
<span id="cb56-448"><a href="#cb56-448" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Integration accepts <span class="in">`u=None`</span> or no control specification</span>
<span id="cb56-449"><a href="#cb56-449" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The framework automatically handles zero control internally</span>
<span id="cb56-450"><a href="#cb56-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-451"><a href="#cb56-451" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-452"><a href="#cb56-452" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluating dynamics</span></span>
<span id="cb56-453"><a href="#cb56-453" aria-hidden="true" tabindex="-1"></a>dxdt <span class="op">=</span> system(x)              <span class="co"># Recommended</span></span>
<span id="cb56-454"><a href="#cb56-454" aria-hidden="true" tabindex="-1"></a>dxdt <span class="op">=</span> system(x, u<span class="op">=</span><span class="va">None</span>)      <span class="co"># Also valid</span></span>
<span id="cb56-455"><a href="#cb56-455" aria-hidden="true" tabindex="-1"></a>dxdt <span class="op">=</span> system(x, np.array([])) <span class="co"># Works but unnecessary</span></span>
<span id="cb56-456"><a href="#cb56-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-457"><a href="#cb56-457" aria-hidden="true" tabindex="-1"></a><span class="co"># Integration</span></span>
<span id="cb56-458"><a href="#cb56-458" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(x0<span class="op">=</span>x_init, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>))</span>
<span id="cb56-459"><a href="#cb56-459" aria-hidden="true" tabindex="-1"></a><span class="co"># No need to specify u - it's ignored for autonomous systems</span></span>
<span id="cb56-460"><a href="#cb56-460" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-461"><a href="#cb56-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-462"><a href="#cb56-462" aria-hidden="true" tabindex="-1"></a><span class="fu">### Converting Between Controlled and Autonomous</span></span>
<span id="cb56-463"><a href="#cb56-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-464"><a href="#cb56-464" aria-hidden="true" tabindex="-1"></a>You can model the same physical system in different ways:</span>
<span id="cb56-465"><a href="#cb56-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-466"><a href="#cb56-466" aria-hidden="true" tabindex="-1"></a>**Controlled oscillator** (with external force):</span>
<span id="cb56-467"><a href="#cb56-467" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-468"><a href="#cb56-468" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [x, v]</span>
<span id="cb56-469"><a href="#cb56-469" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> [u]  <span class="co"># External force</span></span>
<span id="cb56-470"><a href="#cb56-470" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([v, <span class="op">-</span>(k<span class="op">/</span>m)<span class="op">*</span>x <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>v <span class="op">+</span> u<span class="op">/</span>m])</span>
<span id="cb56-471"><a href="#cb56-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-472"><a href="#cb56-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-473"><a href="#cb56-473" aria-hidden="true" tabindex="-1"></a>**Free oscillator** (autonomous, special case u=0):</span>
<span id="cb56-474"><a href="#cb56-474" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-475"><a href="#cb56-475" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [x, v]</span>
<span id="cb56-476"><a href="#cb56-476" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># No control</span></span>
<span id="cb56-477"><a href="#cb56-477" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([v, <span class="op">-</span>(k<span class="op">/</span>m)<span class="op">*</span>x <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>v])</span>
<span id="cb56-478"><a href="#cb56-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-479"><a href="#cb56-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-480"><a href="#cb56-480" aria-hidden="true" tabindex="-1"></a>Both are valid modeling choices. Use controlled form when you plan to apply inputs at some point; use autonomous form for analyzing free dynamics or when control is not part of the problem. Systems with control inputs expect at least a function that output constant zero input.</span>
<span id="cb56-481"><a href="#cb56-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-482"><a href="#cb56-482" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time-Varying vs Autonomous</span></span>
<span id="cb56-483"><a href="#cb56-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-484"><a href="#cb56-484" aria-hidden="true" tabindex="-1"></a>**Important distinction**:</span>
<span id="cb56-485"><a href="#cb56-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-486"><a href="#cb56-486" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Autonomous** = no control inputs (<span class="in">`self.control_vars = []`</span>)</span>
<span id="cb56-487"><a href="#cb56-487" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Time-invariant** = dynamics don't explicitly depend on time</span>
<span id="cb56-488"><a href="#cb56-488" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Time-varying** = dynamics explicitly depend on time</span>
<span id="cb56-489"><a href="#cb56-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-490"><a href="#cb56-490" aria-hidden="true" tabindex="-1"></a>A system can be autonomous but time-varying (e.g., $\dot{x} = -\sin(t) \cdot x$) or controlled but time-invariant (e.g., $\dot{x} = -x + u$). Most systems in control theory are both controlled and time-invariant.</span>
<span id="cb56-491"><a href="#cb56-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-492"><a href="#cb56-492" aria-hidden="true" tabindex="-1"></a><span class="fu">### Practical Examples</span></span>
<span id="cb56-493"><a href="#cb56-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-494"><a href="#cb56-494" aria-hidden="true" tabindex="-1"></a>**Autonomous systems:**</span>
<span id="cb56-495"><a href="#cb56-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-496"><a href="#cb56-496" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Lotka-Volterra predator-prey: $\dot{x} = \alpha x - \beta xy$, $\dot{y} = \delta xy - \gamma y$</span>
<span id="cb56-497"><a href="#cb56-497" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Van der Pol oscillator: $\ddot{x} + \mu(x^2-1)\dot{x} + x = 0$</span>
<span id="cb56-498"><a href="#cb56-498" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Free batch reactor (no heating): $\dot{C}_A = -k_1 C_A e^{-E_1/T}$, $\dot{T} = -\alpha(T - T_{amb})$</span>
<span id="cb56-499"><a href="#cb56-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-500"><a href="#cb56-500" aria-hidden="true" tabindex="-1"></a>**Controlled systems:**</span>
<span id="cb56-501"><a href="#cb56-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-502"><a href="#cb56-502" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Inverted pendulum with torque: $\ddot{\theta} = (g/L)\sin\theta + u/(mL^2)$</span>
<span id="cb56-503"><a href="#cb56-503" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Batch reactor with heating (this tutorial): $\dot{T} = Q - \alpha(T - T_{amb})$</span>
<span id="cb56-504"><a href="#cb56-504" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Linear regulator: $\dot{x} = Ax + Bu$</span>
<span id="cb56-505"><a href="#cb56-505" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-506"><a href="#cb56-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-507"><a href="#cb56-507" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb56-508"><a href="#cb56-508" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameter Dictionary Keys Must Be Symbolic Variables</span></span>
<span id="cb56-509"><a href="#cb56-509" aria-hidden="true" tabindex="-1"></a>A common mistake is to set the dictionary keys for self.parameters as strings, but for proper symbolic substitution and code generation, the keys must be SymPy Symbolic variables.</span>
<span id="cb56-510"><a href="#cb56-510" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-511"><a href="#cb56-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-512"><a href="#cb56-512" aria-hidden="true" tabindex="-1"></a>The final required step in system definition is to relate symbolic variables for the definition of the system (and possibly observation) dynamics.</span>
<span id="cb56-513"><a href="#cb56-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-514"><a href="#cb56-514" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-515"><a href="#cb56-515" aria-hidden="true" tabindex="-1"></a><span class="co"># Reaction rates (Arrhenius kinetics)</span></span>
<span id="cb56-516"><a href="#cb56-516" aria-hidden="true" tabindex="-1"></a>r1 <span class="op">=</span> k1 <span class="op">*</span> C_A <span class="op">*</span> sp.exp(<span class="op">-</span>E1 <span class="op">/</span> T)</span>
<span id="cb56-517"><a href="#cb56-517" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> k2 <span class="op">*</span> C_B <span class="op">*</span> sp.exp(<span class="op">-</span>E2 <span class="op">/</span> T)</span>
<span id="cb56-518"><a href="#cb56-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-519"><a href="#cb56-519" aria-hidden="true" tabindex="-1"></a><span class="co"># DRIFT (Deterministic part - same as deterministic reactor)</span></span>
<span id="cb56-520"><a href="#cb56-520" aria-hidden="true" tabindex="-1"></a>dC_A_dt <span class="op">=</span> <span class="op">-</span>r1</span>
<span id="cb56-521"><a href="#cb56-521" aria-hidden="true" tabindex="-1"></a>dC_B_dt <span class="op">=</span> r1 <span class="op">-</span> r2</span>
<span id="cb56-522"><a href="#cb56-522" aria-hidden="true" tabindex="-1"></a>dT_dt <span class="op">=</span> Q <span class="op">-</span> alpha <span class="op">*</span> (T <span class="op">-</span> T_amb)</span>
<span id="cb56-523"><a href="#cb56-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-524"><a href="#cb56-524" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([dC_A_dt, dC_B_dt, dT_dt])</span>
<span id="cb56-525"><a href="#cb56-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-526"><a href="#cb56-526" aria-hidden="true" tabindex="-1"></a><span class="co"># DIFFUSION (Stochastic part - additive noise)</span></span>
<span id="cb56-527"><a href="#cb56-527" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagonal matrix: three independent Wiener processes</span></span>
<span id="cb56-528"><a href="#cb56-528" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix(</span>
<span id="cb56-529"><a href="#cb56-529" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb56-530"><a href="#cb56-530" aria-hidden="true" tabindex="-1"></a>        [sigma_A_sym, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb56-531"><a href="#cb56-531" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, sigma_B_sym, <span class="dv">0</span>],</span>
<span id="cb56-532"><a href="#cb56-532" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, sigma_T_sym],</span>
<span id="cb56-533"><a href="#cb56-533" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb56-534"><a href="#cb56-534" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-535"><a href="#cb56-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-536"><a href="#cb56-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-537"><a href="#cb56-537" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb56-538"><a href="#cb56-538" aria-hidden="true" tabindex="-1"></a><span class="fu">## Diffusion Matrix Structure</span></span>
<span id="cb56-539"><a href="#cb56-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-540"><a href="#cb56-540" aria-hidden="true" tabindex="-1"></a>The diffusion matrix $G$ has dimensions $(n_{\text{states}} \times n_{\text{Wiener}})$, where each column corresponds to an independent Wiener process and each row to a state variable. The stochastic term in the SDE is $G\,dW_t$ where $dW_t$ is a vector of independent Wiener increments.</span>
<span id="cb56-541"><a href="#cb56-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-542"><a href="#cb56-542" aria-hidden="true" tabindex="-1"></a>**Why a matrix, not a vector?** A vector would only allow one noise source affecting all states with fixed relative magnitudes. The matrix form enables:</span>
<span id="cb56-543"><a href="#cb56-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-544"><a href="#cb56-544" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Diagonal matrices** (as above): Each state has its own independent noise source. The $i$-th Wiener process affects only the $i$-th state.</span>
<span id="cb56-545"><a href="#cb56-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-546"><a href="#cb56-546" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Off-diagonal elements**: Represent *correlated noise*—when a single physical noise source affects multiple states. For example, if temperature fluctuations also induced concentration measurement errors:</span>
<span id="cb56-547"><a href="#cb56-547" aria-hidden="true" tabindex="-1"></a>  <span class="in">```python</span></span>
<span id="cb56-548"><a href="#cb56-548" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([</span>
<span id="cb56-549"><a href="#cb56-549" aria-hidden="true" tabindex="-1"></a>      [sigma_A_sym, <span class="dv">0</span>, sigma_AT],  <span class="co"># C_A affected by W_A and W_T</span></span>
<span id="cb56-550"><a href="#cb56-550" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, sigma_B_sym, <span class="dv">0</span>],</span>
<span id="cb56-551"><a href="#cb56-551" aria-hidden="true" tabindex="-1"></a>      [<span class="dv">0</span>, <span class="dv">0</span>, sigma_T_sym],</span>
<span id="cb56-552"><a href="#cb56-552" aria-hidden="true" tabindex="-1"></a>  ])</span>
<span id="cb56-553"><a href="#cb56-553" aria-hidden="true" tabindex="-1"></a>  <span class="in">```</span></span>
<span id="cb56-554"><a href="#cb56-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-555"><a href="#cb56-555" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Non-square matrices**: You can have fewer Wiener processes than states (correlated noise) or more (redundant noise sources for modeling flexibility).</span>
<span id="cb56-556"><a href="#cb56-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-557"><a href="#cb56-557" aria-hidden="true" tabindex="-1"></a>**Dimensions expected**: For $n$ state variables and $m$ independent Wiener processes, <span class="in">`diffusion_expr`</span> should be an $n \times m$ SymPy Matrix.</span>
<span id="cb56-558"><a href="#cb56-558" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-559"><a href="#cb56-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-560"><a href="#cb56-560" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-561"><a href="#cb56-561" aria-hidden="true" tabindex="-1"></a><span class="co"># Output: Full state measurement (with potential noise in practice)</span></span>
<span id="cb56-562"><a href="#cb56-562" aria-hidden="true" tabindex="-1"></a><span class="co"># technically optional</span></span>
<span id="cb56-563"><a href="#cb56-563" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._h_sym <span class="op">=</span> sp.Matrix([C_A, C_B, T])</span>
<span id="cb56-564"><a href="#cb56-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-565"><a href="#cb56-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-566"><a href="#cb56-566" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb56-567"><a href="#cb56-567" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pure Diffusion Systems</span></span>
<span id="cb56-568"><a href="#cb56-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-569"><a href="#cb56-569" aria-hidden="true" tabindex="-1"></a>A **pure diffusion system** (also called a pure noise process) has no deterministic drift—dynamics are driven entirely by stochastic forcing. Examples include Brownian motion, geometric random walks, and models of measurement noise.</span>
<span id="cb56-570"><a href="#cb56-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-571"><a href="#cb56-571" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mathematical Form</span></span>
<span id="cb56-572"><a href="#cb56-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-573"><a href="#cb56-573" aria-hidden="true" tabindex="-1"></a>For pure diffusion systems, the SDE has zero drift:</span>
<span id="cb56-574"><a href="#cb56-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-575"><a href="#cb56-575" aria-hidden="true" tabindex="-1"></a>$$dX_t = 0 \cdot dt + G(X_t)\,dW_t = G(X_t)\,dW_t$$</span>
<span id="cb56-576"><a href="#cb56-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-577"><a href="#cb56-577" aria-hidden="true" tabindex="-1"></a>This means the state evolution is governed entirely by the diffusion term. The deterministic dynamics $f(x,u) = 0$ vanish.</span>
<span id="cb56-578"><a href="#cb56-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-579"><a href="#cb56-579" aria-hidden="true" tabindex="-1"></a><span class="fu">### Required Specification</span></span>
<span id="cb56-580"><a href="#cb56-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-581"><a href="#cb56-581" aria-hidden="true" tabindex="-1"></a>To define a pure diffusion system, you **must** set <span class="in">`self._f_sym`</span> to a zero vector with the same dimension as the number of state variables. Use SymPy's <span class="in">`zeros()`</span> function or explicitly construct the zero matrix:</span>
<span id="cb56-582"><a href="#cb56-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-583"><a href="#cb56-583" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-584"><a href="#cb56-584" aria-hidden="true" tabindex="-1"></a><span class="co"># CORRECT: Pure diffusion system (3 states)</span></span>
<span id="cb56-585"><a href="#cb56-585" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.zeros(<span class="dv">3</span>, <span class="dv">1</span>)  <span class="co"># Recommended approach</span></span>
<span id="cb56-586"><a href="#cb56-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-587"><a href="#cb56-587" aria-hidden="true" tabindex="-1"></a><span class="co"># ALSO CORRECT: Explicit zero matrix</span></span>
<span id="cb56-588"><a href="#cb56-588" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb56-589"><a href="#cb56-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-590"><a href="#cb56-590" aria-hidden="true" tabindex="-1"></a><span class="co"># ALSO CORRECT: Using symbols and expressions that equal zero</span></span>
<span id="cb56-591"><a href="#cb56-591" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([x <span class="op">-</span> x, y <span class="op">-</span> y, z <span class="op">-</span> z])  <span class="co"># Works but unnecessary</span></span>
<span id="cb56-592"><a href="#cb56-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-593"><a href="#cb56-593" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Omitting _f_sym entirely (required field)</span></span>
<span id="cb56-594"><a href="#cb56-594" aria-hidden="true" tabindex="-1"></a><span class="co"># self._f_sym = None  # Will cause errors</span></span>
<span id="cb56-595"><a href="#cb56-595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-596"><a href="#cb56-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-597"><a href="#cb56-597" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example: 3D Brownian Motion</span></span>
<span id="cb56-598"><a href="#cb56-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-599"><a href="#cb56-599" aria-hidden="true" tabindex="-1"></a>A particle undergoing pure diffusion in 3D space:</span>
<span id="cb56-600"><a href="#cb56-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-601"><a href="#cb56-601" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-602"><a href="#cb56-602" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BrownianMotion3D(ContinuousStochasticSystem):</span>
<span id="cb56-603"><a href="#cb56-603" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> define_system(<span class="va">self</span>, sigma_x<span class="op">=</span><span class="fl">1.0</span>, sigma_y<span class="op">=</span><span class="fl">1.0</span>, sigma_z<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb56-604"><a href="#cb56-604" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position coordinates</span></span>
<span id="cb56-605"><a href="#cb56-605" aria-hidden="true" tabindex="-1"></a>        x, y, z <span class="op">=</span> sp.symbols(<span class="st">'x y z'</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-606"><a href="#cb56-606" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-607"><a href="#cb56-607" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Diffusion coefficients</span></span>
<span id="cb56-608"><a href="#cb56-608" aria-hidden="true" tabindex="-1"></a>        sx, sy, sz <span class="op">=</span> sp.symbols(<span class="st">'sigma_x sigma_y sigma_z'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-609"><a href="#cb56-609" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-610"><a href="#cb56-610" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state_vars <span class="op">=</span> [x, y, z]</span>
<span id="cb56-611"><a href="#cb56-611" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># Autonomous (no control)</span></span>
<span id="cb56-612"><a href="#cb56-612" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parameters <span class="op">=</span> {sx: sigma_x, sy: sigma_y, sz: sigma_z}</span>
<span id="cb56-613"><a href="#cb56-613" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-614"><a href="#cb56-614" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ZERO DRIFT: No deterministic motion</span></span>
<span id="cb56-615"><a href="#cb56-615" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._f_sym <span class="op">=</span> sp.zeros(<span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb56-616"><a href="#cb56-616" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-617"><a href="#cb56-617" aria-hidden="true" tabindex="-1"></a>        <span class="co"># DIFFUSION: Independent noise in each direction</span></span>
<span id="cb56-618"><a href="#cb56-618" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([</span>
<span id="cb56-619"><a href="#cb56-619" aria-hidden="true" tabindex="-1"></a>            [sx, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb56-620"><a href="#cb56-620" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>, sy, <span class="dv">0</span>],</span>
<span id="cb56-621"><a href="#cb56-621" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>, <span class="dv">0</span>, sz]</span>
<span id="cb56-622"><a href="#cb56-622" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb56-623"><a href="#cb56-623" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb56-624"><a href="#cb56-624" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sde_type <span class="op">=</span> <span class="st">"ito"</span></span>
<span id="cb56-625"><a href="#cb56-625" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-626"><a href="#cb56-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-627"><a href="#cb56-627" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use Pure Diffusion</span></span>
<span id="cb56-628"><a href="#cb56-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-629"><a href="#cb56-629" aria-hidden="true" tabindex="-1"></a>**Use pure diffusion when modeling:**</span>
<span id="cb56-630"><a href="#cb56-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-631"><a href="#cb56-631" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Brownian motion**: Pure random walks in continuous time</span>
<span id="cb56-632"><a href="#cb56-632" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Measurement noise**: Sensors with zero mean noise and no drift</span>
<span id="cb56-633"><a href="#cb56-633" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Diffusion-only processes**: Heat diffusion at steady-state, particle diffusion</span>
<span id="cb56-634"><a href="#cb56-634" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Null models**: Testing whether observed dynamics are purely random</span>
<span id="cb56-635"><a href="#cb56-635" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Noise characterization**: Estimating noise covariance without modeling dynamics</span>
<span id="cb56-636"><a href="#cb56-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-637"><a href="#cb56-637" aria-hidden="true" tabindex="-1"></a>**Don't use pure diffusion when:**</span>
<span id="cb56-638"><a href="#cb56-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-639"><a href="#cb56-639" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>System has deterministic dynamics (even if noisy)</span>
<span id="cb56-640"><a href="#cb56-640" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Modeling physical systems with forces/flows (use drift + diffusion)</span>
<span id="cb56-641"><a href="#cb56-641" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Equilibrium points matter (pure diffusion has no equilibria except possibly at boundaries)</span>
<span id="cb56-642"><a href="#cb56-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-643"><a href="#cb56-643" aria-hidden="true" tabindex="-1"></a><span class="fu">### Physical Interpretation</span></span>
<span id="cb56-644"><a href="#cb56-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-645"><a href="#cb56-645" aria-hidden="true" tabindex="-1"></a>For additive noise (constant $G$):</span>
<span id="cb56-646"><a href="#cb56-646" aria-hidden="true" tabindex="-1"></a>$$dX_t = G\,dW_t$$</span>
<span id="cb56-647"><a href="#cb56-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-648"><a href="#cb56-648" aria-hidden="true" tabindex="-1"></a>The solution is simply $X_t = X_0 + G\,W_t$, where $W_t$ is Brownian motion. The state performs a random walk around its initial condition with variance growing linearly: $\text{Var}(X_t) = GG^T \cdot t$.</span>
<span id="cb56-649"><a href="#cb56-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-650"><a href="#cb56-650" aria-hidden="true" tabindex="-1"></a>For multiplicative noise (state-dependent $G(X)$):</span>
<span id="cb56-651"><a href="#cb56-651" aria-hidden="true" tabindex="-1"></a>$$dX_t = G(X_t)\,dW_t$$</span>
<span id="cb56-652"><a href="#cb56-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-653"><a href="#cb56-653" aria-hidden="true" tabindex="-1"></a>The dynamics are more complex, and the SDE interpretation (Itô vs Stratonovich) becomes critical.</span>
<span id="cb56-654"><a href="#cb56-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-655"><a href="#cb56-655" aria-hidden="true" tabindex="-1"></a><span class="fu">### Integration Considerations</span></span>
<span id="cb56-656"><a href="#cb56-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-657"><a href="#cb56-657" aria-hidden="true" tabindex="-1"></a>Pure diffusion systems require:</span>
<span id="cb56-658"><a href="#cb56-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-659"><a href="#cb56-659" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Stochastic integrators**: Methods like Euler-Maruyama, Milstein, or higher-order SDE schemes</span>
<span id="cb56-660"><a href="#cb56-660" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Fine time steps**: To resolve the noise structure accurately</span>
<span id="cb56-661"><a href="#cb56-661" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Multiple realizations**: Statistical properties emerge from ensemble averaging</span>
<span id="cb56-662"><a href="#cb56-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-663"><a href="#cb56-663" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-664"><a href="#cb56-664" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Simulating 3D Brownian motion</span></span>
<span id="cb56-665"><a href="#cb56-665" aria-hidden="true" tabindex="-1"></a>brownian <span class="op">=</span> BrownianMotion3D(sigma_x<span class="op">=</span><span class="fl">1.0</span>, sigma_y<span class="op">=</span><span class="fl">1.0</span>, sigma_z<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb56-666"><a href="#cb56-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-667"><a href="#cb56-667" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial position at origin</span></span>
<span id="cb56-668"><a href="#cb56-668" aria-hidden="true" tabindex="-1"></a>x0 <span class="op">=</span> np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>])</span>
<span id="cb56-669"><a href="#cb56-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-670"><a href="#cb56-670" aria-hidden="true" tabindex="-1"></a><span class="co"># Integrate using Euler-Maruyama</span></span>
<span id="cb56-671"><a href="#cb56-671" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> brownian.integrate(</span>
<span id="cb56-672"><a href="#cb56-672" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0,</span>
<span id="cb56-673"><a href="#cb56-673" aria-hidden="true" tabindex="-1"></a>    t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb56-674"><a href="#cb56-674" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"euler_maruyama"</span>,</span>
<span id="cb56-675"><a href="#cb56-675" aria-hidden="true" tabindex="-1"></a>    dt<span class="op">=</span><span class="fl">0.01</span>,  <span class="co"># Fine time step for noise resolution</span></span>
<span id="cb56-676"><a href="#cb56-676" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>   <span class="co"># Reproducible noise</span></span>
<span id="cb56-677"><a href="#cb56-677" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-678"><a href="#cb56-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-679"><a href="#cb56-679" aria-hidden="true" tabindex="-1"></a><span class="co"># For statistics, run multiple trajectories</span></span>
<span id="cb56-680"><a href="#cb56-680" aria-hidden="true" tabindex="-1"></a>trajectories <span class="op">=</span> [</span>
<span id="cb56-681"><a href="#cb56-681" aria-hidden="true" tabindex="-1"></a>    brownian.integrate(x0<span class="op">=</span>x0, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>), dt<span class="op">=</span><span class="fl">0.01</span>, seed<span class="op">=</span>i)</span>
<span id="cb56-682"><a href="#cb56-682" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>)</span>
<span id="cb56-683"><a href="#cb56-683" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb56-684"><a href="#cb56-684" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-685"><a href="#cb56-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-686"><a href="#cb56-686" aria-hidden="true" tabindex="-1"></a><span class="fu">### Drift + Diffusion vs Pure Diffusion</span></span>
<span id="cb56-687"><a href="#cb56-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-688"><a href="#cb56-688" aria-hidden="true" tabindex="-1"></a>Most physical systems have **both** drift and diffusion:</span>
<span id="cb56-689"><a href="#cb56-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-690"><a href="#cb56-690" aria-hidden="true" tabindex="-1"></a>**Drift + Diffusion** (this tutorial's reactor):</span>
<span id="cb56-691"><a href="#cb56-691" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-692"><a href="#cb56-692" aria-hidden="true" tabindex="-1"></a><span class="co"># Deterministic part (drift)</span></span>
<span id="cb56-693"><a href="#cb56-693" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([dC_A_dt, dC_B_dt, dT_dt])</span>
<span id="cb56-694"><a href="#cb56-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-695"><a href="#cb56-695" aria-hidden="true" tabindex="-1"></a><span class="co"># Stochastic part (diffusion)  </span></span>
<span id="cb56-696"><a href="#cb56-696" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([[σ_A, <span class="dv">0</span>, <span class="dv">0</span>], ...])</span>
<span id="cb56-697"><a href="#cb56-697" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-698"><a href="#cb56-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-699"><a href="#cb56-699" aria-hidden="true" tabindex="-1"></a>**Pure Diffusion** (rare in practice):</span>
<span id="cb56-700"><a href="#cb56-700" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-701"><a href="#cb56-701" aria-hidden="true" tabindex="-1"></a><span class="co"># No drift</span></span>
<span id="cb56-702"><a href="#cb56-702" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.zeros(<span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb56-703"><a href="#cb56-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-704"><a href="#cb56-704" aria-hidden="true" tabindex="-1"></a><span class="co"># Only diffusion</span></span>
<span id="cb56-705"><a href="#cb56-705" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([[σ_A, <span class="dv">0</span>, <span class="dv">0</span>], ...])</span>
<span id="cb56-706"><a href="#cb56-706" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-707"><a href="#cb56-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-708"><a href="#cb56-708" aria-hidden="true" tabindex="-1"></a>The batch reactor in this tutorial has **drift + diffusion** because chemical reactions (drift) occur alongside process noise (diffusion).</span>
<span id="cb56-709"><a href="#cb56-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-710"><a href="#cb56-710" aria-hidden="true" tabindex="-1"></a><span class="fu">### Practical Applications</span></span>
<span id="cb56-711"><a href="#cb56-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-712"><a href="#cb56-712" aria-hidden="true" tabindex="-1"></a>**Pure Brownian Motion:**</span>
<span id="cb56-713"><a href="#cb56-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-714"><a href="#cb56-714" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Modeling colloidal particle motion in fluids</span>
<span id="cb56-715"><a href="#cb56-715" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Financial models with zero expected return</span>
<span id="cb56-716"><a href="#cb56-716" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Null hypothesis testing in time series</span>
<span id="cb56-717"><a href="#cb56-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-718"><a href="#cb56-718" aria-hidden="true" tabindex="-1"></a>**State-Dependent Diffusion:**</span>
<span id="cb56-719"><a href="#cb56-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-720"><a href="#cb56-720" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Volatility modeling in finance (stochastic volatility models)</span>
<span id="cb56-721"><a href="#cb56-721" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Birth-death processes at steady-state</span>
<span id="cb56-722"><a href="#cb56-722" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Fluctuation-dissipation in statistical mechanics</span>
<span id="cb56-723"><a href="#cb56-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-724"><a href="#cb56-724" aria-hidden="true" tabindex="-1"></a>**General Recommendation**: If you're unsure whether your system should be pure diffusion, it probably shouldn't be. Most physical systems have deterministic dynamics (drift) plus noise (diffusion).</span>
<span id="cb56-725"><a href="#cb56-725" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-726"><a href="#cb56-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-727"><a href="#cb56-727" aria-hidden="true" tabindex="-1"></a><span class="fu">## Required vs Optional System Definition Elements</span></span>
<span id="cb56-728"><a href="#cb56-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-729"><a href="#cb56-729" aria-hidden="true" tabindex="-1"></a>Understanding what's required versus optional helps you define systems efficiently while maintaining clarity. Here's the complete breakdown:</span>
<span id="cb56-730"><a href="#cb56-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-731"><a href="#cb56-731" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb56-732"><a href="#cb56-732" aria-hidden="true" tabindex="-1"></a><span class="fu">## Required Elements</span></span>
<span id="cb56-733"><a href="#cb56-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-734"><a href="#cb56-734" aria-hidden="true" tabindex="-1"></a>Every <span class="in">`define_system()`</span> method **must** define:</span>
<span id="cb56-735"><a href="#cb56-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-736"><a href="#cb56-736" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**`self.state_vars`**: List of state variable symbols</span>
<span id="cb56-737"><a href="#cb56-737" aria-hidden="true" tabindex="-1"></a>   <span class="in">```python</span></span>
<span id="cb56-738"><a href="#cb56-738" aria-hidden="true" tabindex="-1"></a>   <span class="va">self</span>.state_vars <span class="op">=</span> [C_A, C_B, T]</span>
<span id="cb56-739"><a href="#cb56-739" aria-hidden="true" tabindex="-1"></a>   <span class="in">```</span></span>
<span id="cb56-740"><a href="#cb56-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-741"><a href="#cb56-741" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**`self.control_vars`**: List of control variable symbols (empty list <span class="in">`[]`</span> for autonomous systems—see the detailed Autonomous Systems callout)</span>
<span id="cb56-742"><a href="#cb56-742" aria-hidden="true" tabindex="-1"></a>   <span class="in">```python</span></span>
<span id="cb56-743"><a href="#cb56-743" aria-hidden="true" tabindex="-1"></a>   <span class="va">self</span>.control_vars <span class="op">=</span> [Q]  <span class="co"># or [] for autonomous</span></span>
<span id="cb56-744"><a href="#cb56-744" aria-hidden="true" tabindex="-1"></a>   <span class="in">```</span></span>
<span id="cb56-745"><a href="#cb56-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-746"><a href="#cb56-746" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**`self.parameters`**: Dictionary mapping symbolic parameters to numerical values</span>
<span id="cb56-747"><a href="#cb56-747" aria-hidden="true" tabindex="-1"></a>   <span class="in">```python</span></span>
<span id="cb56-748"><a href="#cb56-748" aria-hidden="true" tabindex="-1"></a>   <span class="va">self</span>.parameters <span class="op">=</span> {k1: <span class="fl">0.5</span>, k2: <span class="fl">0.3</span>, ...}</span>
<span id="cb56-749"><a href="#cb56-749" aria-hidden="true" tabindex="-1"></a>   <span class="in">```</span></span>
<span id="cb56-750"><a href="#cb56-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-751"><a href="#cb56-751" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**`self._f_sym`**: Symbolic expression for system dynamics (drift for SDEs). For pure diffusion systems with zero drift, see the detailed Pure Diffusion Systems callout.</span>
<span id="cb56-752"><a href="#cb56-752" aria-hidden="true" tabindex="-1"></a>   <span class="in">```python</span></span>
<span id="cb56-753"><a href="#cb56-753" aria-hidden="true" tabindex="-1"></a>   <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([dC_A_dt, dC_B_dt, dT_dt])</span>
<span id="cb56-754"><a href="#cb56-754" aria-hidden="true" tabindex="-1"></a>   <span class="co"># For pure diffusion: self._f_sym = sp.zeros(n_states, 1)</span></span>
<span id="cb56-755"><a href="#cb56-755" aria-hidden="true" tabindex="-1"></a>   <span class="in">```</span></span>
<span id="cb56-756"><a href="#cb56-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-757"><a href="#cb56-757" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**`self.diffusion_expr`** (stochastic systems only): Diffusion matrix for SDE noise structure</span>
<span id="cb56-758"><a href="#cb56-758" aria-hidden="true" tabindex="-1"></a>   <span class="in">```python</span></span>
<span id="cb56-759"><a href="#cb56-759" aria-hidden="true" tabindex="-1"></a>   <span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([[sigma_A, <span class="dv">0</span>, <span class="dv">0</span>], ...])</span>
<span id="cb56-760"><a href="#cb56-760" aria-hidden="true" tabindex="-1"></a>   <span class="in">```</span></span>
<span id="cb56-761"><a href="#cb56-761" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-762"><a href="#cb56-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-763"><a href="#cb56-763" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb56-764"><a href="#cb56-764" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optional Elements with Sensible Defaults</span></span>
<span id="cb56-765"><a href="#cb56-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-766"><a href="#cb56-766" aria-hidden="true" tabindex="-1"></a>These fields have **automatic defaults** if not specified:</span>
<span id="cb56-767"><a href="#cb56-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-768"><a href="#cb56-768" aria-hidden="true" tabindex="-1"></a><span class="fu">### `self.output_vars` (default: `[]`)</span></span>
<span id="cb56-769"><a href="#cb56-769" aria-hidden="true" tabindex="-1"></a>List of computed output symbols (not states). Leave empty if you only observe states.</span>
<span id="cb56-770"><a href="#cb56-770" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-771"><a href="#cb56-771" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.output_vars <span class="op">=</span> []  <span class="co"># Default - no computed outputs</span></span>
<span id="cb56-772"><a href="#cb56-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-773"><a href="#cb56-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-774"><a href="#cb56-774" aria-hidden="true" tabindex="-1"></a><span class="fu">### `self._h_sym` (default: full state vector)</span></span>
<span id="cb56-775"><a href="#cb56-775" aria-hidden="true" tabindex="-1"></a>Output map $y = h(x)$. If not specified, defaults to observing all states.</span>
<span id="cb56-776"><a href="#cb56-776" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-777"><a href="#cb56-777" aria-hidden="true" tabindex="-1"></a><span class="co"># Explicitly set (same as default for our reactor):</span></span>
<span id="cb56-778"><a href="#cb56-778" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._h_sym <span class="op">=</span> sp.Matrix([C_A, C_B, T])</span>
<span id="cb56-779"><a href="#cb56-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-780"><a href="#cb56-780" aria-hidden="true" tabindex="-1"></a><span class="co"># If omitted, framework uses: self._h_sym = sp.Matrix(self.state_vars)</span></span>
<span id="cb56-781"><a href="#cb56-781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-782"><a href="#cb56-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-783"><a href="#cb56-783" aria-hidden="true" tabindex="-1"></a><span class="fu">### `self.order` (default: `1`)</span></span>
<span id="cb56-784"><a href="#cb56-784" aria-hidden="true" tabindex="-1"></a>System order defines how you represent system dynamics. Nearly all systems use <span class="in">`order=1`</span> (first-order state-space form). See the detailed explanation below for when higher-order forms are useful.</span>
<span id="cb56-785"><a href="#cb56-785" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-786"><a href="#cb56-786" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.order <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Default - first-order state-space form</span></span>
<span id="cb56-787"><a href="#cb56-787" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-788"><a href="#cb56-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-789"><a href="#cb56-789" aria-hidden="true" tabindex="-1"></a><span class="fu">### `self.sde_type` (default: `"ito"`)</span></span>
<span id="cb56-790"><a href="#cb56-790" aria-hidden="true" tabindex="-1"></a>For stochastic systems, specifies SDE interpretation.</span>
<span id="cb56-791"><a href="#cb56-791" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-792"><a href="#cb56-792" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.sde_type <span class="op">=</span> <span class="st">"ito"</span>  <span class="co"># Default</span></span>
<span id="cb56-793"><a href="#cb56-793" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative: self.sde_type = "stratonovich"</span></span>
<span id="cb56-794"><a href="#cb56-794" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-795"><a href="#cb56-795" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-796"><a href="#cb56-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-797"><a href="#cb56-797" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb56-798"><a href="#cb56-798" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optional Methods</span></span>
<span id="cb56-799"><a href="#cb56-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-800"><a href="#cb56-800" aria-hidden="true" tabindex="-1"></a><span class="fu">### `setup_equilibria()`</span></span>
<span id="cb56-801"><a href="#cb56-801" aria-hidden="true" tabindex="-1"></a>If defined, automatically called after system initialization to add equilibria. Useful when equilibria depend on system parameters.</span>
<span id="cb56-802"><a href="#cb56-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-803"><a href="#cb56-803" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-804"><a href="#cb56-804" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, T_amb_val<span class="op">=</span><span class="fl">300.0</span>, ...):</span>
<span id="cb56-805"><a href="#cb56-805" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store parameter value for use in setup_equilibria</span></span>
<span id="cb56-806"><a href="#cb56-806" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T_amb_val <span class="op">=</span> T_amb_val</span>
<span id="cb56-807"><a href="#cb56-807" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-808"><a href="#cb56-808" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-809"><a href="#cb56-809" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {T_amb: T_amb_val, ...}</span>
<span id="cb56-810"><a href="#cb56-810" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... rest of define_system ...</span></span>
<span id="cb56-811"><a href="#cb56-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-812"><a href="#cb56-812" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb56-813"><a href="#cb56-813" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add parameter-dependent equilibria using stored values</span></span>
<span id="cb56-814"><a href="#cb56-814" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> <span class="va">self</span>.T_amb_val</span>
<span id="cb56-815"><a href="#cb56-815" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_equilibrium(<span class="st">"complete"</span>, x_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>, T_amb]), ...)</span>
<span id="cb56-816"><a href="#cb56-816" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-817"><a href="#cb56-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-818"><a href="#cb56-818" aria-hidden="true" tabindex="-1"></a>If not defined, only the origin equilibrium is added by default.</span>
<span id="cb56-819"><a href="#cb56-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-820"><a href="#cb56-820" aria-hidden="true" tabindex="-1"></a><span class="fu">### Custom Methods and Fields</span></span>
<span id="cb56-821"><a href="#cb56-821" aria-hidden="true" tabindex="-1"></a>You can add any additional methods or fields that don't conflict with base class names:</span>
<span id="cb56-822"><a href="#cb56-822" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-823"><a href="#cb56-823" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, C_A0<span class="op">=</span><span class="fl">1.0</span>, T0<span class="op">=</span><span class="fl">350.0</span>, volume<span class="op">=</span><span class="fl">10.0</span>, ...):</span>
<span id="cb56-824"><a href="#cb56-824" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... standard setup ...</span></span>
<span id="cb56-825"><a href="#cb56-825" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-826"><a href="#cb56-826" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store values needed in custom methods</span></span>
<span id="cb56-827"><a href="#cb56-827" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.C_A0 <span class="op">=</span> C_A0  <span class="co"># Initial condition</span></span>
<span id="cb56-828"><a href="#cb56-828" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T0 <span class="op">=</span> T0      <span class="co"># Initial temperature</span></span>
<span id="cb56-829"><a href="#cb56-829" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.reactor_volume <span class="op">=</span> volume  <span class="co"># Custom application data</span></span>
<span id="cb56-830"><a href="#cb56-830" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.reaction_pathway <span class="op">=</span> <span class="st">"A-&gt;B-&gt;C"</span>  <span class="co"># Documentation</span></span>
<span id="cb56-831"><a href="#cb56-831" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-832"><a href="#cb56-832" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_conversion_rate(<span class="va">self</span>, C_A_current):</span>
<span id="cb56-833"><a href="#cb56-833" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate conversion from initial concentration."""</span></span>
<span id="cb56-834"><a href="#cb56-834" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="va">self</span>.C_A0 <span class="op">-</span> C_A_current) <span class="op">/</span> <span class="va">self</span>.C_A0</span>
<span id="cb56-835"><a href="#cb56-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-836"><a href="#cb56-836" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_reactor_capacity(<span class="va">self</span>):</span>
<span id="cb56-837"><a href="#cb56-837" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate moles of A that can be processed."""</span></span>
<span id="cb56-838"><a href="#cb56-838" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.C_A0 <span class="op">*</span> <span class="va">self</span>.reactor_volume</span>
<span id="cb56-839"><a href="#cb56-839" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-840"><a href="#cb56-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-841"><a href="#cb56-841" aria-hidden="true" tabindex="-1"></a>**What NOT to store:**</span>
<span id="cb56-842"><a href="#cb56-842" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-843"><a href="#cb56-843" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't store state/control symbols as attributes if there are no plans to change parameters post-initialization</span></span>
<span id="cb56-844"><a href="#cb56-844" aria-hidden="true" tabindex="-1"></a><span class="co"># otherwise, can be used to retrieve and re-define paramters in parameter dictionary</span></span>
<span id="cb56-845"><a href="#cb56-845" aria-hidden="true" tabindex="-1"></a><span class="co"># self.C_A_sym = sp.symbols('C_A')  # Redundant!</span></span>
<span id="cb56-846"><a href="#cb56-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-847"><a href="#cb56-847" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't store temporary calculations</span></span>
<span id="cb56-848"><a href="#cb56-848" aria-hidden="true" tabindex="-1"></a><span class="co"># self.r1 = k1 * C_A * sp.exp(-E1/T)  # Use local variable</span></span>
<span id="cb56-849"><a href="#cb56-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-850"><a href="#cb56-850" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't store parameter values not used elsewhere</span></span>
<span id="cb56-851"><a href="#cb56-851" aria-hidden="true" tabindex="-1"></a><span class="co"># If k1 is only in _f_sym, just put it in self.parameters</span></span>
<span id="cb56-852"><a href="#cb56-852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-853"><a href="#cb56-853" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-854"><a href="#cb56-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-855"><a href="#cb56-855" aria-hidden="true" tabindex="-1"></a>For our batch reactor, we **explicitly set** most optional fields for documentation purposes, but only <span class="in">`self.order`</span> and <span class="in">`self.sde_type`</span> are redundant (they match defaults).</span>
<span id="cb56-856"><a href="#cb56-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-857"><a href="#cb56-857" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding System Order in Detail</span></span>
<span id="cb56-858"><a href="#cb56-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-859"><a href="#cb56-859" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb56-860"><a href="#cb56-860" aria-hidden="true" tabindex="-1"></a><span class="fu">## System Order: First-Order vs Higher-Order Forms</span></span>
<span id="cb56-861"><a href="#cb56-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-862"><a href="#cb56-862" aria-hidden="true" tabindex="-1"></a>The <span class="in">`self.order`</span> field specifies how you represent the system dynamics. There are two mathematically equivalent ways to define systems:</span>
<span id="cb56-863"><a href="#cb56-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-864"><a href="#cb56-864" aria-hidden="true" tabindex="-1"></a><span class="fu">### First-Order State-Space Form (order=1, **default**)</span></span>
<span id="cb56-865"><a href="#cb56-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-866"><a href="#cb56-866" aria-hidden="true" tabindex="-1"></a>The system is written in first-order form where <span class="in">`self._f_sym`</span> returns **all** time derivatives.</span>
<span id="cb56-867"><a href="#cb56-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-868"><a href="#cb56-868" aria-hidden="true" tabindex="-1"></a>**Example: Second-order pendulum** with states $x = <span class="co">[</span><span class="ot">\theta, \dot{\theta}</span><span class="co">]</span>$</span>
<span id="cb56-869"><a href="#cb56-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-870"><a href="#cb56-870" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-871"><a href="#cb56-871" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [theta, theta_dot]  <span class="co"># Both position and velocity</span></span>
<span id="cb56-872"><a href="#cb56-872" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([</span>
<span id="cb56-873"><a href="#cb56-873" aria-hidden="true" tabindex="-1"></a>    theta_dot,                          <span class="co"># d(theta)/dt</span></span>
<span id="cb56-874"><a href="#cb56-874" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span>(g<span class="op">/</span>L)<span class="op">*</span>sp.sin(theta) <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>theta_dot <span class="op">+</span> u<span class="op">/</span>m  <span class="co"># d(theta_dot)/dt</span></span>
<span id="cb56-875"><a href="#cb56-875" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb56-876"><a href="#cb56-876" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.order <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Returns ALL derivatives [d(theta)/dt, d(theta_dot)/dt]</span></span>
<span id="cb56-877"><a href="#cb56-877" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-878"><a href="#cb56-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-879"><a href="#cb56-879" aria-hidden="true" tabindex="-1"></a>This is the **standard state-space form** used in control theory. For an $n$-th order physical system with generalized coordinate $q$, the state is:</span>
<span id="cb56-880"><a href="#cb56-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-881"><a href="#cb56-881" aria-hidden="true" tabindex="-1"></a>$$x = <span class="co">[</span><span class="ot">q, \dot{q}, \ddot{q}, \ldots, q^{(n-1)}</span><span class="co">]</span>$$</span>
<span id="cb56-882"><a href="#cb56-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-883"><a href="#cb56-883" aria-hidden="true" tabindex="-1"></a>and <span class="in">`self._f_sym`</span> returns the full derivative vector:</span>
<span id="cb56-884"><a href="#cb56-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-885"><a href="#cb56-885" aria-hidden="true" tabindex="-1"></a>$$\frac{dx}{dt} = <span class="co">[</span><span class="ot">\dot{q}, \ddot{q}, \ldots, q^{(n)}</span><span class="co">]</span>$$</span>
<span id="cb56-886"><a href="#cb56-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-887"><a href="#cb56-887" aria-hidden="true" tabindex="-1"></a><span class="fu">### Higher-Order Form (order=n)</span></span>
<span id="cb56-888"><a href="#cb56-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-889"><a href="#cb56-889" aria-hidden="true" tabindex="-1"></a>The system is written in higher-order form where <span class="in">`self._f_sym`</span> returns **only the highest** derivative.</span>
<span id="cb56-890"><a href="#cb56-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-891"><a href="#cb56-891" aria-hidden="true" tabindex="-1"></a>**Example: Same pendulum** with <span class="in">`order=2`</span></span>
<span id="cb56-892"><a href="#cb56-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-893"><a href="#cb56-893" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-894"><a href="#cb56-894" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.state_vars <span class="op">=</span> [theta, theta_dot]  <span class="co"># Still both variables</span></span>
<span id="cb56-895"><a href="#cb56-895" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([</span>
<span id="cb56-896"><a href="#cb56-896" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span>(g<span class="op">/</span>L)<span class="op">*</span>sp.sin(theta) <span class="op">-</span> (b<span class="op">/</span>m)<span class="op">*</span>theta_dot <span class="op">+</span> u<span class="op">/</span>m  <span class="co"># ONLY d²(theta)/dt²</span></span>
<span id="cb56-897"><a href="#cb56-897" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb56-898"><a href="#cb56-898" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.order <span class="op">=</span> <span class="dv">2</span>  <span class="co"># Returns ONLY highest derivative d²(theta)/dt²</span></span>
<span id="cb56-899"><a href="#cb56-899" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-900"><a href="#cb56-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-901"><a href="#cb56-901" aria-hidden="true" tabindex="-1"></a>The state vector is the same $x = <span class="co">[</span><span class="ot">\theta, \dot{\theta}</span><span class="co">]</span>$, but <span class="in">`self._f_sym`</span> only returns $\ddot{\theta}$. The framework **automatically constructs** the full first-order representation during linearization by adding the kinematic relationships:</span>
<span id="cb56-902"><a href="#cb56-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-903"><a href="#cb56-903" aria-hidden="true" tabindex="-1"></a>$$\frac{d\theta}{dt} = \dot{\theta}, \quad \frac{d\dot{\theta}}{dt} = \ddot{\theta}$$</span>
<span id="cb56-904"><a href="#cb56-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-905"><a href="#cb56-905" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use Each Form</span></span>
<span id="cb56-906"><a href="#cb56-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-907"><a href="#cb56-907" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**First-order (order=1)**: </span>
<span id="cb56-908"><a href="#cb56-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-909"><a href="#cb56-909" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Use this for most systems** - it's explicit and standard</span>
<span id="cb56-910"><a href="#cb56-910" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Required when dynamics aren't naturally hierarchical</span>
<span id="cb56-911"><a href="#cb56-911" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Example: Our batch reactor has independent first derivatives for $C_A$, $C_B$, and $T$</span>
<span id="cb56-912"><a href="#cb56-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-913"><a href="#cb56-913" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Higher-order (order=n)**:</span>
<span id="cb56-914"><a href="#cb56-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-915"><a href="#cb56-915" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Natural for mechanical systems (position → velocity → acceleration)</span>
<span id="cb56-916"><a href="#cb56-916" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>More compact when you have $\ddot{q} = f(q, \dot{q}, u)$ form</span>
<span id="cb56-917"><a href="#cb56-917" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Example: Robotics, where you directly compute joint accelerations</span>
<span id="cb56-918"><a href="#cb56-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-919"><a href="#cb56-919" aria-hidden="true" tabindex="-1"></a><span class="fu">### Requirements</span></span>
<span id="cb56-920"><a href="#cb56-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-921"><a href="#cb56-921" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For <span class="in">`order=n &gt; 1`</span>: The number of states must be divisible by <span class="in">`n`</span> (i.e., <span class="in">`nx % n == 0`</span>)</span>
<span id="cb56-922"><a href="#cb56-922" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>State variables should be ordered as $<span class="co">[</span><span class="ot">q_1, \ldots, q_m, \dot{q}_1, \ldots, \dot{q}_m, \ldots</span><span class="co">]</span>$ for proper automatic construction</span>
<span id="cb56-923"><a href="#cb56-923" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The framework handles all conversions transparently during linearization</span>
<span id="cb56-924"><a href="#cb56-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-925"><a href="#cb56-925" aria-hidden="true" tabindex="-1"></a><span class="fu">### This Tutorial</span></span>
<span id="cb56-926"><a href="#cb56-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-927"><a href="#cb56-927" aria-hidden="true" tabindex="-1"></a>Our batch reactor uses **order=1** (default) because the three state variables $(C_A, C_B, T)$ have independent first-order dynamics—there's no natural hierarchy to exploit.</span>
<span id="cb56-928"><a href="#cb56-928" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-929"><a href="#cb56-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-930"><a href="#cb56-930" aria-hidden="true" tabindex="-1"></a><span class="fu">## Equilibrium Setup Example</span></span>
<span id="cb56-931"><a href="#cb56-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-932"><a href="#cb56-932" aria-hidden="true" tabindex="-1"></a>Our reactor's <span class="in">`setup_equilibria()`</span> method demonstrates how to define parameter-dependent equilibria: </span>
<span id="cb56-933"><a href="#cb56-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-934"><a href="#cb56-934" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-935"><a href="#cb56-935" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb56-936"><a href="#cb56-936" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use stored parameter values directly</span></span>
<span id="cb56-937"><a href="#cb56-937" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (Don't try to look up via sp.symbols() - that creates NEW symbol objects!)</span></span>
<span id="cb56-938"><a href="#cb56-938" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> <span class="va">self</span>.T_amb_val</span>
<span id="cb56-939"><a href="#cb56-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-940"><a href="#cb56-940" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Complete conversion equilibrium (deterministic part)</span></span>
<span id="cb56-941"><a href="#cb56-941" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_equilibrium(</span>
<span id="cb56-942"><a href="#cb56-942" aria-hidden="true" tabindex="-1"></a>        <span class="st">"complete"</span>,</span>
<span id="cb56-943"><a href="#cb56-943" aria-hidden="true" tabindex="-1"></a>        x_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>, T_amb]),</span>
<span id="cb56-944"><a href="#cb56-944" aria-hidden="true" tabindex="-1"></a>        u_eq<span class="op">=</span>np.array([<span class="fl">0.0</span>]),</span>
<span id="cb56-945"><a href="#cb56-945" aria-hidden="true" tabindex="-1"></a>        verify<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb56-946"><a href="#cb56-946" aria-hidden="true" tabindex="-1"></a>        stability<span class="op">=</span><span class="st">"stable"</span>,</span>
<span id="cb56-947"><a href="#cb56-947" aria-hidden="true" tabindex="-1"></a>        notes<span class="op">=</span><span class="st">"Equilibrium of deterministic part (drift). Stochastic trajectories "</span></span>
<span id="cb56-948"><a href="#cb56-948" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fluctuate around this point with variance growing over time."</span>,</span>
<span id="cb56-949"><a href="#cb56-949" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-950"><a href="#cb56-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-951"><a href="#cb56-951" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initial condition (if provided)</span></span>
<span id="cb56-952"><a href="#cb56-952" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.C_A0 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="va">self</span>.T0 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb56-953"><a href="#cb56-953" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="va">self</span>.alpha_val</span>
<span id="cb56-954"><a href="#cb56-954" aria-hidden="true" tabindex="-1"></a>        Q_init <span class="op">=</span> alpha <span class="op">*</span> (<span class="va">self</span>.T0 <span class="op">-</span> T_amb)</span>
<span id="cb56-955"><a href="#cb56-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-956"><a href="#cb56-956" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.add_equilibrium(</span>
<span id="cb56-957"><a href="#cb56-957" aria-hidden="true" tabindex="-1"></a>            <span class="st">"initial"</span>,</span>
<span id="cb56-958"><a href="#cb56-958" aria-hidden="true" tabindex="-1"></a>            x_eq<span class="op">=</span>np.array([<span class="va">self</span>.C_A0, <span class="fl">0.0</span>, <span class="va">self</span>.T0]),</span>
<span id="cb56-959"><a href="#cb56-959" aria-hidden="true" tabindex="-1"></a>            u_eq<span class="op">=</span>np.array([Q_init]),</span>
<span id="cb56-960"><a href="#cb56-960" aria-hidden="true" tabindex="-1"></a>            verify<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb56-961"><a href="#cb56-961" aria-hidden="true" tabindex="-1"></a>            stability<span class="op">=</span><span class="st">"unstable"</span>,</span>
<span id="cb56-962"><a href="#cb56-962" aria-hidden="true" tabindex="-1"></a>            notes<span class="op">=</span><span class="st">"Initial state setpoint (deterministic part). Stochastic trajectories "</span></span>
<span id="cb56-963"><a href="#cb56-963" aria-hidden="true" tabindex="-1"></a>            <span class="st">"will fluctuate with std ~ [σ_A·√t, σ_B·√t, σ_T·√t]."</span>,</span>
<span id="cb56-964"><a href="#cb56-964" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-965"><a href="#cb56-965" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.set_default_equilibrium(<span class="st">"initial"</span>)</span>
<span id="cb56-966"><a href="#cb56-966" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb56-967"><a href="#cb56-967" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.set_default_equilibrium(<span class="st">"complete"</span>)</span>
<span id="cb56-968"><a href="#cb56-968" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-969"><a href="#cb56-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-970"><a href="#cb56-970" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb56-971"><a href="#cb56-971" aria-hidden="true" tabindex="-1"></a><span class="fu">## Accessing Parameters in `setup_equilibria()`</span></span>
<span id="cb56-972"><a href="#cb56-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-973"><a href="#cb56-973" aria-hidden="true" tabindex="-1"></a>**Common mistake:** Trying to access parameters via <span class="in">`self.parameters[sp.symbols("param_name")]`</span></span>
<span id="cb56-974"><a href="#cb56-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-975"><a href="#cb56-975" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-976"><a href="#cb56-976" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Creates a NEW symbol, won't match dictionary key</span></span>
<span id="cb56-977"><a href="#cb56-977" aria-hidden="true" tabindex="-1"></a>T_amb <span class="op">=</span> <span class="va">self</span>.parameters[sp.symbols(<span class="st">"T_amb"</span>)]  <span class="co"># KeyError!</span></span>
<span id="cb56-978"><a href="#cb56-978" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-979"><a href="#cb56-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-980"><a href="#cb56-980" aria-hidden="true" tabindex="-1"></a>**Why this fails:** Each call to <span class="in">`sp.symbols()`</span> creates a new Python object with unique identity. The dictionary keys in <span class="in">`self.parameters`</span> are the *original* symbol objects from <span class="in">`define_system()`</span>, not new ones.</span>
<span id="cb56-981"><a href="#cb56-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-982"><a href="#cb56-982" aria-hidden="true" tabindex="-1"></a>**Solution 1: Store parameter values as attributes** (Recommended for beginners):</span>
<span id="cb56-983"><a href="#cb56-983" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-984"><a href="#cb56-984" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, T_amb_val<span class="op">=</span><span class="fl">300.0</span>, ...):</span>
<span id="cb56-985"><a href="#cb56-985" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store the numerical value</span></span>
<span id="cb56-986"><a href="#cb56-986" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T_amb_val <span class="op">=</span> T_amb_val</span>
<span id="cb56-987"><a href="#cb56-987" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-988"><a href="#cb56-988" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create symbol and use in parameters dict</span></span>
<span id="cb56-989"><a href="#cb56-989" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-990"><a href="#cb56-990" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {T_amb: T_amb_val, ...}</span>
<span id="cb56-991"><a href="#cb56-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-992"><a href="#cb56-992" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb56-993"><a href="#cb56-993" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the stored value directly</span></span>
<span id="cb56-994"><a href="#cb56-994" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> <span class="va">self</span>.T_amb_val  <span class="co"># Works!</span></span>
<span id="cb56-995"><a href="#cb56-995" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-996"><a href="#cb56-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-997"><a href="#cb56-997" aria-hidden="true" tabindex="-1"></a>**Solution 2: Store symbol references** (Recommended for production):</span>
<span id="cb56-998"><a href="#cb56-998" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-999"><a href="#cb56-999" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, T_amb_val<span class="op">=</span><span class="fl">300.0</span>, ...):</span>
<span id="cb56-1000"><a href="#cb56-1000" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create symbol and store reference</span></span>
<span id="cb56-1001"><a href="#cb56-1001" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.T_amb_sym <span class="op">=</span> sp.symbols(<span class="st">'T_amb'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-1002"><a href="#cb56-1002" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {<span class="va">self</span>.T_amb_sym: T_amb_val, ...}</span>
<span id="cb56-1003"><a href="#cb56-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1004"><a href="#cb56-1004" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb56-1005"><a href="#cb56-1005" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the stored symbol to look up value</span></span>
<span id="cb56-1006"><a href="#cb56-1006" aria-hidden="true" tabindex="-1"></a>    T_amb <span class="op">=</span> <span class="va">self</span>.parameters[<span class="va">self</span>.T_amb_sym]  <span class="co"># Works!</span></span>
<span id="cb56-1007"><a href="#cb56-1007" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1008"><a href="#cb56-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1009"><a href="#cb56-1009" aria-hidden="true" tabindex="-1"></a>Our tutorial uses Solution 1 for simplicity and clarity.</span>
<span id="cb56-1010"><a href="#cb56-1010" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-1011"><a href="#cb56-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1012"><a href="#cb56-1012" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulation and Visualization</span></span>
<span id="cb56-1013"><a href="#cb56-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1014"><a href="#cb56-1014" aria-hidden="true" tabindex="-1"></a>Now that we've defined our stochastic batch reactor, let's see it in action. This section demonstrates the complete workflow: inspecting the system, running simulations, and visualizing results.</span>
<span id="cb56-1015"><a href="#cb56-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1016"><a href="#cb56-1016" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb56-1017"><a href="#cb56-1017" aria-hidden="true" tabindex="-1"></a><span class="fu">## Integration Methods: `integrate()` vs `simulate()`</span></span>
<span id="cb56-1018"><a href="#cb56-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1019"><a href="#cb56-1019" aria-hidden="true" tabindex="-1"></a>ControlDESymulation provides two methods for time evolution:</span>
<span id="cb56-1020"><a href="#cb56-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1021"><a href="#cb56-1021" aria-hidden="true" tabindex="-1"></a><span class="fu">### `integrate()` - Low-Level Interface</span></span>
<span id="cb56-1022"><a href="#cb56-1022" aria-hidden="true" tabindex="-1"></a>**For stochastic systems, always use this method.**</span>
<span id="cb56-1023"><a href="#cb56-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1024"><a href="#cb56-1024" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1025"><a href="#cb56-1025" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb56-1026"><a href="#cb56-1026" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0,</span>
<span id="cb56-1027"><a href="#cb56-1027" aria-hidden="true" tabindex="-1"></a>    u<span class="op">=</span>controller,</span>
<span id="cb56-1028"><a href="#cb56-1028" aria-hidden="true" tabindex="-1"></a>    t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb56-1029"><a href="#cb56-1029" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'euler_maruyama'</span>,  <span class="co"># Stochastic integrator</span></span>
<span id="cb56-1030"><a href="#cb56-1030" aria-hidden="true" tabindex="-1"></a>    dt<span class="op">=</span><span class="fl">0.01</span>,                  <span class="co"># Required for fixed-step methods</span></span>
<span id="cb56-1031"><a href="#cb56-1031" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span>,                  <span class="co"># Reproducibility</span></span>
<span id="cb56-1032"><a href="#cb56-1032" aria-hidden="true" tabindex="-1"></a>    n_paths<span class="op">=</span><span class="dv">100</span>               <span class="co"># Monte Carlo ensemble</span></span>
<span id="cb56-1033"><a href="#cb56-1033" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-1034"><a href="#cb56-1034" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1035"><a href="#cb56-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1036"><a href="#cb56-1036" aria-hidden="true" tabindex="-1"></a>**Stochastic-specific features:**</span>
<span id="cb56-1037"><a href="#cb56-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1038"><a href="#cb56-1038" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`seed`</span>: Random number generator seed for reproducible noise</span>
<span id="cb56-1039"><a href="#cb56-1039" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`n_paths`</span>: Built-in Monte Carlo simulation (returns shape <span class="in">`(n_paths, T, nx)`</span>)</span>
<span id="cb56-1040"><a href="#cb56-1040" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stochastic methods: <span class="in">`'euler_maruyama'`</span>, <span class="in">`'milstein'`</span>, <span class="in">`'heun'`</span>, etc.</span>
<span id="cb56-1041"><a href="#cb56-1041" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`dt`</span>: Time step (required for most SDE methods)</span>
<span id="cb56-1042"><a href="#cb56-1042" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`t_eval`</span>: Optional array of specific output times</span>
<span id="cb56-1043"><a href="#cb56-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1044"><a href="#cb56-1044" aria-hidden="true" tabindex="-1"></a>**Fixed-Step vs Adaptive Methods:**</span>
<span id="cb56-1045"><a href="#cb56-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1046"><a href="#cb56-1046" aria-hidden="true" tabindex="-1"></a>Most SDE integrators are **fixed-step** (Euler-Maruyama, Milstein, Heun, etc.):</span>
<span id="cb56-1047"><a href="#cb56-1047" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1048"><a href="#cb56-1048" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb56-1049"><a href="#cb56-1049" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb56-1050"><a href="#cb56-1050" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'euler_maruyama'</span>,</span>
<span id="cb56-1051"><a href="#cb56-1051" aria-hidden="true" tabindex="-1"></a>    dt<span class="op">=</span><span class="fl">0.01</span>  <span class="co"># Required - sets uniform time grid</span></span>
<span id="cb56-1052"><a href="#cb56-1052" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-1053"><a href="#cb56-1053" aria-hidden="true" tabindex="-1"></a><span class="co"># result['t'] has uniform spacing: [0.00, 0.01, 0.02, ..., 10.00]</span></span>
<span id="cb56-1054"><a href="#cb56-1054" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1055"><a href="#cb56-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1056"><a href="#cb56-1056" aria-hidden="true" tabindex="-1"></a>Some advanced methods are **adaptive** (use <span class="in">`rtol`</span>/<span class="in">`atol`</span> instead of <span class="in">`dt`</span>):</span>
<span id="cb56-1057"><a href="#cb56-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1058"><a href="#cb56-1058" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb56-1059"><a href="#cb56-1059" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb56-1060"><a href="#cb56-1060" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'adaptive_sde'</span>,  <span class="co"># Hypothetical adaptive method</span></span>
<span id="cb56-1061"><a href="#cb56-1061" aria-hidden="true" tabindex="-1"></a>    rtol<span class="op">=</span><span class="fl">1e-6</span>, atol<span class="op">=</span><span class="fl">1e-8</span></span>
<span id="cb56-1062"><a href="#cb56-1062" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-1063"><a href="#cb56-1063" aria-hidden="true" tabindex="-1"></a><span class="co"># result['t'] may have non-uniform spacing</span></span>
<span id="cb56-1064"><a href="#cb56-1064" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1065"><a href="#cb56-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1066"><a href="#cb56-1066" aria-hidden="true" tabindex="-1"></a>**Visualization tip:** For uniform time grids (most cases), plotting is straightforward. For adaptive grids, use <span class="in">`t_eval`</span> to force specific output times:</span>
<span id="cb56-1067"><a href="#cb56-1067" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1068"><a href="#cb56-1068" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb56-1069"><a href="#cb56-1069" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0, t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb56-1070"><a href="#cb56-1070" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'adaptive_sde'</span>,</span>
<span id="cb56-1071"><a href="#cb56-1071" aria-hidden="true" tabindex="-1"></a>    t_eval<span class="op">=</span>np.linspace(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">1000</span>),  <span class="co"># Force uniform grid</span></span>
<span id="cb56-1072"><a href="#cb56-1072" aria-hidden="true" tabindex="-1"></a>    rtol<span class="op">=</span><span class="fl">1e-6</span></span>
<span id="cb56-1073"><a href="#cb56-1073" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-1074"><a href="#cb56-1074" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1075"><a href="#cb56-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1076"><a href="#cb56-1076" aria-hidden="true" tabindex="-1"></a>**Returns:** <span class="in">`SDEIntegrationResult`</span> with fields:</span>
<span id="cb56-1077"><a href="#cb56-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1078"><a href="#cb56-1078" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`t`</span>: Time points <span class="in">`(T,)`</span> - uniform for fixed-step, may vary for adaptive</span>
<span id="cb56-1079"><a href="#cb56-1079" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`x`</span>: States <span class="in">`(T, nx)`</span> or <span class="in">`(n_paths, T, nx)`</span> for Monte Carlo</span>
<span id="cb56-1080"><a href="#cb56-1080" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`success`</span>, <span class="in">`nfev`</span>, <span class="in">`diffusion_evals`</span>: Solver diagnostics</span>
<span id="cb56-1081"><a href="#cb56-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1082"><a href="#cb56-1082" aria-hidden="true" tabindex="-1"></a><span class="fu">### `simulate()` - High-Level Interface</span></span>
<span id="cb56-1083"><a href="#cb56-1083" aria-hidden="true" tabindex="-1"></a>**For deterministic systems only** (not recommended for SDEs).</span>
<span id="cb56-1084"><a href="#cb56-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1085"><a href="#cb56-1085" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1086"><a href="#cb56-1086" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.simulate(</span>
<span id="cb56-1087"><a href="#cb56-1087" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0,</span>
<span id="cb56-1088"><a href="#cb56-1088" aria-hidden="true" tabindex="-1"></a>    controller<span class="op">=</span><span class="kw">lambda</span> x, t: <span class="op">-</span>K <span class="op">@</span> x,</span>
<span id="cb56-1089"><a href="#cb56-1089" aria-hidden="true" tabindex="-1"></a>    t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb56-1090"><a href="#cb56-1090" aria-hidden="true" tabindex="-1"></a>    dt<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb56-1091"><a href="#cb56-1091" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-1092"><a href="#cb56-1092" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1093"><a href="#cb56-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1094"><a href="#cb56-1094" aria-hidden="true" tabindex="-1"></a>**Key differences:**</span>
<span id="cb56-1095"><a href="#cb56-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1096"><a href="#cb56-1096" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Always returns regular time grid (uniform spacing <span class="in">`dt`</span>)</span>
<span id="cb56-1097"><a href="#cb56-1097" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cleaner API for feedback controllers</span>
<span id="cb56-1098"><a href="#cb56-1098" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No <span class="in">`seed`</span> or <span class="in">`n_paths`</span> support</span>
<span id="cb56-1099"><a href="#cb56-1099" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Uses deterministic integrators (RK45, RK4, Euler)</span>
<span id="cb56-1100"><a href="#cb56-1100" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Returns <span class="in">`SimulationResult`</span> in time-major format <span class="in">`(T, nx)`</span></span>
<span id="cb56-1101"><a href="#cb56-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1102"><a href="#cb56-1102" aria-hidden="true" tabindex="-1"></a>**When to use each:**</span>
<span id="cb56-1103"><a href="#cb56-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1104"><a href="#cb56-1104" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Stochastic systems (SDEs)** → <span class="in">`integrate()`</span> with stochastic methods</span>
<span id="cb56-1105"><a href="#cb56-1105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Deterministic systems (ODEs)** → Either method; <span class="in">`simulate()`</span> is simpler</span>
<span id="cb56-1106"><a href="#cb56-1106" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Monte Carlo simulations** → <span class="in">`integrate()`</span> with <span class="in">`n_paths &gt; 1`</span></span>
<span id="cb56-1107"><a href="#cb56-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1108"><a href="#cb56-1108" aria-hidden="true" tabindex="-1"></a>For our stochastic batch reactor, we'll use <span class="in">`integrate()`</span> exclusively.</span>
<span id="cb56-1109"><a href="#cb56-1109" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-1110"><a href="#cb56-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1111"><a href="#cb56-1111" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inspecting the System</span></span>
<span id="cb56-1112"><a href="#cb56-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1113"><a href="#cb56-1113" aria-hidden="true" tabindex="-1"></a>Before running simulations, let's examine what we've created:</span>
<span id="cb56-1114"><a href="#cb56-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1117"><a href="#cb56-1117" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb56-1118"><a href="#cb56-1118" aria-hidden="true" tabindex="-1"></a><span class="co"># Display symbolic equations</span></span>
<span id="cb56-1119"><a href="#cb56-1119" aria-hidden="true" tabindex="-1"></a>reactor <span class="op">=</span> ContinuousStochasticBatchReactor(</span>
<span id="cb56-1120"><a href="#cb56-1120" aria-hidden="true" tabindex="-1"></a>    C_A0<span class="op">=</span><span class="fl">1.0</span>,    <span class="co"># Initial concentration</span></span>
<span id="cb56-1121"><a href="#cb56-1121" aria-hidden="true" tabindex="-1"></a>    T0<span class="op">=</span><span class="fl">350.0</span>,    <span class="co"># Initial temperature</span></span>
<span id="cb56-1122"><a href="#cb56-1122" aria-hidden="true" tabindex="-1"></a>    sigma_T<span class="op">=</span><span class="fl">2.0</span>  <span class="co"># Temperature noise intensity</span></span>
<span id="cb56-1123"><a href="#cb56-1123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-1124"><a href="#cb56-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1125"><a href="#cb56-1125" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the mathematical structure</span></span>
<span id="cb56-1126"><a href="#cb56-1126" aria-hidden="true" tabindex="-1"></a>reactor.print_equations(simplify<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-1127"><a href="#cb56-1127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1128"><a href="#cb56-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1129"><a href="#cb56-1129" aria-hidden="true" tabindex="-1"></a>This shows:</span>
<span id="cb56-1130"><a href="#cb56-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1131"><a href="#cb56-1131" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>State and control variables</span>
<span id="cb56-1132"><a href="#cb56-1132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>System dimensions (nx=3 states, nu=1 control)</span>
<span id="cb56-1133"><a href="#cb56-1133" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Symbolic drift dynamics with parameters substituted</span>
<span id="cb56-1134"><a href="#cb56-1134" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Output map (if defined)</span>
<span id="cb56-1135"><a href="#cb56-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1136"><a href="#cb56-1136" aria-hidden="true" tabindex="-1"></a>We can also inspect system properties programmatically:</span>
<span id="cb56-1137"><a href="#cb56-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1140"><a href="#cb56-1140" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb56-1141"><a href="#cb56-1141" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of states: </span><span class="sc">{</span>reactor<span class="sc">.</span>nx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-1142"><a href="#cb56-1142" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of controls: </span><span class="sc">{</span>reactor<span class="sc">.</span>nu<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-1143"><a href="#cb56-1143" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"State variables: </span><span class="sc">{</span>reactor<span class="sc">.</span>state_vars<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-1144"><a href="#cb56-1144" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Parameters: </span><span class="sc">{</span><span class="bu">list</span>(reactor.parameters.keys())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-1145"><a href="#cb56-1145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1146"><a href="#cb56-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1147"><a href="#cb56-1147" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb56-1148"><a href="#cb56-1148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Choosing an Integration Method</span></span>
<span id="cb56-1149"><a href="#cb56-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1150"><a href="#cb56-1150" aria-hidden="true" tabindex="-1"></a>For this tutorial, we use **Euler-Maruyama** (<span class="in">`method='euler_maruyama'`</span>), the simplest fixed-step SDE method. It's a good starting point because:</span>
<span id="cb56-1151"><a href="#cb56-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1152"><a href="#cb56-1152" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Fixed time step**: Requires <span class="in">`dt`</span> parameter, produces uniform time grid</span>
<span id="cb56-1153"><a href="#cb56-1153" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Easy visualization**: Uniform spacing makes plotting straightforward</span>
<span id="cb56-1154"><a href="#cb56-1154" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Stable for additive noise**: Our reactor has additive noise (constant diffusion)</span>
<span id="cb56-1155"><a href="#cb56-1155" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Fast**: Minimal computation per step</span>
<span id="cb56-1156"><a href="#cb56-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1157"><a href="#cb56-1157" aria-hidden="true" tabindex="-1"></a>Other common methods:</span>
<span id="cb56-1158"><a href="#cb56-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1159"><a href="#cb56-1159" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**`milstein`**: Higher accuracy for multiplicative noise, still fixed-step</span>
<span id="cb56-1160"><a href="#cb56-1160" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**`heun`**: Good balance of accuracy and stability, fixed-step</span>
<span id="cb56-1161"><a href="#cb56-1161" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Advanced methods**: May use adaptive stepping (see note below)</span>
<span id="cb56-1162"><a href="#cb56-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1163"><a href="#cb56-1163" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb56-1164"><a href="#cb56-1164" aria-hidden="true" tabindex="-1"></a><span class="fu">## Handling Adaptive SDE Methods</span></span>
<span id="cb56-1165"><a href="#cb56-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1166"><a href="#cb56-1166" aria-hidden="true" tabindex="-1"></a>Some advanced SDE solvers use adaptive time stepping for efficiency. If you use an adaptive method and need uniform output times (e.g., for certain visualizations or statistical analysis), use the <span class="in">`t_eval`</span> parameter:</span>
<span id="cb56-1167"><a href="#cb56-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1168"><a href="#cb56-1168" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1169"><a href="#cb56-1169" aria-hidden="true" tabindex="-1"></a><span class="co"># Adaptive method with non-uniform internal steps</span></span>
<span id="cb56-1170"><a href="#cb56-1170" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> system.integrate(</span>
<span id="cb56-1171"><a href="#cb56-1171" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>x0,</span>
<span id="cb56-1172"><a href="#cb56-1172" aria-hidden="true" tabindex="-1"></a>    t_span<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb56-1173"><a href="#cb56-1173" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'adaptive_sde_method'</span>,  <span class="co"># Hypothetical adaptive method</span></span>
<span id="cb56-1174"><a href="#cb56-1174" aria-hidden="true" tabindex="-1"></a>    rtol<span class="op">=</span><span class="fl">1e-6</span>, atol<span class="op">=</span><span class="fl">1e-8</span>,</span>
<span id="cb56-1175"><a href="#cb56-1175" aria-hidden="true" tabindex="-1"></a>    t_eval<span class="op">=</span>np.linspace(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">1000</span>)  <span class="co"># Force uniform output grid</span></span>
<span id="cb56-1176"><a href="#cb56-1176" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-1177"><a href="#cb56-1177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1178"><a href="#cb56-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1179"><a href="#cb56-1179" aria-hidden="true" tabindex="-1"></a>The solver will use adaptive steps internally for efficiency but interpolate to provide output at the exact times specified in <span class="in">`t_eval`</span>. This gives you:</span>
<span id="cb56-1180"><a href="#cb56-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1181"><a href="#cb56-1181" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Efficiency of adaptive stepping during integration</span>
<span id="cb56-1182"><a href="#cb56-1182" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Uniform time grid for downstream analysis and visualization</span>
<span id="cb56-1183"><a href="#cb56-1183" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Control over output density</span>
<span id="cb56-1184"><a href="#cb56-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1185"><a href="#cb56-1185" aria-hidden="true" tabindex="-1"></a>**For this tutorial:** We use fixed-step Euler-Maruyama, so <span class="in">`dt`</span> controls both internal steps and output times. No <span class="in">`t_eval`</span> needed.</span>
<span id="cb56-1186"><a href="#cb56-1186" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-1187"><a href="#cb56-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1188"><a href="#cb56-1188" aria-hidden="true" tabindex="-1"></a>For production code with multiplicative noise, consider higher-order methods. For learning and visualization, Euler-Maruyama with <span class="in">`dt=0.01`</span> to <span class="in">`dt=0.1`</span> works well.</span>
<span id="cb56-1189"><a href="#cb56-1189" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-1190"><a href="#cb56-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1191"><a href="#cb56-1191" aria-hidden="true" tabindex="-1"></a><span class="fu">### Equilibrium Points</span></span>
<span id="cb56-1192"><a href="#cb56-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1193"><a href="#cb56-1193" aria-hidden="true" tabindex="-1"></a>Our <span class="in">`setup_equilibria()`</span> method created two equilibrium points. Let's see them:</span>
<span id="cb56-1194"><a href="#cb56-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1197"><a href="#cb56-1197" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb56-1198"><a href="#cb56-1198" aria-hidden="true" tabindex="-1"></a><span class="co"># List all equilibria</span></span>
<span id="cb56-1199"><a href="#cb56-1199" aria-hidden="true" tabindex="-1"></a>equilibrium_names <span class="op">=</span> reactor.list_equilibria()</span>
<span id="cb56-1200"><a href="#cb56-1200" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Available equilibria: </span><span class="sc">{</span>equilibrium_names<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-1201"><a href="#cb56-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1202"><a href="#cb56-1202" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the "complete conversion" equilibrium</span></span>
<span id="cb56-1203"><a href="#cb56-1203" aria-hidden="true" tabindex="-1"></a>x_eq, u_eq <span class="op">=</span> reactor.get_equilibrium(<span class="st">'complete'</span>)</span>
<span id="cb56-1204"><a href="#cb56-1204" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Complete conversion equilibrium:"</span>)</span>
<span id="cb56-1205"><a href="#cb56-1205" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  C_A = </span><span class="sc">{</span>x_eq[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> mol/L"</span>)</span>
<span id="cb56-1206"><a href="#cb56-1206" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  C_B = </span><span class="sc">{</span>x_eq[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss"> mol/L"</span>)</span>
<span id="cb56-1207"><a href="#cb56-1207" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  T = </span><span class="sc">{</span>x_eq[<span class="dv">2</span>]<span class="sc">:.1f}</span><span class="ss"> K"</span>)</span>
<span id="cb56-1208"><a href="#cb56-1208" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Q = </span><span class="sc">{</span>u_eq[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> W"</span>)</span>
<span id="cb56-1209"><a href="#cb56-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1210"><a href="#cb56-1210" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify it's actually an equilibrium (drift should be zero)</span></span>
<span id="cb56-1211"><a href="#cb56-1211" aria-hidden="true" tabindex="-1"></a>drift <span class="op">=</span> reactor(x_eq, u_eq, t<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb56-1212"><a href="#cb56-1212" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Drift at equilibrium: </span><span class="sc">{</span>drift<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-1213"><a href="#cb56-1213" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Max drift magnitude: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">abs</span>(drift)<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2e}</span><span class="ss">"</span>)</span>
<span id="cb56-1214"><a href="#cb56-1214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1215"><a href="#cb56-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1216"><a href="#cb56-1216" aria-hidden="true" tabindex="-1"></a>**Key insight:** For stochastic systems, equilibria are fixed points of the **drift** only. The diffusion causes trajectories to fluctuate around these points with variance growing as $\sqrt{t}$.</span>
<span id="cb56-1217"><a href="#cb56-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1218"><a href="#cb56-1218" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary: Building Your System</span></span>
<span id="cb56-1219"><a href="#cb56-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1220"><a href="#cb56-1220" aria-hidden="true" tabindex="-1"></a>To define a symbolic system in ControlDESymulation:</span>
<span id="cb56-1221"><a href="#cb56-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1222"><a href="#cb56-1222" aria-hidden="true" tabindex="-1"></a>**Minimum viable system:**</span>
<span id="cb56-1223"><a href="#cb56-1223" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1224"><a href="#cb56-1224" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>):</span>
<span id="cb56-1225"><a href="#cb56-1225" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Define symbolic variables</span></span>
<span id="cb56-1226"><a href="#cb56-1226" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> sp.symbols(<span class="st">'x'</span>)</span>
<span id="cb56-1227"><a href="#cb56-1227" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> sp.symbols(<span class="st">'u'</span>)</span>
<span id="cb56-1228"><a href="#cb56-1228" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1229"><a href="#cb56-1229" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Set required fields</span></span>
<span id="cb56-1230"><a href="#cb56-1230" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.state_vars <span class="op">=</span> [x]</span>
<span id="cb56-1231"><a href="#cb56-1231" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_vars <span class="op">=</span> [u]  <span class="co"># or [] for autonomous</span></span>
<span id="cb56-1232"><a href="#cb56-1232" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {}     <span class="co"># or {param: value}</span></span>
<span id="cb56-1233"><a href="#cb56-1233" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([...])  <span class="co"># Your dynamics</span></span>
<span id="cb56-1234"><a href="#cb56-1234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1235"><a href="#cb56-1235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. For stochastic systems, add:</span></span>
<span id="cb56-1236"><a href="#cb56-1236" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.diffusion_expr = sp.Matrix([...])</span></span>
<span id="cb56-1237"><a href="#cb56-1237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1238"><a href="#cb56-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1239"><a href="#cb56-1239" aria-hidden="true" tabindex="-1"></a>**Autonomous system (no control inputs):**</span>
<span id="cb56-1240"><a href="#cb56-1240" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1241"><a href="#cb56-1241" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, damping<span class="op">=</span><span class="fl">0.1</span>, stiffness<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb56-1242"><a href="#cb56-1242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Define symbolic variables (no control symbols needed)</span></span>
<span id="cb56-1243"><a href="#cb56-1243" aria-hidden="true" tabindex="-1"></a>    x, v <span class="op">=</span> sp.symbols(<span class="st">'x v'</span>)</span>
<span id="cb56-1244"><a href="#cb56-1244" aria-hidden="true" tabindex="-1"></a>    b, k <span class="op">=</span> sp.symbols(<span class="st">'b k'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-1245"><a href="#cb56-1245" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1246"><a href="#cb56-1246" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Set required fields</span></span>
<span id="cb56-1247"><a href="#cb56-1247" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.state_vars <span class="op">=</span> [x, v]</span>
<span id="cb56-1248"><a href="#cb56-1248" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># Empty list for autonomous</span></span>
<span id="cb56-1249"><a href="#cb56-1249" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {b: damping, k: stiffness}</span>
<span id="cb56-1250"><a href="#cb56-1250" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1251"><a href="#cb56-1251" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Dynamics depending only on states</span></span>
<span id="cb56-1252"><a href="#cb56-1252" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([</span>
<span id="cb56-1253"><a href="#cb56-1253" aria-hidden="true" tabindex="-1"></a>        v,                  <span class="co"># dx/dt = v</span></span>
<span id="cb56-1254"><a href="#cb56-1254" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span>k<span class="op">*</span>x <span class="op">-</span> b<span class="op">*</span>v         <span class="co"># dv/dt = -kx - bv (damped oscillator)</span></span>
<span id="cb56-1255"><a href="#cb56-1255" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb56-1256"><a href="#cb56-1256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1257"><a href="#cb56-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1258"><a href="#cb56-1258" aria-hidden="true" tabindex="-1"></a>**Pure diffusion system (stochastic, zero drift):**</span>
<span id="cb56-1259"><a href="#cb56-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1260"><a href="#cb56-1260" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, sigma_x<span class="op">=</span><span class="fl">1.0</span>, sigma_y<span class="op">=</span><span class="fl">1.0</span>, sigma_z<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb56-1261"><a href="#cb56-1261" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Define symbolic variables</span></span>
<span id="cb56-1262"><a href="#cb56-1262" aria-hidden="true" tabindex="-1"></a>    x, y, z <span class="op">=</span> sp.symbols(<span class="st">'x y z'</span>, real<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-1263"><a href="#cb56-1263" aria-hidden="true" tabindex="-1"></a>    sx, sy, sz <span class="op">=</span> sp.symbols(<span class="st">'sigma_x sigma_y sigma_z'</span>, positive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb56-1264"><a href="#cb56-1264" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1265"><a href="#cb56-1265" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Set required fields</span></span>
<span id="cb56-1266"><a href="#cb56-1266" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.state_vars <span class="op">=</span> [x, y, z]</span>
<span id="cb56-1267"><a href="#cb56-1267" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_vars <span class="op">=</span> []  <span class="co"># Typically autonomous</span></span>
<span id="cb56-1268"><a href="#cb56-1268" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {sx: sigma_x, sy: sigma_y, sz: sigma_z}</span>
<span id="cb56-1269"><a href="#cb56-1269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1270"><a href="#cb56-1270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. ZERO DRIFT: Pure diffusion has no deterministic dynamics</span></span>
<span id="cb56-1271"><a href="#cb56-1271" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.zeros(<span class="dv">3</span>, <span class="dv">1</span>)  <span class="co"># Must be zero vector</span></span>
<span id="cb56-1272"><a href="#cb56-1272" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1273"><a href="#cb56-1273" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. DIFFUSION: Stochastic dynamics only</span></span>
<span id="cb56-1274"><a href="#cb56-1274" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.diffusion_expr <span class="op">=</span> sp.Matrix([</span>
<span id="cb56-1275"><a href="#cb56-1275" aria-hidden="true" tabindex="-1"></a>        [sx, <span class="dv">0</span>, <span class="dv">0</span>],     <span class="co"># Independent noise in x</span></span>
<span id="cb56-1276"><a href="#cb56-1276" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, sy, <span class="dv">0</span>],     <span class="co"># Independent noise in y</span></span>
<span id="cb56-1277"><a href="#cb56-1277" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, sz]      <span class="co"># Independent noise in z</span></span>
<span id="cb56-1278"><a href="#cb56-1278" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb56-1279"><a href="#cb56-1279" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1280"><a href="#cb56-1280" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.sde_type <span class="op">=</span> <span class="st">"ito"</span></span>
<span id="cb56-1281"><a href="#cb56-1281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1282"><a href="#cb56-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1283"><a href="#cb56-1283" aria-hidden="true" tabindex="-1"></a>**Well-documented system (recommended):**</span>
<span id="cb56-1284"><a href="#cb56-1284" aria-hidden="true" tabindex="-1"></a><span class="in">```python</span></span>
<span id="cb56-1285"><a href="#cb56-1285" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> define_system(<span class="va">self</span>, param1<span class="op">=</span><span class="fl">1.0</span>, param2<span class="op">=</span><span class="fl">2.0</span>):</span>
<span id="cb56-1286"><a href="#cb56-1286" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Define all symbolic variables (kept as LOCAL variables)</span></span>
<span id="cb56-1287"><a href="#cb56-1287" aria-hidden="true" tabindex="-1"></a>    x, y <span class="op">=</span> sp.symbols(<span class="st">'x y'</span>)        <span class="co"># State symbols - local only</span></span>
<span id="cb56-1288"><a href="#cb56-1288" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> sp.symbols(<span class="st">'u'</span>)             <span class="co"># Control symbol - local only</span></span>
<span id="cb56-1289"><a href="#cb56-1289" aria-hidden="true" tabindex="-1"></a>    p1, p2 <span class="op">=</span> sp.symbols(<span class="st">'p1 p2'</span>, positive<span class="op">=</span><span class="va">True</span>)  <span class="co"># Parameter symbols - local only</span></span>
<span id="cb56-1290"><a href="#cb56-1290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1291"><a href="#cb56-1291" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Set required fields</span></span>
<span id="cb56-1292"><a href="#cb56-1292" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.state_vars <span class="op">=</span> [x, y]        <span class="co"># Reference to local symbols</span></span>
<span id="cb56-1293"><a href="#cb56-1293" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.control_vars <span class="op">=</span> [u]         <span class="co"># Reference to local symbols</span></span>
<span id="cb56-1294"><a href="#cb56-1294" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.parameters <span class="op">=</span> {p1: param1, p2: param2}  <span class="co"># Symbol→value mapping</span></span>
<span id="cb56-1295"><a href="#cb56-1295" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._f_sym <span class="op">=</span> sp.Matrix([...])</span>
<span id="cb56-1296"><a href="#cb56-1296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1297"><a href="#cb56-1297" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Explicitly set optional fields for clarity</span></span>
<span id="cb56-1298"><a href="#cb56-1298" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.output_vars <span class="op">=</span> []           <span class="co"># No computed outputs</span></span>
<span id="cb56-1299"><a href="#cb56-1299" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._h_sym <span class="op">=</span> sp.Matrix([x, y]) <span class="co"># Observe full state</span></span>
<span id="cb56-1300"><a href="#cb56-1300" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.order <span class="op">=</span> <span class="dv">1</span>                  <span class="co"># First-order form</span></span>
<span id="cb56-1301"><a href="#cb56-1301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1302"><a href="#cb56-1302" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. For stochastic systems:</span></span>
<span id="cb56-1303"><a href="#cb56-1303" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.diffusion_expr = sp.Matrix([...])</span></span>
<span id="cb56-1304"><a href="#cb56-1304" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.sde_type = "ito"  # or "stratonovich"</span></span>
<span id="cb56-1305"><a href="#cb56-1305" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-1306"><a href="#cb56-1306" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Store parameter VALUES as attributes (if needed in setup_equilibria)</span></span>
<span id="cb56-1307"><a href="#cb56-1307" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DON'T store symbols unless parameters need to change post-initialization</span></span>
<span id="cb56-1308"><a href="#cb56-1308" aria-hidden="true" tabindex="-1"></a>    <span class="co"># symbols are already in self.state_vars, self.parameters</span></span>
<span id="cb56-1309"><a href="#cb56-1309" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.param1_val = param1  # Store VALUE for later use</span></span>
<span id="cb56-1310"><a href="#cb56-1310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># self.param2_val = param2  # Store VALUE for later use</span></span>
<span id="cb56-1311"><a href="#cb56-1311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1312"><a href="#cb56-1312" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_equilibria(<span class="va">self</span>):</span>
<span id="cb56-1313"><a href="#cb56-1313" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: Add parameter-dependent equilibria</span></span>
<span id="cb56-1314"><a href="#cb56-1314" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Access stored values: x_eq_value = self.param1_val</span></span>
<span id="cb56-1315"><a href="#cb56-1315" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.add_equilibrium(<span class="st">"my_equilibrium"</span>, x_eq<span class="op">=</span>..., u_eq<span class="op">=</span>...)</span>
<span id="cb56-1316"><a href="#cb56-1316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-1317"><a href="#cb56-1317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1318"><a href="#cb56-1318" aria-hidden="true" tabindex="-1"></a>**Which template should you use?**</span>
<span id="cb56-1319"><a href="#cb56-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1320"><a href="#cb56-1320" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Minimum viable**: Quick prototyping, testing, simple demos</span>
<span id="cb56-1321"><a href="#cb56-1321" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Autonomous system**: No control inputs (free oscillators, population models, unforced reactions)</span>
<span id="cb56-1322"><a href="#cb56-1322" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Pure diffusion**: Stochastic processes with zero drift (Brownian motion, pure noise)</span>
<span id="cb56-1323"><a href="#cb56-1323" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Well-documented**: Production code, complex systems, collaborative projects (recommended)</span>
<span id="cb56-1324"><a href="#cb56-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1325"><a href="#cb56-1325" aria-hidden="true" tabindex="-1"></a>The reactor example in this tutorial follows the well-documented approach with both drift and diffusion.</span>
<span id="cb56-1326"><a href="#cb56-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1327"><a href="#cb56-1327" aria-hidden="true" tabindex="-1"></a><span class="fu">## What You've Learned</span></span>
<span id="cb56-1328"><a href="#cb56-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1329"><a href="#cb56-1329" aria-hidden="true" tabindex="-1"></a>This tutorial covered the **anatomy of a symbolic system** through a stochastic batch reactor example:</span>
<span id="cb56-1330"><a href="#cb56-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1331"><a href="#cb56-1331" aria-hidden="true" tabindex="-1"></a><span class="fu">### System Definition</span></span>
<span id="cb56-1332"><a href="#cb56-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1333"><a href="#cb56-1333" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to subclass <span class="in">`ContinuousStochasticSystem`</span></span>
<span id="cb56-1334"><a href="#cb56-1334" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Required fields: <span class="in">`state_vars`</span>, <span class="in">`control_vars`</span>, <span class="in">`parameters`</span>, <span class="in">`_f_sym`</span>, <span class="in">`diffusion_expr`</span></span>
<span id="cb56-1335"><a href="#cb56-1335" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Optional fields: <span class="in">`output_vars`</span>, <span class="in">`_h_sym`</span>, <span class="in">`order`</span>, <span class="in">`sde_type`</span></span>
<span id="cb56-1336"><a href="#cb56-1336" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Special cases: Autonomous systems and pure diffusion systems</span>
<span id="cb56-1337"><a href="#cb56-1337" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Parameter-dependent equilibria via <span class="in">`setup_equilibria()`</span></span>
<span id="cb56-1338"><a href="#cb56-1338" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**What to store as attributes vs local variables**:</span>
<span id="cb56-1339"><a href="#cb56-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1340"><a href="#cb56-1340" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Symbols (state, control, parameters) → Keep local</span>
<span id="cb56-1341"><a href="#cb56-1341" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Parameter values (used in <span class="in">`setup_equilibria`</span>) → Store as <span class="in">`self.param_val`</span></span>
<span id="cb56-1342"><a href="#cb56-1342" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Initial conditions and custom data → Store as attributes</span>
<span id="cb56-1343"><a href="#cb56-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1344"><a href="#cb56-1344" aria-hidden="true" tabindex="-1"></a><span class="fu">### System Introspection</span></span>
<span id="cb56-1345"><a href="#cb56-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1346"><a href="#cb56-1346" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`print_equations()`</span>: Display symbolic dynamics</span>
<span id="cb56-1347"><a href="#cb56-1347" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`list_equilibria()`</span>: See all equilibrium points</span>
<span id="cb56-1348"><a href="#cb56-1348" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`get_equilibrium()`</span>: Access equilibrium states and controls</span>
<span id="cb56-1349"><a href="#cb56-1349" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Programmatic access: <span class="in">`nx`</span>, <span class="in">`nu`</span>, <span class="in">`state_vars`</span>, <span class="in">`parameters`</span></span>
<span id="cb56-1350"><a href="#cb56-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1351"><a href="#cb56-1351" aria-hidden="true" tabindex="-1"></a><span class="fu">### Critical Distinctions</span></span>
<span id="cb56-1352"><a href="#cb56-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1353"><a href="#cb56-1353" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Drift vs Diffusion**: Deterministic dynamics vs stochastic forcing</span>
<span id="cb56-1354"><a href="#cb56-1354" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Itô vs Stratonovich**: Different stochastic calculus interpretations</span>
<span id="cb56-1355"><a href="#cb56-1355" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Equilibria in SDEs**: Fixed points of drift only (stochastic fluctuations persist)</span>
<span id="cb56-1356"><a href="#cb56-1356" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**integrate() vs simulate()**: Use <span class="in">`integrate()`</span> for stochastic systems</span>
<span id="cb56-1357"><a href="#cb56-1357" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Fixed-step vs adaptive**: Most SDE methods use fixed <span class="in">`dt`</span> (uniform time grid), some advanced methods adapt step size (use <span class="in">`t_eval`</span> for uniform output)</span>
<span id="cb56-1358"><a href="#cb56-1358" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Parameter access**: Store parameter values as attributes (<span class="in">`self.param_val`</span>) for use in <span class="in">`setup_equilibria()`</span>, don't try to look up via <span class="in">`self.parameters[sp.symbols("param")]`</span> (creates new symbol, causes KeyError). Store symbol references as attributes only if parameter values need to change post-initialization.</span>
<span id="cb56-1359"><a href="#cb56-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1360"><a href="#cb56-1360" aria-hidden="true" tabindex="-1"></a><span class="fu">## Next Steps</span></span>
<span id="cb56-1361"><a href="#cb56-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1362"><a href="#cb56-1362" aria-hidden="true" tabindex="-1"></a>**[Tutorial 2: Simulation and Visualization](batch_reactor_simulation.qmd)**</span>
<span id="cb56-1363"><a href="#cb56-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-1364"><a href="#cb56-1364" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Single trajectory simulation with <span class="in">`integrate()`</span></span>
<span id="cb56-1365"><a href="#cb56-1365" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Monte Carlo ensembles with <span class="in">`n_paths`</span></span>
<span id="cb56-1366"><a href="#cb56-1366" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Time series visualization with <span class="in">`reactor.plotter`</span></span>
<span id="cb56-1367"><a href="#cb56-1367" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Phase portraits and state-space analysis</span>
<span id="cb56-1368"><a href="#cb56-1368" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Ensemble statistics and confidence bands</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/gilbenezer/ControlDESymulation/edit/main/tutorials/core_concepts_continuous/batch_reactor_system_definition.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/gilbenezer/ControlDESymulation/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>